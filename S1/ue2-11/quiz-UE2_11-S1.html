<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UE 2.11 S1 — MAXI QUIZ **FULL** (TD + CM)</title>
<style>
  :root{--bg:#0b0f1e;--card:#151a2e;--ink:#eef0ff;--muted:#aab0ff;--accent:#7f8cff;--ok:#20c997;--ko:#ff5b73;--line:rgba(255,255,255,.12)}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px 120px}
  h1{font-size:26px;margin:0 0 6px}
  .subtitle{color:var(--muted);margin:0 0 18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));border:1px solid var(--line);border-radius:14px;margin:12px 0;box-shadow:0 6px 20px rgba(0,0,0,.28)}
  .card h2{font-size:18px;margin:0;padding:12px 14px;border-bottom:1px solid var(--line)}
  .body{padding:12px 14px 16px}
  .q{padding:10px;border:1px dashed var(--line);border-radius:12px;margin:10px 0}
  .q h3{margin:0 0 6px;font-size:16px}
  .opt{display:flex;gap:10px;align-items:flex-start;padding:6px 8px;border-radius:10px}
  .opt:hover{background:rgba(255,255,255,.05)}
  .actions{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap}
  button{appearance:none;border:1px solid var(--line);background:#13182a;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  button.primary{background:var(--accent);border-color:transparent;color:#0c0f1c;font-weight:700}
  .explain{margin-top:6px;color:#e3e6ff}
  .hidden{display:none}
  .pair{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .chip{padding:6px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:grab;user-select:none}
  .dropzone{min-height:40px;padding:6px;border:1.5px dashed rgba(255,255,255,.25);border-radius:10px;display:flex;flex-wrap:wrap;gap:6px}
  .r-item{margin:6px 0; padding:4px 0}
  .r-item .lbl{display:inline-block; margin-bottom:4px}
  .order{display:flex;flex-direction:column;gap:8px}
  .item{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.06);cursor:grab}
  .ok{outline:2px solid rgba(32,201,151,.6)}
  .ko{outline:2px solid rgba(255,91,115,.6)}
  .score{font-weight:700}
  .note{font-size:13px;color:#c7ccff}
  table.vf{width:100%; border-collapse:collapse; font-size:15px; margin-top:6px}
  table.vf th, table.vf td{border:1px solid var(--line); padding:8px 10px; vertical-align:middle}
  table.vf th{background:rgba(255,255,255,.06); text-align:left}
  table.vf td.center{text-align:center; width:120px}
  table.vf tr:nth-child(even){background:rgba(255,255,255,.03)}
  .opt.ok{background:rgba(32,201,151,.15); border-radius:10px; outline:2px solid rgba(32,201,151,.5)}
  .opt.ko{background:rgba(255,91,115,.15); border-radius:10px; outline:2px solid rgba(255,91,115,.5)}
  table.vf tr.ok{background:rgba(32,201,151,.15)!important}
  table.vf tr.ko{background:rgba(255,91,115,.15)!important}
  .dropzone.ok{background:rgba(32,201,151,.15); border-color: rgba(32,201,151,.6)}
  .dropzone.ko{background:rgba(255,91,115,.15); border-color: rgba(255,91,115,.6)}
  .chip.ko{outline:2px solid rgba(255,91,115,.6)}
  .chip.ok{outline:2px solid rgba(32,201,151,.6)}
  .hint{font-size:12px;color:#c9ceff;margin-top:4px}
  .pill{font-size:12px; border:1px solid var(--line); padding:2px 8px; border-radius:999px; color:#cfd3ff}

  .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
  .carddef{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.04)}
  .carddef b{color:#e9ecff}
  .carddef .def{margin-top:6px; display:none; color:#dfe3ff}
  .carddef.show .def{display:block}

</style>
</head>
<body>
<div class="wrap">
  <h1>UE 2.11 S1 — MAXI QUIZ **FULL** (TD + CM)</h1>
  <p class="subtitle">Tout le contenu essentiel des fichiers : définitions, propriétés, tendances. QCM (simples / multiples), V/F en tableau, appariement (glisser-déposer), classement. Aucune saisie de formules.</p>

  <section class="card" id="sec-atome">
    <div class="flex"><h2>1) Atome & structure électronique</h2><span class="pill">TD1 + CM02</span></div>
    <div class="body" id="atome-container"></div>
  </section>

  <section class="card" id="sec-radio">
    <div class="flex"><h2>2) Radioactivité (définitions & propriétés)</h2><span class="pill">TD2</span></div>
    <div class="body" id="radio-container"></div>
  </section>

  <section class="card" id="sec-ondes">
    <div class="flex"><h2>3) Ondes mécaniques</h2><span class="pill">CM01</span></div>
    <div class="body" id="ondes-container"></div>
  </section>

  <section class="card" id="sec-inter">
    <div class="flex"><h2>4) Interactions photons–matière</h2><span class="pill">Doc Interactions</span></div>
    <div class="body" id="inter-container"></div>
  </section>

  <section class="card" id="sec-radiopro">
    <div class="flex"><h2>5) Radioprotection & Notations</h2><span class="pill">Vocabulaire + blindage + A/Z</span></div>
    <div class="body" id="radiopro-container"></div>
  
  <section class="card" id="sec-defs">
    <div class="flex"><h2>6) Définitions — entraînement</h2><span class="pill">Flashcards + appariement + QCM</span></div>
    <div class="body" id="defs-container"></div>
  </section>

</section>

  <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center">
    <span class="score" id="score-total">Score total : 0</span>
    <div class="flex">
      <button onclick="resetAll()">Tout réinitialiser</button>
      <button class="primary" onclick="renderAll()">Régénérer l’ordre</button>
    </div>
  </div>
</div>

<script>
const qs=(s,el=document)=>el.querySelector(s);
const qsa=(s,el=document)=>Array.from(el.querySelectorAll(s));
const show=el=>el.classList.remove('hidden');
const hide=el=>el.classList.add('hidden');
const shuffle=arr=>arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);
let total=0;
const bump=(n)=>{ total+=n; qs('#score-total').textContent='Score total : '+total; };

// ------------------------------------------------------------------
// BANQUE ÉTENDUE — définitions & notions (généralités TD/CM)
// ------------------------------------------------------------------
const BANK = {
  atome: {
    vf: [ // 18+ lignes
      ["Z est le nombre de protons (numéro atomique).",1,"Définition."],
      ["A est le nombre total de nucléons (protons + neutrons).",1,"Définition."],
      ["N = A − Z correspond au nombre de neutrons.",1,"Définition."],
      ["Dans un atome neutre, le nombre d’électrons = Z.",1,"Neutralité globale."],
      ["Le nuage électronique est composé d’électrons.",1,"—"],
      ["Les électrons ont une masse négligeable devant celle des nucléons.",1,"Ordre de grandeur."],
      ["Le noyau est chargé négativement.",0,"Noyau chargé positivement (protons)."],
      ["Isotopes : même Z, A différent.",1,"—"],
      ["Isotones : même N, Z différent.",1,"—"],
      ["Isobares : même A, Z différent.",1,"—"],
      ["Un cation a perdu des électrons (charge +).",1,"—"],
      ["Un anion a gagné des électrons (charge −).",1,"—"],
      ["Les couches K, L, M… sont des niveaux d’énergie électroniques.",1,"—"],
      ["Les électrons de valence sont les électrons de la couche externe.",1,"—"],
      ["Liaison ionique = transfert d’électrons ; covalente = partage.",1,"—"],
      ["Le symbole A/Z X indique A (haut), Z (bas), X (élément).",1,"—"],
      ["Changer Z change d’élément ; changer N change d’isotope.",1,"—"],
      ["Un noyau excité peut émettre un photon γ pour se désexciter.",1,"Lien structure ↔ radioactivité."]
    ],
    mc: [
      { id:"z", title:"Z = ?", answers:["nombre de protons"], choices:["nombre de protons","nombre de neutrons","nombre total de nucléons","masse atomique (A)"], rationale:"Z = protons. (Atome neutre : e− = Z.)" },
      { id:"a", title:"A = ?", answers:["protons + neutrons"], choices:["protons + neutrons","seulement protons","seulement électrons","charge du noyau"], rationale:"A = p + n (nombre de masse)." },
      { id:"fam", title:"Cocher les définitions correctes", answers:["Isotopes : même Z","Isotones : même N","Isobares : même A"], choices:["Isotopes : même Z","Isotones : même N","Isobares : même A","Isotopes : même A"], rationale:"Rappels familles nucléaires." }
    ],
    pair: [
      { id:"fam2", title:"Apparier — familles nucléaires", left:[
        ["isotopes","Isotopes"],["isotones","Isotones"],["isobares","Isobares"]
      ], right:[
        ["isotopes","Même Z, A différent"],["isotones","Même N, Z différent"],["isobares","Même A, Z différent"]
      ] }
    ]
  },

  radio: {
    vf: [ // 16+ lignes
      ["La radioactivité est la transformation d’un noyau instable en noyau plus stable avec émission.",1,"Définition."],
      ["α correspond à une particule d’hélium 4 (2p + 2n).",1,"—"],
      ["β− : émission d’un électron.",1,"—"],
      ["β+ : émission d’un positon (positron).",1,"—"],
      ["γ : désexcitation par émission d’un photon γ.",1,"—"],
      ["Conservation de A et Z dans les équations nucléaires.",1,"Bilan masse/charge."],
      ["L’activité se mesure en becquerels (Bq).",1,"1 Bq = 1 désintégration/s."],
      ["La demi-vie est le temps nécessaire pour diviser l’activité par deux.",1,"—"],
      ["Ordre de pénétration : α < β < γ.",1,"—"],
      ["Les α sont arrêtées par une feuille de papier/peau.",1,"—"],
      ["Les β sont atténuées par Al/plastique (quelques mm).",1,"—"],
      ["Les γ nécessitent des écrans à Z élevé et épais (plomb).",1,"—"],
      ["La production de paires crée un couple e−/e+ près d’un noyau.",1,"Seuil énergétique requis."],
      ["L’effet photoélectrique absorbe totalement le photon incident.",1,"Éjection d’un électron lié."],
      ["Compton : diffusion inélastique avec partage d’énergie.",1,"Photon diffusé + électron Compton."],
      ["La radioactivité naturelle n’existe pas.",0,"Elle existe (fonds naturels)."]
    ],
    mc: [
      { id:"ionisants", title:"Types de rayonnements ionisants (sélection multiple)", answers:["α","β−","β+","γ"], choices:["α","β−","β+","γ","ultrason","infrarouge"], rationale:"Ionisants en contexte nucléaire : α, β−, β+, γ." },
      { id:"unites", title:"Unité correcte → activité / dose absorbée / dose équivalente", answers:["Activité : Bq","Dose absorbée : Gy","Dose équivalente/effective : Sv"], choices:["Activité : Bq","Dose absorbée : Gy","Dose équivalente/effective : Sv","Activité : Sv"], rationale:"Bq / Gy / Sv." }
    ],
    pair: [
      { id:"emission", title:"Apparier — émissions et descriptions", left:[
        ["alpha","α"],["beta-","β−"],["beta+","β+"],["gamma","γ"]
      ], right:[
        ["alpha","Particule He-4"],["beta-","Électron émis"],["beta+","Positon émis"],["gamma","Photon (désexcitation)"]
      ] }
    ],
    order: [
      { id:"chaine", title:"Chaîne qualitative (parent → fille) — placer dans l’ordre", items:[
        ["Ra","Ra"],["Rn","Rn"],["Po","Po"],["Pb","Pb (stable)"]
      ], answer:["Ra","Rn","Po","Pb"], rationale:"Ordre schématique d’entraînement." }
    ]
  },

  ondes: {
    vf: [
      ["Une onde mécanique a besoin d’un milieu matériel.",1,"—"],
      ["Une onde mécanique transporte de l’énergie.",1,"—"],
      ["La célérité dépend du milieu.",1,"—"],
      ["Les ultrasons sont > 20 kHz (audible humain).",1,"—"],
      ["Une onde mécanique se propage dans le vide.",0,"Support matériel requis."],
      ["Onde transversale : déplacement ⟂ à la propagation (ex. corde).",1,"—"],
      ["Onde longitudinale : déplacement ∥ à la propagation (ex. son).",1,"—"]
    ],
    mc: [
      { id:"type", title:"Exemples corrects", answers:["son : longitudinale","corde vibrante : transversale"], choices:["son : longitudinale","son : transversale","corde vibrante : transversale","corde vibrante : longitudinale"], rationale:"Définitions types." }
    ],
    order: [
      { id:"ord", title:"Classe sans calcul : du plus indépendant au plus dépendant (T, v, λ)", items:[["T","Période T"],["v","Vitesse v (du milieu)"],["lambda","Longueur d’onde λ"]], answer:["T","v","lambda"], rationale:"Ordre attendu → T, puis v, puis λ. Intuition : T est une propriété temporelle du signal; v dépend du milieu; λ dépend des deux (≈ v·T)."}
    ]
  },

  inter: {
    vf: [
      ["Photoélectrique : absorption totale + éjection d’un électron lié.",1,"—"],
      ["Compton : diffusion inélastique ; photon diffusé + électron Compton.",1,"—"],
      ["Paires : création e−/e+ près d’un noyau (seuil requis).",1,"—"],
      ["Rayleigh (cohérente) : diffusion élastique sans ionisation.",1,"—"],
      ["Pour les RX : Z élevé ⇒ atténuation plus forte.",1,"—"]
    ],
    mc: [
      { id:"dom", title:"Interaction dominante (tendance qualitative)", answers:["Basse énergie + Z élevé : photoélectrique","Énergies intermédiaires : Compton","Très hautes énergies : paires"], choices:["Basse énergie + Z élevé : photoélectrique","Basse énergie + Z élevé : Compton","Énergies intermédiaires : Compton","Très hautes énergies : paires"], rationale:"Tendances usuelles en radiologie." }
    ],
    pair: [
      { id:"map", title:"Associer — interaction ↔ description", left:[
        ["pe","Photoélectrique"],["comp","Compton"],["paires","Paires"],["rayleigh","Rayleigh"]
      ], right:[
        ["pe","Absorption totale + e− lié arraché"],["comp","Photon diffusé + e− éjecté (partage)"],["paires","γ → e− + e+ (près noyau)"],["rayleigh","Diffusion élastique, sans ionisation"]
      ] }
    ]
  },

  radiopro: {
    vf: [
      ["Irradiation = exposition à un rayonnement.",1,"—"],
      ["Contamination = présence de radionucléides sur/dans l’organisme.",1,"—"],
      ["Activité : Bq ; dose absorbée : Gy ; dose équivalente/effective : Sv.",1,"—"],
      ["Un écran en papier suffit pour γ.",0,"Papier : α ; β : Al/plastique ; γ : Pb."],
      ["Éloignement, durée, écrans : principes de base de radioprotection.",1,"—"]
    ],
    mc: [
      { id:"unites2", title:"Associer variable → unité (sélection multiple)", answers:["Activité → Bq","Dose absorbée → Gy","Dose équivalente/effective → Sv"], choices:["Activité → Bq","Dose absorbée → Gy","Dose équivalente/effective → Sv","Activité → Sv","Dose absorbée → Bq"], rationale:"Bq/Gy/Sv." }
    ],
    pair: [
      { id:"shield", title:"Apparier — type ↔ écran (tendance)", left:[
        ["alpha","α"],["beta","β"],["gamma","γ"]
      ], right:[
        ["alpha","Feuille de papier / peau"],["beta","Aluminium / plastique (quelques mm)"],["gamma","Plomb / Z élevé (épais)"]
      ] }
    ]
  }
};


// --------- DEFINITIONS BANK ---------
const DEFS = [
  {t:"Radioactivité", d:"Transformation spontanée d’un noyau instable en noyau plus stable avec émission (α, β, γ…)."},
  {t:"Désintégration", d:"Événement élémentaire de transformation d’un noyau instable (on parle aussi d’événement de radioactivité)."},
  {t:"Activité (Bq)", d:"Nombre de désintégrations par seconde (1 Bq = 1 s⁻¹)."},
  {t:"Demi‑vie", d:"Temps au bout duquel l’activité (ou le nombre de noyaux instables) est divisée par deux."},
  {t:"Irradiation", d:"Exposition d’un organisme à un rayonnement, sans préjuger d’une contamination."},
  {t:"Contamination", d:"Présence de radionucléides sur ou dans l’organisme."},
  {t:"Dose absorbée (Gy)", d:"Énergie déposée par unité de masse (J·kg⁻¹)."},
  {t:"Dose équivalente/effective (Sv)", d:"Dose tenant compte des pondérations (rayonnement, tissu). Unité de risque radiologique."},
  {t:"Isotopes", d:"Noyaux d’un même élément (même Z) mais A différent (N différent)."},
  {t:"Isotones", d:"Noyaux de même N, Z différent."},
  {t:"Isobares", d:"Noyaux de même A, Z différent."},
  {t:"Cation", d:"Atome/ion qui a perdu des électrons (charge +)."},
  {t:"Anion", d:"Atome/ion qui a gagné des électrons (charge −)."},
  {t:"Onde mécanique", d:"Perturbation qui se propage dans un milieu matériel en transportant de l’énergie."},
  {t:"Période / fréquence", d:"Période = durée d’un motif ; fréquence = nombre de motifs par seconde."},
  {t:"Coefficient d’atténuation μ", d:"Paramètre décrivant la décroissance de l’intensité avec l’épaisseur (plus μ est grand, plus l’atténuation est forte)."},
  {t:"Couche de demi‑atténuation (HVL)", d:"Épaisseur qui réduit d’environ moitié l’intensité transmise."},
  {t:"Effet photoélectrique", d:"Absorption totale du photon et éjection d’un électron lié (favorisé à basse énergie et Z élevé)."},
  {t:"Diffusion Compton", d:"Diffusion inélastique : photon diffusé + électron éjecté, partage d’énergie."},
  {t:"Production de paires", d:"Création e⁻/e⁺ par un photon γ près d’un noyau (seuil d’énergie requis)."},
  {t:"Blindage α", d:"Feuille de papier / peau."},
  {t:"Blindage β", d:"Aluminium / plastique (quelques mm)."},
  {t:"Blindage γ", d:"Plomb / matériau à Z élevé (épais)."},
  {t:"Noyau excité → γ", d:"Un noyau excité peut se désexciter par émission d’un photon γ."}
];

// Render: Flashcards
function renderFlashcards(container){
  const wrap=document.createElement('div');
  wrap.className='q';
  wrap.innerHTML='<h3>Flashcards — cliquer pour révéler</h3><div class="cards" id="cards"></div>';
  container.appendChild(wrap);
  const grid=wrap.querySelector('#cards');
  DEFS.forEach(obj=>{
    const c=document.createElement('div');
    c.className='carddef';
    c.innerHTML='<b>'+obj.t+'</b><div class="def">'+obj.d+'</div><div class="actions"><button>Révéler</button></div>';
    c.querySelector('button').addEventListener('click',()=>{ c.classList.toggle('show'); });
    grid.appendChild(c);
  });
}

// Build pairs from DEFS (shuffle terms vs definitions)
function defsToPairs(){
  const left = DEFS.map((o,i)=>[String(i),'« '+o.t+' »']);
  const right = DEFS.map((o,i)=>[String(i), o.d]);
  return {left, right};
}

function renderDefsPairs(scopeElId, container){
  const pr = defsToPairs();
  const data = { id:"defs-pair", title:"Apparier — terme ↔ définition (général)", left: pr.left, right: pr.right };
  renderPairs(scopeElId, container, [data]);
}

// QCM sur définitions : pour chaque terme, 1 bonne définition parmi 3 propositions
function defsToMC(){
  // Build distractors by sampling nearby definitions (simple heuristic)
  const items=[];
  for(let i=0;i<DEFS.length;i++){
    const good = DEFS[i];
    // pick 2 distractors
    const candidates = DEFS.filter((_,j)=>j!==i);
    // simple shuffle
    for(let k=candidates.length-1;k>0;k--){ const r=Math.floor(Math.random()*(k+1)); [candidates[k],candidates[r]]=[candidates[r],candidates[k]]; }
    const d1=candidates[0].d, d2=candidates[1].d;
    items.push({
      id:'def-'+i,
      title:'Définition correcte pour « '+good.t+' »',
      answers:[good.d],
      choices:[good.d, d1, d2],
      rationale:'Définition attendue pour « '+good.t+' ».'
    });
  }
  return items;
}

function renderDefsMC(scopeElId, container){
  const items = defsToMC();
  renderMC(scopeElId, container, items);
}

// ------------------------------------------------------------------
// RENDERERS (robustes et simples)
// ------------------------------------------------------------------
function renderVF(scopeId, container, rows){
  rows = shuffle(rows.slice());
  const qDiv=document.createElement('div');
  qDiv.className='q';
  qDiv.setAttribute('data-qid',scopeId+'-vf');
  const body = rows.map((r,i)=>{
    const expl = (r[2] ? String(r[2]) : '').replace(/"/g,'&quot;');
    return '<tr data-true="'+r[1]+'" data-explain="'+expl+'">'
      + '<td>'+r[0]+'</td>'
      + '<td class="center"><label><input type="radio" name="'+scopeId+'-vf-'+i+'" value="V"> Vrai</label></td>'
      + '<td class="center"><label><input type="radio" name="'+scopeId+'-vf-'+i+'" value="F"> Faux</label></td>'
      + '</tr>';
  }).join('');
  qDiv.innerHTML = [
    '<h3>Vrai / Faux</h3>',
    '<table class="vf"><thead><tr><th>Énoncé</th><th class="center">Vrai</th><th class="center">Faux</th></tr></thead><tbody>'+body+'</tbody></table>',
    '<div class="actions"><button onclick="checkVFTable(\''+scopeId+'-vf\')">Corriger</button>',
    '<button onclick="resetVFTable(\''+scopeId+'-vf\')">Réinitialiser</button></div>',
    '<div class="explain hidden"></div>'
  ].join('');
  container.appendChild(qDiv);
}

function renderMC(scopeElId, container, items){
  items = shuffle(items.slice());
  items.forEach((q,i)=>{
    const id=scopeElId+'-'+q.id;
    const choices=shuffle(q.choices.slice());
    const ansIdxs=q.answers.map(a=>choices.indexOf(a)).filter(i=>i>=0);
    const qDiv=document.createElement('div');
    qDiv.className='q';
    qDiv.setAttribute('data-qid',id);
    qDiv.setAttribute('data-type','mc');
    qDiv.setAttribute('data-answer', ansIdxs.join(','));
    qDiv.innerHTML = [
      '<h3>QCM — '+ q.title +'</h3>',
      choices.map((c,idx)=>'<div class="opt"><input type="checkbox" value="'+idx+'"> '+c+'</div>').join(''),
      '<div class="actions"><button onclick="checkMC(\''+id+'\',\''+q.rationale.replace(/'/g,"\\'")+'\')">Corriger</button></div>',
      '<div class="explain hidden"></div>'
    ].join('');
    container.appendChild(qDiv);
  });
}

function renderPairs(scopeElId, container, pairs){
  pairs = shuffle(pairs.slice());
  pairs.forEach((p)=>{
    const id=scopeElId+'-'+p.id;
    const qDiv=document.createElement('div');
    qDiv.className='q';
    qDiv.setAttribute('data-qid',id);
    qDiv.setAttribute('data-type','pair');
    const left = shuffle(p.left.slice());
    const right = p.right.slice();
    qDiv.innerHTML = [
      '<h3>'+ p.title +'</h3>',
      '<div class="pair">',
        '<div>'+ left.map((L)=>'<div class="chip" draggable="true" data-id="'+L[0]+'">'+L[1]+'</div>').join('') +'</div>',
        '<div>'+ right.map((R)=>'<div class="r-item"><span class="lbl">'+R[1]+'</span><div class="dropzone" data-accept="'+R[0]+'"></div></div>').join('') +'</div>',
      '</div>',
      '<div class="actions"><button onclick="checkPairs(\''+id+'\')">Corriger</button>',
      '<button onclick="resetPairs(\''+id+'\')">Réinitialiser</button></div>',
      '<div class="explain hidden"></div>'
    ].join('');
    container.appendChild(qDiv);
  });
}

function renderOrder(scopeElId, container, orders){
  orders = shuffle(orders.slice());
  orders.forEach((o)=>{
    const id=scopeElId+'-'+o.id;
    const qDiv=document.createElement('div');
    qDiv.className='q';
    qDiv.setAttribute('data-qid',id);
    qDiv.setAttribute('data-type','order');
    qDiv.setAttribute('data-answer', o.answer.join(','));
    const items = shuffle(o.items.slice());
    qDiv.innerHTML = [
      '<h3>'+ o.title +'</h3>',
      '<div class="order">'+ items.map((it)=>'<div class="item" draggable="true" data-id="'+it[0]+'">'+it[1]+'</div>').join('') +'</div>',
      '<div class="actions"><button onclick="checkOrder(\''+id+'\',\''+(o.rationale ? o.rationale : '').replace("'","\\'")+'\')">Corriger</button></div>',
      '<div class="explain hidden"></div>'
    ].join('');
    container.appendChild(qDiv);
  });
}

// ------------------------------------------------------------------
// CHECKERS
// ------------------------------------------------------------------
function checkMC(qid,rationale){
  const q=qs('[data-qid="'+qid+'"]');
  const ans=(q.getAttribute('data-answer')||'').split(',').filter(Boolean).map(Number);
  const opts=qsa('.opt',q);
  const cbs=qsa('input[type="checkbox"]',q);
  opts.forEach(o=>o.classList.remove('ok','ko'));
  const picked=cbs.map((cb,idx)=>cb.checked?idx:null).filter(v=>v!==null);
  const ok = picked.length===ans.length && ans.every(v=>picked.includes(v));
  ans.forEach(idx=>{ if(opts[idx]) opts[idx].classList.add('ok'); });
  picked.forEach(idx=>{ if(!ans.includes(idx) && opts[idx]) opts[idx].classList.add('ko'); });
  const labels=opts.map(o=>o.textContent.trim());
  const correctList = ans.map(i=>'• '+labels[i]).join('<br>');
  const ex=q.querySelector('.explain');
  ex.innerHTML = ok ? '✅ Correct.' : '❌ Faux. '+(rationale||'')+'<br><span class="hint">Bonne(s) réponse(s) :</span><br>'+correctList;
  show(ex);
  q.classList.remove('ok','ko'); q.classList.add(ok?'ok':'ko');
  bump(ok?1:0);
}

function checkVFTable(qid){
  const q=qs('[data-qid="'+qid+'"]');
  const rows=qsa('tbody tr', q);
  let score=0;
  rows.forEach((row)=>{
    row.classList.remove('ok','ko');
    const expected = row.getAttribute('data-true')==='1' ? 'V' : 'F';
    const chosenEl = row.querySelector('input[type="radio"]:checked');
    const chosen = chosenEl ? chosenEl.value : '';
    if(chosen===expected){ score++; row.classList.add('ok'); }
    else{ row.classList.add('ko'); }
    const expl=row.getAttribute('data-explain')||'';
    if(expl){
      const lastCell = row.lastElementChild;
      const explSpan = document.createElement('div');
      explSpan.className='hint';
      explSpan.textContent = 'Note : '+ expl;
      lastCell.appendChild(explSpan);
    }
  });
  const ex=q.querySelector('.explain'); ex.innerHTML='Résultat : '+score+' / '+rows.length; show(ex);
  bump(score);
}

function resetVFTable(qid){
  const q=qs('[data-qid="'+qid+'"]');
  qsa('input[type="radio"]',q).forEach(r=>r.checked=false);
  qsa('tbody tr',q).forEach(tr=>{ tr.classList.remove('ok','ko'); const hints=tr.querySelectorAll('.hint'); hints.forEach(h=>h.remove()); });
  hide(q.querySelector('.explain'));
}

let dragged=null;
document.addEventListener('dragstart',e=>{
  const t=e.target;
  if(t.classList.contains('chip')||t.classList.contains('item')){
    dragged=t; e.dataTransfer.setData('text/plain', t.getAttribute('data-id')||'');
  }
});
document.addEventListener('dragover',e=>{
  if(e.target.closest('.dropzone')||e.target.closest('.order')) e.preventDefault();
});
document.addEventListener('drop',e=>{
  const dz=e.target.closest('.dropzone');
  if(dz&&dragged){ e.preventDefault(); dz.appendChild(dragged); }
  const ord=e.target.closest('.order');
  if(ord&&dragged&&dragged.classList.contains('item')){
    e.preventDefault();
    const after=e.target.closest('.item');
    if(after&&after!==dragged){
      const items=[...ord.children];
      const idxAfter=items.indexOf(after);
      ord.insertBefore(dragged, idxAfter>items.indexOf(dragged)? after.nextSibling: after);
    }else{ ord.appendChild(dragged); }
  }
});

function checkPairs(qid){
  const q=qs('[data-qid="'+qid+'"]');
  const dzs=qsa('.dropzone',q); let ok=0;
  dzs.forEach(dz=>dz.classList.remove('ok','ko'));
  qsa('.chip',q).forEach(c=>c.classList.remove('ok','ko'));
  const items = qsa('.pair > div:last-child .r-item', q);
  const labelByAccept = {};
  items.forEach(item=>{
    const dz = item.querySelector('.dropzone');
    const accept = dz.getAttribute('data-accept');
    const lbl = item.querySelector('.lbl').textContent.trim();
    labelByAccept[accept]=lbl;
  });
  const nameById = {}; qsa('.pair .chip', q).forEach(ch=>{ nameById[ch.getAttribute('data-id')] = ch.textContent.trim(); });
  const feedback = [];
  dzs.forEach(dz=>{
    const want=dz.getAttribute('data-accept');
    const chip=dz.querySelector('.chip');
    if(chip){
      if(chip.getAttribute('data-id')===want){ ok++; dz.classList.add('ok'); chip.classList.add('ok'); }
      else{ dz.classList.add('ko'); chip.classList.add('ko'); }
      const got = chip ? nameById[chip.getAttribute('data-id')] : "—";
      feedback.push('• '+labelByAccept[want]+' → attendu: '+nameById[want]+' ; obtenu: '+got);
    }else{
      dz.classList.add('ko');
      feedback.push('• '+labelByAccept[want]+' → attendu: '+nameById[want]+' ; obtenu: (vide)');
    }
  });
  const ex=q.querySelector('.explain');
  ex.innerHTML='Résultat : '+ok+' / '+dzs.length+'<br><span class="hint">Correction :</span><br>'+feedback.join('<br>');
  show(ex);
  bump(ok);
}

function resetPairs(qid){
  const q=qs('[data-qid="'+qid+'"]');
  const left=q.querySelector('.pair > div:first-child');
  qsa('.chip',q).forEach(c=>{ c.classList.remove('ok','ko'); left.appendChild(c); });
  qsa('.dropzone',q).forEach(dz=>dz.classList.remove('ok','ko'));
  hide(q.querySelector('.explain'));
}

function checkOrder(qid,rationale){
  const q=qs('[data-qid="'+qid+'"]');
  const ans=(q.getAttribute('data-answer')||'').split(',');
  const items=[...q.querySelectorAll('.order .item')].map(n=>n.getAttribute('data-id'));
  const ok = ans.length===items.length && ans.every((v,i)=>v===items[i]);
  const ex=q.querySelector('.explain');
  ex.innerHTML = ok? '✅ Ordre correct.' : '❌ Ordre incorrect. '+(rationale||'');
  show(ex);
  bump(ok?1:0);
}

// ------------------------------------------------------------------
// RENDER ALL
// ------------------------------------------------------------------
function renderAll(){
  ["atome","radio","ondes","inter","radiopro"].forEach(sec=>qs("#"+sec+"-container").innerHTML='');
  total=0; qs('#score-total').textContent='Score total : 0';

  // ATOME
  renderVF("atome", qs("#atome-container"), BANK.atome.vf);
  renderMC("atome", qs("#atome-container"), BANK.atome.mc);
  renderPairs("atome", qs("#atome-container"), BANK.atome.pair);

  // RADIO
  renderVF("radio", qs("#radio-container"), BANK.radio.vf);
  renderMC("radio", qs("#radio-container"), BANK.radio.mc);
  renderPairs("radio", qs("#radio-container"), BANK.radio.pair);
  renderOrder("radio", qs("#radio-container"), BANK.radio.order);

  // ONDES
  renderVF("ondes", qs("#ondes-container"), BANK.ondes.vf);
  renderMC("ondes", qs("#ondes-container"), BANK.ondes.mc);
  renderOrder("ondes", qs("#ondes-container"), BANK.ondes.order);

  // INTERACTIONS
  renderVF("inter", qs("#inter-container"), BANK.inter.vf);
  renderMC("inter", qs("#inter-container"), BANK.inter.mc);
  renderPairs("inter", qs("#inter-container"), BANK.inter.pair);

  
  // DEFINITIONS
  renderFlashcards(qs("#defs-container"));
  renderDefsPairs("defs", qs("#defs-container"));
  renderDefsMC("defs", qs("#defs-container"));


  // RADIOPRO
  renderVF("radiopro", qs("#radiopro-container"), BANK.radiopro.vf);
  renderMC("radiopro", qs("#radiopro-container"), BANK.radiopro.mc);
  renderPairs("radiopro", qs("#radiopro-container"), BANK.radiopro.pair);
}

renderAll();
</script>
</body>
</html>
