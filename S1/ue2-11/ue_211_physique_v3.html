<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UE 2.11 - Physique Fondamentale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 3px solid #667eea;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Flashcards */
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .flashcards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .flashcard {
            perspective: 1000px;
            height: 250px;
            cursor: pointer;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .flashcard-front h3,
        .flashcard-back p {
            margin: 0;
            padding: 0;
            max-width: 100%;
            word-wrap: break-word;
        }

        .flashcard-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
            border: 2px solid #667eea;
        }

        .category-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .know-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .know-btn:hover {
            background: #218838;
        }

        /* QCM */
        .question-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .option.selected {
            border-color: #667eea;
            background: #e7eaf6;
        }

        .option.correct {
            border-color: #28a745;
            background: #d4edda;
        }

        .option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }

        .validate-btn {
            margin-top: 15px;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
        }

        .validate-btn:hover {
            background: #5568d3;
        }

        .validate-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .explanation {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
            display: none;
        }

        .explanation.show {
            display: block;
        }

        /* Vrai/Faux */
        .vf-options {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .vf-option {
            flex: 1;
            padding: 20px;
            border: 3px solid #e9ecef;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            text-align: center;
            transition: all 0.3s;
        }

        .vf-option:hover {
            transform: scale(1.05);
        }

        .vf-option.vrai {
            background: #d4edda;
            border-color: #28a745;
        }

        .vf-option.faux {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .vf-option.correct {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .vf-option.incorrect {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        /* Formules */
        .formula-builder {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .formula-display {
            min-height: 80px;
            background: white;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }

        .formula-element {
            display: inline-block;
            margin: 0 2px;
        }

        .formula-input {
            border: 1px solid #ccc;
            padding: 5px;
            font-size: 1em;
            border-radius: 5px;
            text-align: center;
        }

        .formula-fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
            vertical-align: middle;
        }

        .formula-fraction input {
            width: 100px;
            text-align: center;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .formula-fraction input:focus {
            outline: none;
            border: 2px solid #667eea;
            background: #f0f4ff;
            box-shadow: 0 0 8px rgba(102, 126, 234, 0.3);
        }

        .formula-fraction input:first-child {
            border-bottom: 2px solid #333;
            border-radius: 5px 5px 0 0;
        }

        .formula-fraction input:last-child {
            border-radius: 0 0 5px 5px;
        }

        .symbols-palette {
            margin-bottom: 20px;
        }

        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 5px;
            margin-top: 10px;
        }

        .symbol-btn {
            padding: 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .symbol-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .builder-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .control-btn:hover {
            background: #5568d3;
        }

        .clear-btn {
            background: #dc3545;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        /* Exercises */
        .exercise-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .exercise-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }

        .exercise-question {
            margin: 15px 0;
            line-height: 1.6;
        }

        .exercise-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            margin-top: 10px;
        }

        .calculation-area {
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .calculation-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        .calculation-input {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 20px;
        }

        .result-area {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .result-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .result-label {
            font-weight: 600;
            font-size: 0.9em;
            color: #666;
        }

        .result-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1.1em;
            width: 150px;
        }

        .unit-input {
            padding: 10px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1.1em;
            width: 100px;
        }

        .show-solution-btn {
            margin-top: 15px;
            padding: 10px 20px;
            background: #ffc107;
            color: #333;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
        }

        .show-solution-btn:hover {
            background: #e0a800;
        }

        .solution {
            margin-top: 15px;
            padding: 15px;
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            border-radius: 5px;
            display: none;
        }

        .solution.show {
            display: block;
        }

        /* Saved Questions */
        .saved-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .saved-item {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ffc107;
        }

        .remove-btn {
            margin-top: 10px;
            padding: 8px 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }

            .flashcards-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .tab {
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìö UE 2.11 - Physique Fondamentale</h1>
            <p class="subtitle">R√©visions MERM - Semestre 1</p>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('stats')">üìä Statistiques</button>
            <button class="tab" onclick="switchTab('flashcards')">üé¥ Flashcards</button>
            <button class="tab" onclick="switchTab('vf')">‚úì‚úó Vrai/Faux</button>
            <button class="tab" onclick="switchTab('qcm')">üìù QCM</button>
            <button class="tab" onclick="switchTab('formules')">üìê Formules</button>
            <button class="tab" onclick="switchTab('exercises')">üßÆ Exercices</button>
            <button class="tab" onclick="switchTab('saved')">‚≠ê Sauvegard√©es</button>
        </div>

        <div id="stats" class="tab-content active">
            <h2 style="margin-bottom: 20px;">üìä Vos Statistiques</h2>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div id="flashcards" class="tab-content">
            <h2 style="margin-bottom: 20px;">üé¥ Flashcards</h2>
            <div class="filters" id="filters"></div>
            <div class="flashcards-grid" id="flashcardsGrid"></div>
        </div>

        <div id="vf" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚úì‚úó Vrai ou Faux</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="vfProgress">0%</div>
            </div>
            <div id="vfContainer"></div>
        </div>

        <div id="qcm" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìù Questions √† Choix Multiples</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="qcmProgress">0%</div>
            </div>
            <div id="qcmContainer"></div>
        </div>

        <div id="formules" class="tab-content">
            <h2 style="margin-bottom: 20px;">üìê Construction de Formules</h2>
            <div class="progress-bar">
                <div class="progress-fill" id="formulesProgress">0%</div>
            </div>
            <div id="formulesContainer"></div>
        </div>

        <div id="exercises" class="tab-content">
            <h2 style="margin-bottom: 20px;">üßÆ Exercices de Calcul</h2>
            <div id="exercisesContainer"></div>
        </div>

        <div id="saved" class="tab-content">
            <h2 style="margin-bottom: 20px;">‚≠ê Questions Sauvegard√©es</h2>
            <div class="saved-list" id="savedList"></div>
        </div>
    </div>

    <script>
        // ==================== DATA ====================
        const flashcardsData = [
            // Atome et structure √©lectronique
            { category: 'Atome', question: 'Quelle est la composition du noyau atomique ?', answer: 'Protons (charge +) et neutrons (charge nulle)' },
            { category: 'Atome', question: 'Que repr√©sente Z (num√©ro atomique) ?', answer: 'Le nombre de protons dans le noyau' },
            { category: 'Atome', question: 'Que repr√©sente A (nombre de masse) ?', answer: 'Le nombre total de nucl√©ons (protons + neutrons)' },
            { category: 'Atome', question: 'Comment calculer le nombre de neutrons ?', answer: 'N = A - Z' },
            { category: 'Atome', question: 'Qu\'est-ce qu\'un isotope ?', answer: 'Atomes avec m√™me Z mais A diff√©rent' },
            { category: 'Atome', question: 'Qu\'est-ce qu\'un ion ?', answer: 'Atome ayant gagn√© ou perdu des √©lectrons' },
            { category: 'Atome', question: 'Diff√©rence entre cation et anion ?', answer: 'Cation: ion + (perte e‚Åª), Anion: ion - (gain e‚Åª)' },
            { category: 'Atome', question: 'Qu\'est-ce que la couche de valence ?', answer: 'Derni√®re couche √©lectronique externe' },
            { category: 'Atome', question: 'Capacit√© maximale couche K, L, M ?', answer: 'K=2, L=8, M=18 √©lectrons (formule 2n¬≤)' },
            { category: 'Atome', question: 'Structure lacunaire de l\'atome ?', answer: 'Grand vide entre noyau et √©lectrons' },

            // Radioactivit√©
            { category: 'Radioactivit√©', question: 'D√©finition de la radioactivit√© ?', answer: 'Transformation spontan√©e d\'un noyau instable en noyau stable avec √©mission de particules/rayonnement' },
            { category: 'Radioactivit√©', question: 'Loi de conservation de Soddy ?', answer: 'Conservation du nombre de masse A et du nombre de charge Z' },
            { category: 'Radioactivit√©', question: 'Radioactivit√© Œ± (alpha) : particule √©mise ?', answer: 'Noyau d\'h√©lium ‚Å¥‚ÇÇHe (2 protons + 2 neutrons)' },
            { category: 'Radioactivit√©', question: 'Radioactivit√© Œ≤‚Åª : particule √©mise ?', answer: '√âlectron ‚Å∞‚Çã‚ÇÅe (neutron ‚Üí proton + e‚Åª)' },
            { category: 'Radioactivit√©', question: 'Radioactivit√© Œ≤+ : particule √©mise ?', answer: 'Positron ‚Å∞‚Çä‚ÇÅe (proton ‚Üí neutron + e+)' },
            { category: 'Radioactivit√©', question: 'Radioactivit√© Œ≥ (gamma) ?', answer: 'Rayonnement √©lectromagn√©tique (photon), pas de particule' },
            { category: 'Radioactivit√©', question: 'D√©finition p√©riode T‚ÇÅ/‚ÇÇ ?', answer: 'Temps pour que la moiti√© des noyaux se d√©sint√®grent' },
            { category: 'Radioactivit√©', question: 'Formule loi de d√©sint√©gration ?', answer: 'N(t) = N‚ÇÄ √ó e‚Åª·µè·µó' },
            { category: 'Radioactivit√©', question: 'Formule activit√© radioactive ?', answer: 'A(t) = A‚ÇÄ √ó e‚Åª·µè·µó (en Becquerel)' },
            { category: 'Radioactivit√©', question: 'Noyaux radioactifs √† partir de Z= ?', answer: 'Z > 83 (tous radioactifs, √©mission Œ±)' },

            // Ondes √©lectromagn√©tiques
            { category: 'Ondes EM', question: 'D√©finition onde √©lectromagn√©tique ?', answer: 'Propagation d\'un champ √©lectrique E et magn√©tique B perpendiculaires, pas de support mat√©riel n√©cessaire' },
            { category: 'Ondes EM', question: 'Formule longueur d\'onde ?', answer: 'Œª = c √ó T = c / f' },
            { category: 'Ondes EM', question: 'Formule fr√©quence ?', answer: 'f = 1 / T (en Hertz)' },
            { category: 'Ondes EM', question: 'Vitesse lumi√®re dans vide ?', answer: 'c ‚âà 3,00 √ó 10‚Å∏ m/s' },
            { category: 'Ondes EM', question: 'Domaine visible (longueurs d\'onde) ?', answer: '380 nm √† 780 nm' },
            { category: 'Ondes EM', question: 'Ordre du spectre EM (√©nergie croissante) ?', answer: 'Radio ‚Üí Micro-ondes ‚Üí IR ‚Üí Visible ‚Üí UV ‚Üí Rayons X ‚Üí Gamma' },
            { category: 'Ondes EM', question: 'Formule √©nergie photon ?', answer: 'E = h √ó ŒΩ = h √ó c / Œª' },
            { category: 'Ondes EM', question: 'Valeur constante de Planck ?', answer: 'h = 6,63 √ó 10‚Åª¬≥‚Å¥ J¬∑s' },
            { category: 'Ondes EM', question: 'Conversion 1 eV en Joules ?', answer: '1 eV = 1,60 √ó 10‚Åª¬π‚Åπ J' },
            { category: 'Ondes EM', question: 'Rayons X : longueur d\'onde ?', answer: '0,01 nm √† 10 nm (10‚Åª¬π¬π √† 10‚Åª‚Å∏ m)' },

            // Interactions rayonnement-mati√®re
            { category: 'Interactions', question: 'Rayonnement ionisant : d√©finition ?', answer: '√ânergie suffisante pour arracher √©lectron (> 12,4 eV)' },
            { category: 'Interactions', question: 'Effet photo√©lectrique ?', answer: 'Photon transmet TOUTE son √©nergie √† un √©lectron qui est √©ject√©' },
            { category: 'Interactions', question: 'Effet Compton ?', answer: 'Photon transmet une PARTIE de son √©nergie √† un √©lectron, photon diffus√©' },
            { category: 'Interactions', question: 'Production de paire ?', answer: 'Photon ‚Üí √©lectron + positron (pr√®s du noyau)' },
            { category: 'Interactions', question: 'Diffusion Rayleigh ?', answer: 'Photon faible √©nergie rebondit sans transfert d\'√©nergie' },
            { category: 'Interactions', question: 'TLE (Transfert Lin√©ique √ânergie) ?', answer: '√ânergie perdue par particule par unit√© de longueur' },
            { category: 'Interactions', question: 'Particules Œ± : trajectoire ?', answer: 'Rectiligne (particule lourde)' },
            { category: 'Interactions', question: '√âlectrons : trajectoire ?', answer: 'Al√©atoire (particule l√©g√®re)' },
            { category: 'Interactions', question: 'Rayonnement de freinage ?', answer: '√âlectrons rapides ralentis ‚Üí √©mission rayons X' },
            { category: 'Interactions', question: 'R√©action nucl√©aire provoqu√©e ?', answer: 'Fission ou fusion (noyau cible + projectile)' },

            // Champs √©lectrique et magn√©tique
            { category: 'Champs', question: 'Direction champ √©lectrique E ?', answer: 'Des potentiels d√©croissants (+ vers -)' },
            { category: 'Champs', question: 'Formule force √©lectrique ?', answer: 'F = q √ó E' },
            { category: 'Champs', question: 'Formule champ √©lectrique ?', answer: 'E = U / d (V/m)' },
            { category: 'Champs', question: 'Particule q>0 : direction force ?', answer: 'M√™me sens que E' },
            { category: 'Champs', question: 'Particule q<0 : direction force ?', answer: 'Sens oppos√© √† E' },
            { category: 'Champs', question: 'Force de Lorentz (magn√©tique) ?', answer: 'F = q √ó v √ó B (perpendiculaire √† v et B)' },
            { category: 'Champs', question: 'Trajectoire particule dans B uniforme ?', answer: 'Circulaire (si v ‚ä• B)' },
            { category: 'Champs', question: 'Lignes champ charge positive ?', answer: 'Sortent (centrifuges)' },
            { category: 'Champs', question: 'Lignes champ charge n√©gative ?', answer: 'Entrent (centrip√®tes)' },
            { category: 'Champs', question: 'Canon √† √©lectrons : principe ?', answer: 'Acc√©l√©ration √©lectrons par diff√©rence potentiel' },

            // Ondes sonores
            { category: 'Ondes sonores', question: 'Nature ondes sonores ?', answer: 'Ondes m√©caniques longitudinales (besoin d\'un milieu)' },
            { category: 'Ondes sonores', question: 'Vitesse son dans l\'air ?', answer: '‚âà 340 m/s (√† 15¬∞C)' },
            { category: 'Ondes sonores', question: 'Domaine audible (fr√©quences) ?', answer: '20 Hz √† 20 kHz' },
            { category: 'Ondes sonores', question: 'Infrasons : fr√©quence ?', answer: '< 20 Hz' },
            { category: 'Ondes sonores', question: 'Ultrasons : fr√©quence ?', answer: '> 20 kHz' },
            { category: 'Ondes sonores', question: 'Effet Doppler : principe ?', answer: 'Fr√©quence per√ßue change si √©metteur/r√©cepteur en mouvement' },
            { category: 'Ondes sonores', question: '√âchographie : ondes utilis√©es ?', answer: 'Ultrasons (non audibles, non ionisants)' },
            { category: 'Ondes sonores', question: 'Vitesse son dans solides vs air ?', answer: 'Plus rapide dans solides (ex: acier 5000 m/s)' }
        ];

        const vraiFauxData = [
            { question: 'Un atome est √©lectriquement neutre', answer: true, explanation: 'Un atome a autant de protons (+) que d\'√©lectrons (-), donc neutralit√© √©lectrique' },
            { question: 'Les isotopes ont le m√™me nombre de neutrons', answer: false, explanation: 'Les isotopes ont le m√™me Z (protons) mais A diff√©rent (donc neutrons diff√©rents)' },
            { question: 'Le noyau contient la quasi-totalit√© de la masse de l\'atome', answer: true, explanation: 'Les √©lectrons ont une masse n√©gligeable compar√©e aux nucl√©ons' },
            { question: 'La radioactivit√© gamma √©met des √©lectrons', answer: false, explanation: 'Le rayonnement gamma est √©lectromagn√©tique (photons), pas de particules' },
            { question: 'La d√©sint√©gration Œ≤‚Åª transforme un neutron en proton', answer: true, explanation: 'n ‚Üí p + e‚Åª + antineutrino' },
            { question: 'La p√©riode T‚ÇÅ/‚ÇÇ est le temps pour qu\'un noyau se d√©sint√®gre', answer: false, explanation: 'C\'est le temps pour que la MOITI√â des noyaux se d√©sint√®grent' },
            { question: 'Les ondes √©lectromagn√©tiques ont besoin d\'un milieu mat√©riel', answer: false, explanation: 'Elles se propagent dans le vide (contrairement aux ondes m√©caniques)' },
            { question: 'La fr√©quence et la longueur d\'onde sont inversement proportionnelles', answer: true, explanation: 'Œª = c/f donc si f augmente, Œª diminue' },
            { question: 'Les rayons X ont plus d\'√©nergie que la lumi√®re visible', answer: true, explanation: 'E = h√óc/Œª et Œª(rayons X) < Œª(visible) donc E plus grande' },
            { question: 'L\'effet photo√©lectrique : le photon transmet une partie de son √©nergie', answer: false, explanation: 'Le photon transmet TOUTE son √©nergie et dispara√Æt' },
            { question: 'L\'effet Compton produit un photon diffus√©', answer: true, explanation: 'Une partie de l\'√©nergie est transmise, le photon continue avec moins d\'√©nergie' },
            { question: 'Un rayonnement ionisant peut arracher un √©lectron', answer: true, explanation: 'C\'est la d√©finition : √©nergie > potentiel d\'ionisation' },
            { category: 'Interactions', question: 'Le TLE mesure l\'√©nergie perdue par unit√© de temps', answer: false, explanation: 'TLE = √©nergie perdue par unit√© de LONGUEUR (pas de temps)' },
            { question: 'Les particules alpha ont une trajectoire rectiligne', answer: true, explanation: 'Particules lourdes ‚Üí trajectoire rectiligne (contrairement aux √©lectrons)' },
            { question: 'Le champ √©lectrique est dirig√© vers les potentiels croissants', answer: false, explanation: 'E est dirig√© vers les potentiels D√âCROISSANTS (+ vers -)' },
            { question: 'Une particule positive subit une force dans le sens de E', answer: true, explanation: 'F = q√óE, si q>0 alors F et E m√™me sens' },
            { question: 'Une particule n√©gative subit une force oppos√©e √† E', answer: true, explanation: 'F = q√óE, si q<0 alors F et E sens oppos√©s' },
            { question: 'La force de Lorentz agit sur les particules au repos', answer: false, explanation: 'F = q√óv√óB n√©cessite que v ‚â† 0 (particule en mouvement)' },
            { question: 'Les lignes de champ d\'une charge + sortent de la charge', answer: true, explanation: 'Charge positive = lignes centrifuges (qui sortent)' },
            { question: 'Les ondes sonores sont des ondes transversales', answer: false, explanation: 'Les ondes sonores sont LONGITUDINALES dans l\'air' },
            { question: 'Les ultrasons sont audibles par l\'homme', answer: false, explanation: 'Ultrasons > 20 kHz, inaudibles (sauf pour certains animaux)' },
            { question: 'La vitesse du son augmente avec la temp√©rature', answer: true, explanation: 'Plus l\'air est chaud, plus les mol√©cules bougent vite ‚Üí son plus rapide' },
            { question: 'Le son se propage dans le vide', answer: false, explanation: 'Le son est une onde m√©canique, besoin d\'un milieu mat√©riel' },
            { question: 'L\'effet Doppler modifie la fr√©quence per√ßue', answer: true, explanation: 'Source en mouvement ‚Üí fr√©quence plus haute (approche) ou plus basse (√©loignement)' },
            { question: 'Les rayons gamma sont les plus √©nerg√©tiques du spectre EM', answer: true, explanation: 'Gamma > X > UV > visible > IR > micro-ondes > radio' },
            { question: 'La constante de Planck h ‚âà 6,63 √ó 10‚Åª¬≥‚Å¥ J¬∑s', answer: true, explanation: 'Valeur exacte √† conna√Ætre pour E = h√óŒΩ' },
            { question: '1 eV = 1,60 √ó 10‚Åª¬π‚Åπ J', answer: true, explanation: 'Conversion fondamentale √©lectronvolt ‚Üî joules' },
            { question: 'La lumi√®re visible a une longueur d\'onde entre 380 et 780 nm', answer: true, explanation: 'Violet (380 nm) ‚Üí Rouge (780 nm)' },
            { question: 'Les noyaux avec Z > 83 sont tous radioactifs', answer: true, explanation: '√Ä partir de Z=84, tous les noyaux sont instables (√©mission Œ±)' },
            { question: 'La fission nucl√©aire : un noyau lourd se scinde en 2 noyaux l√©gers', answer: true, explanation: 'Fission = division (ex: uranium ‚Üí 2 fragments + neutrons)' }
        ];

        const qcmData = [
            {
                question: 'Un noyau de carbone ¬π‚Å¥‚ÇÜC contient :',
                options: ['6 protons et 6 neutrons', '6 protons et 8 neutrons', '8 protons et 6 neutrons', '14 protons et 6 √©lectrons'],
                correct: 1,
                explanation: 'Z=6 (protons), A=14, donc N=A-Z=14-6=8 neutrons'
            },
            {
                question: 'La d√©sint√©gration Œ≤‚Åª √©met :',
                options: ['Un √©lectron', 'Un positron', 'Un noyau d\'h√©lium', 'Un photon'],
                correct: 0,
                explanation: 'Œ≤‚Åª = √©lectron √©mis (neutron ‚Üí proton + e‚Åª)'
            },
            {
                question: 'La p√©riode radioactive T‚ÇÅ/‚ÇÇ est :',
                options: ['Le temps pour qu\'un noyau se d√©sint√®gre', 'Le temps pour que tous les noyaux se d√©sint√®grent', 'Le temps pour que la moiti√© des noyaux se d√©sint√®grent', 'Le nombre de d√©sint√©grations par seconde'],
                correct: 2,
                explanation: 'T‚ÇÅ/‚ÇÇ = temps n√©cessaire pour que 50% des noyaux radioactifs se d√©sint√®grent'
            },
            {
                question: 'Quelle est la vitesse de la lumi√®re dans le vide ?',
                options: ['3,00 √ó 10‚Å∂ m/s', '3,00 √ó 10‚Å∏ m/s', '3,00 √ó 10¬π‚Å∞ m/s', '340 m/s'],
                correct: 1,
                explanation: 'c ‚âà 3,00 √ó 10‚Å∏ m/s (constante fondamentale)'
            },
            {
                question: 'L\'effet photo√©lectrique se caract√©rise par :',
                options: ['Photon transmet une partie de son √©nergie', 'Photon transmet toute son √©nergie et dispara√Æt', 'Photon rebondit sans perte d\'√©nergie', 'Photon se transforme en paire e‚Åª/e‚Å∫'],
                correct: 1,
                explanation: 'Effet photo√©lectrique : photon donne TOUTE son √©nergie ‚Üí √©lectron √©ject√©'
            },
            {
                question: 'Un rayonnement est ionisant si :',
                options: ['Il peut arracher un √©lectron (E > 12,4 eV)', 'Il chauffe la mati√®re', 'Il est visible', 'Il a une grande longueur d\'onde'],
                correct: 0,
                explanation: 'Ionisant = capable d\'arracher √©lectrons (√©nergie suffisante)'
            },
            {
                question: 'Le champ √©lectrique E est dirig√© :',
                options: ['Vers les potentiels croissants', 'Vers les potentiels d√©croissants', 'Perpendiculairement aux plaques', 'Dans le sens du courant'],
                correct: 1,
                explanation: 'E va toujours du + vers le - (potentiels d√©croissants)'
            },
            {
                question: 'Une onde sonore dans l\'air est :',
                options: ['Transversale', 'Longitudinale', '√âlectromagn√©tique', 'Stationnaire'],
                correct: 1,
                explanation: 'Son dans l\'air = onde m√©canique longitudinale (compression/dilatation)'
            },
            {
                question: 'Le domaine audible pour l\'homme est :',
                options: ['2 Hz √† 2 kHz', '20 Hz √† 20 kHz', '200 Hz √† 200 kHz', '0,2 Hz √† 200 Hz'],
                correct: 1,
                explanation: 'Audible : 20 Hz (grave) √† 20 kHz (aigu)'
            },
            {
                question: 'La formule E = h √ó ŒΩ relie :',
                options: ['√ânergie et fr√©quence d\'un photon', '√ânergie et longueur d\'onde', 'Fr√©quence et p√©riode', 'Vitesse et acc√©l√©ration'],
                correct: 0,
                explanation: 'E = h√óŒΩ (√©nergie photon proportionnelle √† fr√©quence)'
            },
            {
                question: 'Les isotopes ont :',
                options: ['M√™me Z, m√™me A', 'M√™me Z, A diff√©rent', 'Z diff√©rent, m√™me A', 'Z diff√©rent, A diff√©rent'],
                correct: 1,
                explanation: 'Isotopes = m√™me nombre de protons (Z) mais nombre de nucl√©ons (A) diff√©rent'
            },
            {
                question: 'Dans l\'effet Compton :',
                options: ['Le photon dispara√Æt compl√®tement', 'Le photon est diffus√© avec moins d\'√©nergie', 'Le photon rebondit sans perte', 'Le photon cr√©e une paire e‚Åª/e‚Å∫'],
                correct: 1,
                explanation: 'Compton : photon transmet UNE PARTIE de son √©nergie ‚Üí photon diffus√©'
            },
            {
                question: 'La force sur une particule charg√©e dans un champ √©lectrique est :',
                options: ['F = m √ó a', 'F = q √ó E', 'F = q √ó v √ó B', 'F = G √ó m‚ÇÅ √ó m‚ÇÇ / r¬≤'],
                correct: 1,
                explanation: 'Force √©lectrique : F = q √ó E'
            },
            {
                question: 'Les ultrasons ont une fr√©quence :',
                options: ['< 20 Hz', 'Entre 20 Hz et 20 kHz', '> 20 kHz', '> 100 MHz'],
                correct: 2,
                explanation: 'Ultrasons > 20 kHz (inaudibles pour l\'homme)'
            },
            {
                question: 'La constante de Planck h vaut environ :',
                options: ['6,63 √ó 10‚Åª¬≥‚Å¥ J¬∑s', '3,00 √ó 10‚Å∏ m/s', '1,60 √ó 10‚Åª¬π‚Åπ J', '9,81 m/s¬≤'],
                correct: 0,
                explanation: 'h = 6,63 √ó 10‚Åª¬≥‚Å¥ J¬∑s (constante fondamentale quantique)'
            },
            {
                question: 'Un noyau avec Z = 90 est :',
                options: ['Stable', 'Radioactif Œ±', 'Radioactif Œ≤‚Åª', 'Radioactif Œ≤‚Å∫'],
                correct: 1,
                explanation: 'Z > 83 ‚Üí tous radioactifs avec √©mission Œ± (noyaux lourds)'
            },
            {
                question: 'La longueur d\'onde Œª est li√©e √† la fr√©quence f par :',
                options: ['Œª = f / c', 'Œª = c / f', 'Œª = c √ó f', 'Œª = f √ó T'],
                correct: 1,
                explanation: 'Œª = c / f (ou Œª = c √ó T car T = 1/f)'
            },
            {
                question: 'Les rayons X ont une longueur d\'onde :',
                options: ['> 1 mm', 'Entre 380 et 780 nm', 'Entre 0,01 et 10 nm', '< 0,01 pm'],
                correct: 2,
                explanation: 'Rayons X : 0,01 nm √† 10 nm (entre UV et gamma)'
            },
            {
                question: 'Une particule Œ± est :',
                options: ['Un √©lectron', 'Un positron', 'Un noyau d\'h√©lium ‚Å¥‚ÇÇHe', 'Un photon'],
                correct: 2,
                explanation: 'Particule Œ± = noyau d\'h√©lium (2 protons + 2 neutrons)'
            },
            {
                question: 'L\'√©nergie d\'un photon augmente quand :',
                options: ['La longueur d\'onde augmente', 'La fr√©quence augmente', 'La vitesse augmente', 'La p√©riode augmente'],
                correct: 1,
                explanation: 'E = h√óŒΩ donc E ‚àù fr√©quence (et E ‚àù 1/Œª)'
            }
        ];

        const formulesData = [
            { question: 'Donnez la formule de la longueur d\'onde en fonction de la c√©l√©rit√© et de la p√©riode', correct: ['Œª=c√óT', 'Œª=cT', 'Œª=c.T', 'Œª=c√óœÑ', 'Œª=cœÑ', 'Œª=c.œÑ'], explanation: 'Œª = c √ó T (longueur d\'onde = c√©l√©rit√© √ó p√©riode)' },
            { question: 'Donnez la formule de la longueur d\'onde en fonction de la c√©l√©rit√© et de la fr√©quence', correct: ['Œª=c/f', 'Œª=c√∑f'], explanation: 'Œª = c / f' },
            { question: 'Donnez la formule reliant fr√©quence et p√©riode', correct: ['f=1/T', 'f=1√∑T'], explanation: 'f = 1 / T' },
            { question: 'Donnez la formule de l\'√©nergie d\'un photon en fonction de h, c et Œª', correct: ['E=h√óc/Œª', 'E=hc/Œª', 'E=h.c/Œª', 'E=(h√óc)/Œª', 'E=(hc)/Œª', 'E=(h.c)/Œª'], explanation: 'E = (h √ó c) / Œª' },
            { question: 'Donnez la formule de l\'√©nergie d\'un photon en fonction de h et ŒΩ', correct: ['E=h√óŒΩ', 'E=hŒΩ', 'E=h.ŒΩ'], explanation: 'E = h √ó ŒΩ' },
            { question: 'Donnez la loi de d√©sint√©gration radioactive N(t)', correct: ['N(t)=N‚ÇÄ√óe^(-Œªt)', 'N(t)=N‚ÇÄe^(-Œªt)', 'N(t)=N‚ÇÄ√óe^-Œªt', 'N(t)=N‚ÇÄe^-Œªt'], explanation: 'N(t) = N‚ÇÄ √ó e^(-Œªt)' },
            { question: 'Donnez la formule de la p√©riode radioactive T‚ÇÅ/‚ÇÇ', correct: ['T1/2=ln2/Œª', 'T1/2=ln(2)/Œª'], explanation: 'T‚ÇÅ/‚ÇÇ = ln(2) / Œª' },
            { question: 'Donnez la formule de la force √©lectrique', correct: ['Fe=q√óE', 'Fe=qE', 'Fe=q.E'], explanation: 'Fe = q √ó E' },
            { question: 'Donnez la formule du champ √©lectrique entre deux plaques', correct: ['E=U/d', 'E=U√∑d'], explanation: 'E = U / d' },
            { question: 'Donnez la formule du nombre de neutrons', correct: ['N=A-Z', 'N=A‚àíZ'], explanation: 'N = A - Z' },
            { question: 'Donnez la formule de l\'activit√© radioactive A(t)', correct: ['A(t)=A‚ÇÄ√óe^(-Œªt)', 'A(t)=A‚ÇÄe^(-Œªt)', 'A(t)=A‚ÇÄ√óe^-Œªt', 'A(t)=A‚ÇÄe^-Œªt'], explanation: 'A(t) = A‚ÇÄ √ó e^(-Œªt)' },
            { question: 'Donnez la relation entre vitesse de la lumi√®re, indice de r√©fraction et vitesse dans le milieu', correct: ['n=c/v', 'n=c√∑v'], explanation: 'n = c / v (indice de r√©fraction)' }
        ];

        const exercisesData = [
            {
                title: 'Calcul de longueur d\'onde',
                question: 'Une onde se d√©place √† 3,00 √ó 10‚Å∏ m/s avec une p√©riode de 1,50 √ó 10‚Åª¬π‚Åµ s. Calculez sa longueur d\'onde.',
                solution: 'Œª = c √ó T = 3,00 √ó 10‚Å∏ √ó 1,50 √ó 10‚Åª¬π‚Åµ = 4,5 √ó 10‚Åª‚Å∑ m = 450 nm'
            },
            {
                title: 'Composition atomique',
                question: 'Pour l\'atome ¬≤¬≥‚ÇÅ‚ÇÅNa, d√©terminez le nombre de protons, neutrons et √©lectrons.',
                solution: 'Z = 11 ‚Üí 11 protons, 11 √©lectrons (atome neutre)\nN = A - Z = 23 - 11 = 12 neutrons'
            },
            {
                title: '√ânergie d\'un photon',
                question: 'Calculez l\'√©nergie (en eV) d\'un photon de longueur d\'onde 530 nm.\nDonn√©es: h = 6,63 √ó 10‚Åª¬≥‚Å¥ J¬∑s, c = 3,00 √ó 10‚Å∏ m/s, 1 eV = 1,60 √ó 10‚Åª¬π‚Åπ J',
                solution: 'E = h√óc/Œª = (6,63√ó10‚Åª¬≥‚Å¥ √ó 3,00√ó10‚Å∏) / (530√ó10‚Åª‚Åπ)\nE = 3,75 √ó 10‚Åª¬π‚Åπ J\nE = 3,75√ó10‚Åª¬π‚Åπ / 1,60√ó10‚Åª¬π‚Åπ = 2,34 eV'
            },
            {
                title: 'P√©riode radioactive',
                question: 'Un √©chantillon radioactif contient initialement 1000 noyaux. Apr√®s 2 p√©riodes T‚ÇÅ/‚ÇÇ, combien reste-t-il de noyaux ?',
                solution: 'Apr√®s 1 p√©riode: N = 1000/2 = 500\nApr√®s 2 p√©riodes: N = 500/2 = 250 noyaux\nOu: N = N‚ÇÄ √ó (1/2)‚Åø = 1000 √ó (1/2)¬≤ = 250'
            },
            {
                title: 'Distance orage',
                question: 'Vous voyez un √©clair et entendez le tonnerre 12 secondes plus tard. √Ä quelle distance est l\'orage ?\n(vitesse son = 340 m/s)',
                solution: 'd = v √ó t = 340 √ó 12 = 4080 m ‚âà 4,1 km'
            }
        ];

        // ==================== STATE ====================
        let stats = {
            flashcardsStudied: 0,
            flashcardsKnown: 0,
            qcmAnswered: 0,
            qcmCorrect: 0,
            vfAnswered: 0,
            vfCorrect: 0,
            formulesAnswered: 0,
            formulesCorrect: 0,
            savedQuestions: []
        };

        let currentFilter = 'Tous';
        let qcmAnswers = new Array(qcmData.length).fill(null);
        let vfAnswers = new Array(vraiFauxData.length).fill(null);
        let formulesAnswers = new Array(formulesData.length).fill(null);

        // ==================== INIT ====================
        function init() {
            loadStats();
            updateStats();
            createFilters();
            createFlashcards();
            createVraiFaux();
            createQCM();
            createFormules();
            createExercises();
            updateSavedList();
        }

        // ==================== TABS ====================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ==================== STATS ====================
        function updateStats() {
            const qcmScore = stats.qcmAnswered > 0 ? Math.round((stats.qcmCorrect / stats.qcmAnswered) * 100) : 0;
            const vfScore = stats.vfAnswered > 0 ? Math.round((stats.vfCorrect / stats.vfAnswered) * 100) : 0;
            const formulesScore = stats.formulesAnswered > 0 ? Math.round((stats.formulesCorrect / stats.formulesAnswered) * 100) : 0;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Flashcards √©tudi√©es</div>
                    <div class="stat-number">${stats.flashcardsStudied}/${flashcardsData.length}</div>
                </div>
                <div class="stat-card" style="background: #27ae60;">
                    <div class="stat-label">‚úì Je connais</div>
                    <div class="stat-number">${stats.flashcardsKnown}</div>
                </div>
                <div class="stat-card" style="background: #f39c12;">
                    <div class="stat-label">‚ö†Ô∏è H√©sitant</div>
                    <div class="stat-number">${stats.flashcardsHesitant || 0}</div>
                </div>
                <div class="stat-card" style="background: #e74c3c;">
                    <div class="stat-label">‚ùå Je ne connais pas</div>
                    <div class="stat-number">${stats.flashcardsNotKnown || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Score QCM</div>
                    <div class="stat-number">${qcmScore}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Score Vrai/Faux</div>
                    <div class="stat-number">${vfScore}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Formules ma√Ætris√©es</div>
                    <div class="stat-number">${formulesScore}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Questions sauvegard√©es</div>
                    <div class="stat-number">${stats.savedQuestions.length}</div>
                </div>
            `;
        }

        function saveStats() {
            localStorage.setItem('ue211_stats', JSON.stringify(stats));
        }

        function loadStats() {
            try {
                const saved = localStorage.getItem('ue211_stats');
                if (saved && saved !== 'undefined' && saved !== 'null') {
                    stats = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Error loading stats, resetting:', e);
                localStorage.removeItem('ue211_stats');
            }
        }

        // ==================== FLASHCARDS ====================
        function createFilters() {
            const categories = ['Tous', ...new Set(flashcardsData.map(card => card.category))];
            document.getElementById('filters').innerHTML = categories.map(cat => 
                `<button class="filter-btn ${cat === 'Tous' ? 'active' : ''}" onclick="filterCards('${cat}')">${cat}</button>`
            ).join('');
        }

        let currentCardIndex = 0;
        let cardDifficulties = {}; // {cardIndex: 'known' | 'hesitant' | 'difficult'}
        let activeFormulaInput = null; // Pour tracker l'input de fraction actif
        let savedSelection = null; // Pour sauvegarder la s√©lection avant le blur
        let reviewMode = false; // Mode r√©vision activ√© ou non
        let reviewDeck = []; // Indices des cartes en mode r√©vision

        function loadCardDifficulties() {
            const saved = localStorage.getItem('ue211_card_difficulties');
            if (saved) {
                cardDifficulties = JSON.parse(saved);
            }
        }

        function saveCardDifficultiesLocal() {
            localStorage.setItem('ue211_card_difficulties', JSON.stringify(cardDifficulties));
        }

        function saveCardDifficulties() {
            // Sauvegarder en local storage
            saveCardDifficultiesLocal();
            
            // Aussi t√©l√©charger en fichier JSON
            const dataStr = JSON.stringify(cardDifficulties, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'flashcards_difficultes.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importCardDifficulties(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        cardDifficulties = JSON.parse(e.target.result);
                        saveCardDifficultiesLocal();
                        alert('‚úì Donn√©es charg√©es avec succ√®s !');
                        updateFlashcardCounters();
                        showCurrentCard();
                    } catch(error) {
                        alert('‚úó Erreur lors du chargement du fichier');
                    }
                };
                reader.readAsText(file);
            }
        }

        function generateReviewDeck() {
            // 3x cartes difficiles + 1x cartes h√©sitantes (PAS les cartes non vues)
            let deck = [];
            
            flashcardsData.forEach((card, index) => {
                const difficulty = cardDifficulties[index];
                if (difficulty === 'difficult') {
                    deck.push(index, index, index); // 3x
                } else if (difficulty === 'hesitant') {
                    deck.push(index); // 1x
                }
                // On ignore les cartes 'known' et non vues
            });
            
            // M√©langer
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            
            return deck;
        }

        function toggleReviewMode() {
            reviewMode = !reviewMode;
            currentCardIndex = 0;
            
            if (reviewMode) {
                reviewDeck = generateReviewDeck();
                if (reviewDeck.length === 0) {
                    alert('Aucune carte √† r√©viser ! (Pas de cartes difficiles ou h√©sitantes)');
                    reviewMode = false;
                    return;
                }
            }
            
            // Mettre √† jour le bouton
            const btn = document.getElementById('review-mode-btn');
            if (btn) {
                btn.style.background = reviewMode ? '#e74c3c' : '#9b59b6';
                btn.textContent = reviewMode ? 'üìö Mode Normal' : 'üéØ Mode R√©vision';
            }
            
            showCurrentCard();
        }

        function filterCards(category) {
            currentFilter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent === category);
            });
            currentCardIndex = 0;
            showCurrentCard();
        }

        function createFlashcards() {
            console.log('üîç DEBUG createFlashcards called');
            console.log('üîç flashcardsData length:', flashcardsData.length);
            console.log('üîç currentFilter:', currentFilter);
            
            const container = document.getElementById('flashcardsGrid');
            console.log('üîç Container found:', container !== null);
            
            if (!container) {
                console.error('‚ùå flashcardsGrid container not found!');
                return;
            }
            
            // Important: Retirer le display:grid pour √©viter les probl√®mes d'affichage
            container.style.display = 'block';
            
            container.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn" style="background: #3498db; color: white; padding: 10px 20px; margin: 5px;" onclick="saveCardDifficulties()">üíæ Sauvegarder (local + JSON)</button>
                    <label class="btn" style="background: #2ecc71; color: white; padding: 10px 20px; margin: 5px; cursor: pointer;">
                        üìÅ Charger JSON
                        <input type="file" accept=".json" onchange="importCardDifficulties(event)" style="display: none;">
                    </label>
                    <button id="review-mode-btn" class="btn" style="background: #9b59b6; color: white; padding: 10px 20px; margin: 5px;" onclick="toggleReviewMode()">üéØ Mode R√©vision</button>
                </div>
                <div id="flashcard-counters" style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="background: #27ae60; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold;">
                        ‚úì Ma√Ætris√©es: <span id="known-count">0</span>
                    </div>
                    <div style="background: #f39c12; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold;">
                        ‚ö†Ô∏è H√©sitant: <span id="hesitant-count">0</span>
                    </div>
                    <div style="background: #e74c3c; color: white; padding: 10px 20px; border-radius: 10px; font-weight: bold;">
                        ‚ùå Difficiles: <span id="difficult-count">0</span>
                    </div>
                </div>
                <div id="single-card-container" style="width: 100%; max-width: 600px; margin: 0 auto;"></div>
                <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center; align-items: center;">
                    <button class="btn" onclick="previousCard()" style="background: #95a5a6; color: white; padding: 10px 20px;">‚Üê Pr√©c√©dente</button>
                    <span id="card-counter" style="font-size: 1.1em; font-weight: bold;"></span>
                    <button class="btn" onclick="nextCard()" style="background: #95a5a6; color: white; padding: 10px 20px;">Suivante ‚Üí</button>
                </div>
            `;
            
            console.log('üîç Container HTML set, calling showCurrentCard');
            updateFlashcardCounters();
            showCurrentCard();
        }

        function updateFlashcardCounters() {
            const knownCount = Object.values(cardDifficulties).filter(d => d === 'known').length;
            const hesitantCount = Object.values(cardDifficulties).filter(d => d === 'hesitant').length;
            const difficultCount = Object.values(cardDifficulties).filter(d => d === 'difficult').length;
            
            const knownEl = document.getElementById('known-count');
            const hesitantEl = document.getElementById('hesitant-count');
            const difficultEl = document.getElementById('difficult-count');
            
            if (knownEl) knownEl.textContent = knownCount;
            if (hesitantEl) hesitantEl.textContent = hesitantCount;
            if (difficultEl) difficultEl.textContent = difficultCount;
        }

        function showCurrentCard() {
            console.log('üîç DEBUG showCurrentCard called');
            console.log('üîç currentFilter:', currentFilter);
            console.log('üîç currentCardIndex:', currentCardIndex);
            console.log('üîç reviewMode:', reviewMode);
            
            const singleCardContainer = document.getElementById('single-card-container');
            console.log('üîç single-card-container found:', singleCardContainer !== null);
            
            let actualIndex;
            let totalCards;
            
            if (reviewMode) {
                // Mode r√©vision : utiliser reviewDeck
                if (reviewDeck.length === 0) {
                    if (singleCardContainer) {
                        singleCardContainer.innerHTML = '<p style="text-align: center;">Aucune carte √† r√©viser !</p>';
                    }
                    return;
                }
                actualIndex = reviewDeck[currentCardIndex % reviewDeck.length];
                totalCards = reviewDeck.length;
            } else {
                // Mode normal : utiliser filtered cards
                const filtered = currentFilter === 'Tous' 
                    ? flashcardsData 
                    : flashcardsData.filter(card => card.category === currentFilter);
                
                console.log('üîç filtered length:', filtered.length);
                
                if (filtered.length === 0) {
                    if (singleCardContainer) {
                        singleCardContainer.innerHTML = '<p style="text-align: center;">Aucune carte dans cette cat√©gorie</p>';
                    }
                    return;
                }
                
                actualIndex = flashcardsData.indexOf(filtered[currentCardIndex % filtered.length]);
                totalCards = filtered.length;
            }
            
            const card = flashcardsData[actualIndex];
            const difficulty = cardDifficulties[actualIndex];
            
            console.log('üîç actualIndex:', actualIndex);
            console.log('üîç card:', card);
            console.log('üîç difficulty:', difficulty);

            let difficultyBadge = '';
            if (difficulty === 'known') difficultyBadge = '<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">‚úì Ma√Ætris√©e</span>';
            if (difficulty === 'hesitant') difficultyBadge = '<span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">‚ö†Ô∏è H√©sitant</span>';
            if (difficulty === 'difficult') difficultyBadge = '<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em;">‚ùå Difficile</span>';

            if (singleCardContainer) {
                singleCardContainer.innerHTML = `
                    <div class="flashcard" onclick="flipSingleCard()" id="current-flashcard">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <div class="category-badge">${card.category}</div>
                                ${difficultyBadge ? `<div style="position: absolute; top: 50px; left: 10px; z-index: 10;">${difficultyBadge}</div>` : ''}
                                <h3>${card.question}</h3>
                            </div>
                            <div class="flashcard-back">
                                <p>${card.answer}</p>
                                <div style="display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap;">
                                    <button class="btn" style="background: #e74c3c; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;" onclick="markCard(event, ${actualIndex}, 'difficult')">‚ùå Difficile</button>
                                    <button class="btn" style="background: #f39c12; color: white; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;" onclick="markCard(event, ${actualIndex}, 'hesitant')">‚ö†Ô∏è H√©sitant</button>
                                    <button class="know-btn" onclick="markCard(event, ${actualIndex}, 'known')">‚úì Je connais</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                console.log('‚úÖ Card HTML injected');
            }

            const cardCounter = document.getElementById('card-counter');
            if (cardCounter) {
                const modeLabel = reviewMode ? ' (R√©vision)' : '';
                cardCounter.textContent = `${currentCardIndex + 1} / ${totalCards}${modeLabel}`;
            }
        }

        function flipSingleCard() {
            document.getElementById('current-flashcard').classList.toggle('flipped');
        }

        function nextCard() {
            if (reviewMode) {
                currentCardIndex = (currentCardIndex + 1) % reviewDeck.length;
            } else {
                const filtered = currentFilter === 'Tous' 
                    ? flashcardsData 
                    : flashcardsData.filter(card => card.category === currentFilter);
                currentCardIndex = (currentCardIndex + 1) % filtered.length;
            }
            showCurrentCard();
        }

        function previousCard() {
            if (reviewMode) {
                currentCardIndex = (currentCardIndex - 1 + reviewDeck.length) % reviewDeck.length;
            } else {
                const filtered = currentFilter === 'Tous' 
                    ? flashcardsData 
                    : flashcardsData.filter(card => card.category === currentFilter);
                currentCardIndex = (currentCardIndex - 1 + filtered.length) % filtered.length;
            }
            showCurrentCard();
        }

        function markCard(event, cardIndex, difficulty) {
            event.stopPropagation();
            cardDifficulties[cardIndex] = difficulty;
            saveCardDifficultiesLocal();
            
            // Mettre √† jour les stats
            if (difficulty === 'known') {
                stats.flashcardsKnown++;
            } else if (difficulty === 'hesitant') {
                stats.flashcardsHesitant = (stats.flashcardsHesitant || 0) + 1;
            } else if (difficulty === 'difficult') {
                stats.flashcardsNotKnown = (stats.flashcardsNotKnown || 0) + 1;
            }
            saveStats();
            updateStats();
            updateFlashcardCounters();
            
            // Passer √† la carte suivante automatiquement
            setTimeout(() => nextCard(), 500);
        }

        // ==================== VRAI/FAUX ====================
        function createVraiFaux() {
            document.getElementById('vfContainer').innerHTML = vraiFauxData.map((item, index) => `
                <div class="question-card">
                    <div class="question-text">${index + 1}. ${item.question}</div>
                    <div class="vf-options">
                        <div class="vf-option vrai" onclick="selectVF(${index}, true)">
                            ‚úì VRAI
                        </div>
                        <div class="vf-option faux" onclick="selectVF(${index}, false)">
                            ‚úó FAUX
                        </div>
                    </div>
                    <div class="explanation" id="vf-explanation-${index}">
                        ${item.explanation}
                    </div>
                </div>
            `).join('');
            updateVFProgress();
        }

        function selectVF(index, answer) {
            const options = document.querySelectorAll(`#vfContainer .question-card:nth-child(${index + 1}) .vf-option`);
            const explanation = document.getElementById(`vf-explanation-${index}`);
            
            // Emp√™cher de r√©pondre deux fois
            if (vfAnswers[index] !== null) return;
            
            vfAnswers[index] = answer;
            const correct = answer === vraiFauxData[index].answer;
            
            stats.vfAnswered++;
            if (correct) {
                stats.vfCorrect++;
            } else {
                // Sauvegarder si incorrect
                if (!stats.savedQuestions.some(q => q.text === vraiFauxData[index].question)) {
                    stats.savedQuestions.push({
                        type: 'vf',
                        text: vraiFauxData[index].question,
                        answer: vraiFauxData[index].answer ? 'VRAI' : 'FAUX',
                        explanation: vraiFauxData[index].explanation
                    });
                }
            }
            
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                if (opt.classList.contains('vrai') && vraiFauxData[index].answer) {
                    opt.classList.add('correct');
                } else if (opt.classList.contains('faux') && !vraiFauxData[index].answer) {
                    opt.classList.add('correct');
                }
                if (opt.classList.contains('vrai') && answer === true && !correct) {
                    opt.classList.add('incorrect');
                } else if (opt.classList.contains('faux') && answer === false && !correct) {
                    opt.classList.add('incorrect');
                }
            });
            
            explanation.classList.add('show');
            saveStats();
            updateStats();
            updateVFProgress();
            updateSavedList();
        }

        function updateVFProgress() {
            const answered = vfAnswers.filter(a => a !== null).length;
            const percent = Math.round((answered / vraiFauxData.length) * 100);
            const fill = document.getElementById('vfProgress');
            fill.style.width = percent + '%';
            fill.textContent = `${answered}/${vraiFauxData.length} (${percent}%)`;
        }

        // ==================== QCM ====================
        function createQCM() {
            document.getElementById('qcmContainer').innerHTML = qcmData.map((q, qIndex) => `
                <div class="question-card">
                    <div class="question-text">${qIndex + 1}. ${q.question}</div>
                    <div class="options">
                        ${q.options.map((opt, oIndex) => `
                            <div class="option" onclick="selectOption(${qIndex}, ${oIndex})">
                                ${String.fromCharCode(65 + oIndex)}. ${opt}
                            </div>
                        `).join('')}
                    </div>
                    <button class="validate-btn" onclick="validateQCM(${qIndex})" disabled>
                        Valider
                    </button>
                    <div class="explanation" id="explanation-${qIndex}">
                        ${q.explanation}
                    </div>
                </div>
            `).join('');
            updateQCMProgress();
        }

        function selectOption(qIndex, oIndex) {
            console.log('üîç selectOption called with qIndex:', qIndex, 'oIndex:', oIndex);
            
            const qcmContainer = document.getElementById('qcmContainer');
            const allCards = qcmContainer.querySelectorAll('.question-card');
            console.log('üîç Total question-cards in QCM found:', allCards.length);
            
            const card = allCards[qIndex];
            console.log('üîç Card found:', !!card);
            
            if (!card) {
                console.error('‚ùå Card not found for index:', qIndex);
                return; // V√©rification de s√©curit√©
            }
            
            const options = card.querySelectorAll('.option');
            console.log('üîç Options found:', options.length);
            
            const button = card.querySelector('.validate-btn');
            console.log('üîç Button found:', !!button);
            
            // Si d√©j√† valid√©, ne rien faire
            if (qcmAnswers[qIndex] !== null) {
                console.log('‚ö†Ô∏è Question already answered');
                return;
            }
            
            // D√©s√©lectionner toutes les options et s√©lectionner celle cliqu√©e
            options.forEach((opt, i) => {
                if (i === oIndex) {
                    opt.classList.add('selected');
                    console.log('‚úÖ Option', i, 'selected');
                } else {
                    opt.classList.remove('selected');
                }
            });
            
            if (button) {
                button.disabled = false;
                console.log('‚úÖ Button enabled');
            } else {
                console.error('‚ùå Button not found');
            }
        }

        function validateQCM(qIndex) {
            const qcmContainer = document.getElementById('qcmContainer');
            const card = qcmContainer.querySelectorAll('.question-card')[qIndex];
            const options = card.querySelectorAll('.option');
            const selected = Array.from(options).findIndex(opt => opt.classList.contains('selected'));
            
            if (selected === -1) return;
            
            qcmAnswers[qIndex] = selected;
            const correct = selected === qcmData[qIndex].correct;
            
            stats.qcmAnswered++;
            if (correct) {
                stats.qcmCorrect++;
            } else {
                // Sauvegarder si incorrect
                if (!stats.savedQuestions.some(q => q.text === qcmData[qIndex].question)) {
                    stats.savedQuestions.push({
                        type: 'qcm',
                        text: qcmData[qIndex].question,
                        answer: qcmData[qIndex].options[qcmData[qIndex].correct],
                        explanation: qcmData[qIndex].explanation
                    });
                }
            }
            
            options.forEach((opt, i) => {
                opt.style.pointerEvents = 'none';
                if (i === qcmData[qIndex].correct) {
                    opt.classList.add('correct');
                } else if (i === selected) {
                    opt.classList.add('incorrect');
                }
            });
            
            document.getElementById(`explanation-${qIndex}`).classList.add('show');
            card.querySelector('.validate-btn').disabled = true;
            
            saveStats();
            updateStats();
            updateQCMProgress();
            updateSavedList();
        }

        function updateQCMProgress() {
            const answered = qcmAnswers.filter(a => a !== null).length;
            const percent = Math.round((answered / qcmData.length) * 100);
            const fill = document.getElementById('qcmProgress');
            fill.style.width = percent + '%';
            fill.textContent = `${answered}/${qcmData.length} (${percent}%)`;
        }

        // ==================== FORMULES ====================
        function createFormules() {
            document.getElementById('formulesContainer').innerHTML = formulesData.map((f, index) => `
                <div class="question-card">
                    <div class="question-text">${index + 1}. ${f.question}</div>
                    <div class="formula-builder">
                        <div class="symbols-palette">
                            <strong>üìå Symboles disponibles (cliquez pour ajouter):</strong>
                            <div style="margin-top: 10px;">
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #3498db; font-size: 0.9em;">üî§ Lettres grecques :</strong>
                                    <div class="symbol-grid" style="margin-top: 6px;">
                                        ${'Œª (lambda),ŒΩ (nu),Œº (mu),œÄ (pi),Œî (Delta),Œ£ (Sigma),Œ± (alpha),Œ≤ (beta),Œ≥ (gamma),œâ (omega),Œ∏ (theta),Œµ (epsilon),œÅ (rho),œÉ (sigma),œÑ (tau)'.split(',').map(s => {
                                            const [letter, name] = s.trim().split(' ');
                                            return `<button class="symbol-btn" onclick="addSymbol(${index}, '${letter}')" title="${name}">${letter}</button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #2ecc71; font-size: 0.9em;">üî° Lettres latines :</strong>
                                    <div class="symbol-grid" style="margin-top: 6px;">
                                        ${'A (nombre de masse),E (√©nergie),F (force),N (neutrons),T (p√©riode),Z (num√©ro atomique),c (c√©l√©rit√©),d (distance),e (√©lectron),f (fr√©quence),h (constante de Planck),m (masse),n (neutrons),q (charge),t (temps),v (vitesse)'.split(',').map(s => {
                                            const [letter, name] = s.trim().split(' ');
                                            return `<button class="symbol-btn" onclick="addSymbol(${index}, '${letter}')" title="${name}">${letter}</button>`;
                                        }).join('')}
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: #9b59b6; font-size: 0.9em;">üî¢ Chiffres et fractions :</strong>
                                    <div class="symbol-grid" style="margin-top: 6px;">
                                        ${'0,1,2,3,4,5,6,7,8,9,1/2,1/3,1/4,1/5,1/10'.split(',').map(s => 
                                            `<button class="symbol-btn" onclick="addSymbol(${index}, '${s}')" title="${s.includes('/') ? 'fraction ' + s : ''}">${s}</button>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div>
                                    <strong style="color: #e67e22; font-size: 0.9em;">‚ûï Op√©rateurs :</strong>
                                    <div class="symbol-grid" style="margin-top: 6px;">
                                        ${'+,-,√ó,√∑,/,=,(,),ln,e^'.split(',').map(s => 
                                            `<button class="symbol-btn" onclick="${s === 'e^' ? `addExponential(${index})` : `addSymbol(${index}, '${s}')`}">${s === 'e^' ? 'e^(...)' : s}</button>`
                                        ).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="formula-display" id="formula-${index}"></div>
                        <div class="builder-controls">
                            <button class="control-btn" onclick="addElement(${index}, 'normal')">Texte normal</button>
                            <button class="control-btn" onmousedown="event.preventDefault()" onclick="addElement(${index}, 'subscript')" title="S√©lectionner du texte puis cliquer pour le mettre en indice">Indice ‚Çì</button>
                            <button class="control-btn" onmousedown="event.preventDefault()" onclick="addElement(${index}, 'superscript')" title="S√©lectionner du texte puis cliquer pour le mettre en exposant">Exposant À£</button>
                            <button class="control-btn" onclick="addFraction(${index})">‚ûó Fraction</button>
                            <button class="control-btn clear-btn" onclick="clearFormula(${index})">üóëÔ∏è Effacer</button>
                            <button class="validate-btn" onclick="checkFormula(${index})">V√©rifier la formule</button>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-left: 3px solid #3498db; border-radius: 5px; font-size: 0.85em;">
                            üí° <strong>Astuce :</strong> Pour mettre du texte en indice ou exposant, tapez d'abord le texte, puis s√©lectionnez-le avec la souris et cliquez sur le bouton Indice ou Exposant.
                        </div>
                    </div>
                    <div class="explanation" id="formula-explanation-${index}"></div>
                </div>
            `).join('');
            updateFormulesProgress();
        }

        function addSymbol(fIndex, symbol) {
            const display = document.getElementById(`formula-${fIndex}`);
            
            // Si un input de fraction est actif, ajouter dedans
            if (activeFormulaInput && display.contains(activeFormulaInput)) {
                activeFormulaInput.value += symbol;
                return;
            }
            
            // Traitement sp√©cial pour les fractions qui doivent devenir des indices (comme 1/2 dans T‚ÇÅ/‚ÇÇ)
            if (symbol === '1/2' || symbol === '1/3' || symbol === '1/4' || symbol === '1/5' || symbol === '1/10') {
                // V√©rifier si le dernier √©l√©ment est une lettre qui attend un indice (T, N, A, etc.)
                const lastElement = display.lastElementChild;
                if (lastElement && lastElement.classList && lastElement.classList.contains('formula-element')) {
                    const lastText = lastElement.textContent.trim();
                    // Si c'est une lettre seule (T, A, N...), on ajoute l'indice
                    if (lastText.length === 1 && /[A-Z]/i.test(lastText)) {
                        // Cr√©er l'indice
                        const subscriptSpan = document.createElement('span');
                        subscriptSpan.className = 'formula-element';
                        subscriptSpan.innerHTML = symbol.split('').map(char => `<sub>${char}</sub>`).join('');
                        display.appendChild(subscriptSpan);
                        return;
                    }
                }
                // Sinon, ajouter normalement
            }
            
            // Sinon, cr√©er un nouveau span (pour les formules normales sans fraction)
            const span = document.createElement('span');
            span.className = 'formula-element';
            span.textContent = symbol;
            display.appendChild(span);
        }

        function addExponential(fIndex) {
            const display = document.getElementById(`formula-${fIndex}`);
            
            // Cr√©er la structure e^(...)
            const eSpan = document.createElement('span');
            eSpan.className = 'formula-element';
            eSpan.textContent = 'e';
            display.appendChild(eSpan);
            
            const caretSpan = document.createElement('span');
            caretSpan.className = 'formula-element';
            caretSpan.textContent = '^';
            display.appendChild(caretSpan);
            
            const openParen = document.createElement('span');
            openParen.className = 'formula-element';
            openParen.textContent = '(';
            display.appendChild(openParen);
            
            // Cr√©er un input pour le contenu de l'exposant
            const expInput = document.createElement('input');
            expInput.type = 'text';
            expInput.className = 'formula-input';
            expInput.placeholder = 'exposant';
            expInput.style.width = '80px';
            expInput.style.border = 'none';
            expInput.style.borderBottom = '1px solid #667eea';
            expInput.style.background = 'transparent';
            expInput.style.fontFamily = 'inherit';
            expInput.style.fontSize = '0.9em';
            
            expInput.addEventListener('focus', function() {
                activeFormulaInput = this;
            });
            expInput.addEventListener('click', function() {
                activeFormulaInput = this;
            });
            
            display.appendChild(expInput);
            
            const closeParen = document.createElement('span');
            closeParen.className = 'formula-element';
            closeParen.textContent = ')';
            display.appendChild(closeParen);
            
            // Focus sur l'input
            activeFormulaInput = expInput;
            expInput.focus();
        }

        function addElement(fIndex, type) {
            const display = document.getElementById(`formula-${fIndex}`);
            
            if (type === 'subscript' || type === 'superscript') {
                // V√©rifier si un input actif a du texte s√©lectionn√© (utiliser savedSelection si disponible)
                const input = activeFormulaInput && display.contains(activeFormulaInput) ? activeFormulaInput : null;
                
                if (input && savedSelection) {
                    // Utiliser la s√©lection sauvegard√©e
                    const { start, end, value } = savedSelection;
                    
                    if (start !== end) {
                        // Il y a une s√©lection - appliquer le formatage
                        const selectedText = value.substring(start, end);
                        const before = value.substring(0, start);
                        const after = value.substring(end);
                        
                        // Cr√©er le texte format√©
                        const tag = type === 'subscript' ? 'sub' : 'sup';
                        const formattedHTML = selectedText.split('').map(char => `<${tag}>${char}</${tag}>`).join('');
                        
                        // Cr√©er les nouveaux √©l√©ments
                        if (before) {
                            const beforeSpan = document.createElement('span');
                            beforeSpan.className = 'formula-element';
                            beforeSpan.textContent = before;
                            display.insertBefore(beforeSpan, input);
                        }
                        
                        const formattedSpan = document.createElement('span');
                        formattedSpan.className = 'formula-element';
                        formattedSpan.innerHTML = formattedHTML;
                        display.insertBefore(formattedSpan, input);
                        
                        if (after) {
                            const afterSpan = document.createElement('span');
                            afterSpan.className = 'formula-element';
                            afterSpan.textContent = after;
                            display.insertBefore(afterSpan, input);
                        }
                        
                        input.remove();
                        activeFormulaInput = null;
                        savedSelection = null;
                        return;
                    }
                }
                
                // Transformer le dernier √©l√©ment si pas de s√©lection
                const lastElement = display.lastElementChild;
                if (lastElement && (lastElement.tagName === 'INPUT' || lastElement.classList.contains('formula-element'))) {
                    const value = lastElement.value || lastElement.textContent;
                    if (value) {
                        lastElement.remove();
                        
                        const span = document.createElement('span');
                        span.className = 'formula-element';
                        
                        if (type === 'subscript') {
                            span.innerHTML = value.split('').map(char => `<sub>${char}</sub>`).join('');
                        } else {
                            span.innerHTML = value.split('').map(char => `<sup>${char}</sup>`).join('');
                        }
                        
                        display.appendChild(span);
                        return;
                    }
                }
                
                // Si pas d'√©l√©ment pr√©c√©dent, cr√©er un champ pour taper
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.className = 'formula-input';
                inputField.style.width = '60px';
                inputField.placeholder = type === 'subscript' ? 'indice' : 'exposant';
                
                // Event listeners pour tracker focus et s√©lection
                inputField.addEventListener('focus', function() {
                    activeFormulaInput = this;
                });
                inputField.addEventListener('click', function() {
                    activeFormulaInput = this;
                });
                inputField.addEventListener('select', function() {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                });
                inputField.addEventListener('mouseup', function() {
                    if (this.selectionStart !== this.selectionEnd) {
                        savedSelection = {
                            start: this.selectionStart,
                            end: this.selectionEnd,
                            value: this.value
                        };
                    }
                });
                inputField.addEventListener('keyup', function() {
                    if (this.selectionStart !== this.selectionEnd) {
                        savedSelection = {
                            start: this.selectionStart,
                            end: this.selectionEnd,
                            value: this.value
                        };
                    }
                });
                inputField.addEventListener('blur', function() {
                    if (this.value && !savedSelection) {
                        const span = document.createElement('span');
                        span.className = 'formula-element';
                        const tag = type === 'subscript' ? 'sub' : 'sup';
                        span.innerHTML = this.value.split('').map(char => `<${tag}>${char}</${tag}>`).join('');
                        this.replaceWith(span);
                    }
                });
                
                display.appendChild(inputField);
                inputField.focus();
            } else {
                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.className = 'formula-input';
                inputField.style.width = '40px';
                inputField.addEventListener('focus', function() {
                    activeFormulaInput = this;
                });
                inputField.addEventListener('click', function() {
                    activeFormulaInput = this;
                });
                inputField.addEventListener('select', function() {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                });
                inputField.addEventListener('mouseup', function() {
                    if (this.selectionStart !== this.selectionEnd) {
                        savedSelection = {
                            start: this.selectionStart,
                            end: this.selectionEnd,
                            value: this.value
                        };
                    }
                });
                inputField.addEventListener('keyup', function() {
                    if (this.selectionStart !== this.selectionEnd) {
                        savedSelection = {
                            start: this.selectionStart,
                            end: this.selectionEnd,
                            value: this.value
                        };
                    }
                });
                display.appendChild(inputField);
            }
        }

        function addFraction(fIndex) {
            const display = document.getElementById(`formula-${fIndex}`);
            const fraction = document.createElement('div');
            fraction.className = 'formula-fraction';
            
            // Num√©rateur
            const numerator = document.createElement('input');
            numerator.type = 'text';
            numerator.className = 'formula-input';
            numerator.placeholder = 'num√©rateur';
            numerator.style.borderBottom = '2px solid #333';
            numerator.style.width = '100px';
            numerator.setAttribute('data-fraction-part', 'numerator');
            
            // Tracker quand on clique ou focus sur le num√©rateur
            numerator.addEventListener('focus', function() {
                activeFormulaInput = this;
            });
            numerator.addEventListener('click', function() {
                activeFormulaInput = this;
            });
            numerator.addEventListener('select', function() {
                savedSelection = {
                    start: this.selectionStart,
                    end: this.selectionEnd,
                    value: this.value
                };
            });
            numerator.addEventListener('mouseup', function() {
                if (this.selectionStart !== this.selectionEnd) {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                }
            });
            numerator.addEventListener('keyup', function() {
                if (this.selectionStart !== this.selectionEnd) {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                }
            });
            
            // D√©nominateur
            const denominator = document.createElement('input');
            denominator.type = 'text';
            denominator.className = 'formula-input';
            denominator.placeholder = 'd√©nominateur';
            denominator.style.width = '100px';
            denominator.setAttribute('data-fraction-part', 'denominator');
            
            // Tracker quand on clique ou focus sur le d√©nominateur
            denominator.addEventListener('focus', function() {
                activeFormulaInput = this;
            });
            denominator.addEventListener('click', function() {
                activeFormulaInput = this;
            });
            denominator.addEventListener('select', function() {
                savedSelection = {
                    start: this.selectionStart,
                    end: this.selectionEnd,
                    value: this.value
                };
            });
            denominator.addEventListener('mouseup', function() {
                if (this.selectionStart !== this.selectionEnd) {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                }
            });
            denominator.addEventListener('keyup', function() {
                if (this.selectionStart !== this.selectionEnd) {
                    savedSelection = {
                        start: this.selectionStart,
                        end: this.selectionEnd,
                        value: this.value
                    };
                }
            });
            
            fraction.appendChild(numerator);
            fraction.appendChild(denominator);
            display.appendChild(fraction);
        }

        function clearFormula(fIndex) {
            document.getElementById(`formula-${fIndex}`).innerHTML = '';
            document.getElementById(`formula-explanation-${fIndex}`).classList.remove('show');
        }

        function getFormulaText(fIndex) {
            const display = document.getElementById(`formula-${fIndex}`);
            let text = '';
            
            // Map des caract√®res Unicode en indices vers chiffres normaux
            const subscriptMap = {
                '‚ÇÄ': '0', '‚ÇÅ': '1', '‚ÇÇ': '2', '‚ÇÉ': '3', '‚ÇÑ': '4',
                '‚ÇÖ': '5', '‚ÇÜ': '6', '‚Çá': '7', '‚Çà': '8', '‚Çâ': '9',
                '‚Çä': '+', '‚Çã': '-', '‚Çå': '=', '‚Çç': '(', '‚Çé': ')'
            };
            
            const superscriptMap = {
                '‚Å∞': '0', '¬π': '1', '¬≤': '2', '¬≥': '3', '‚Å¥': '4',
                '‚Åµ': '5', '‚Å∂': '6', '‚Å∑': '7', '‚Å∏': '8', '‚Åπ': '9',
                '‚Å∫': '+', '‚Åª': '-', '‚Åº': '=', '‚ÅΩ': '(', '‚Åæ': ')'
            };
            
            display.childNodes.forEach(node => {
                if (node.nodeType === Node.TEXT_NODE) {
                    text += node.textContent;
                } else if (node.classList && node.classList.contains('formula-element')) {
                    // Extraire le texte en g√©rant sub/sup
                    let content = node.textContent;
                    
                    // Convertir les caract√®res Unicode d'indice/exposant en caract√®res normaux
                    let converted = '';
                    for (let char of content) {
                        if (subscriptMap[char]) {
                            converted += subscriptMap[char];
                        } else if (superscriptMap[char]) {
                            converted += superscriptMap[char];
                        } else {
                            converted += char;
                        }
                    }
                    
                    text += converted;
                } else if (node.classList && node.classList.contains('formula-input')) {
                    text += node.value;
                } else if (node.classList && node.classList.contains('formula-fraction')) {
                    const inputs = node.querySelectorAll('input');
                    if (inputs.length === 2) {
                        text += inputs[0].value + '/' + inputs[1].value;
                    }
                }
            });
            
            return text;
        }

        function checkFormula(fIndex) {
            const userFormula = getFormulaText(fIndex);
            const correctFormulas = formulesData[fIndex].correct;
            
            // Fonction de normalisation avanc√©e
            const normalize = (str) => {
                let s = str.replace(/\s/g, ''); // Retirer espaces
                
                // Convertir tous les symboles de multiplication en *
                s = s.replace(/[√ó¬∑]/g, '*');
                
                // Convertir tous les symboles de division en /
                s = s.replace(/[√∑]/g, '/');
                
                // Normaliser les exposants
                // e^(-Œªt) ou e^-Œªt ou e-Œªt -> tous deviennent e^(-Œªt)
                
                // D'abord, g√©rer e sans ^ coll√©: e-Œªt -> e^-Œªt
                s = s.replace(/e-([a-z‚ÇÄ-‚ÇâŒªŒºœÄŒ±Œ≤Œ≥œâŒ∏ŒµœÅœÉœÑ])/g, 'e^-$1');
                
                // Ensuite normaliser les parenth√®ses
                // e^-Œªt -> e^(-Œªt)
                s = s.replace(/e\^-([a-z‚ÇÄ-‚ÇâŒªŒºœÄŒ±Œ≤Œ≥œâŒ∏ŒµœÅœÉœÑ*]+)/g, 'e^(-$1)');
                
                // Retirer les parenth√®ses redondantes: e^((-Œªt)) -> e^(-Œªt)
                s = s.replace(/\(\(([^)]+)\)\)/g, '($1)');
                
                // Normaliser ln(2) et ln2
                s = s.replace(/ln\(2\)/g, 'ln2');
                s = s.replace(/ln\((\d+)\)/g, 'ln$1');
                
                return s.toLowerCase();
            };
            
            // Fonction pour comparer deux formules math√©matiquement
            const areEquivalent = (user, correct) => {
                const u = normalize(user);
                const c = normalize(correct);
                
                // Comparaison directe
                if (u === c) return true;
                
                // G√©rer la multiplication implicite: ajouter * entre lettre et lettre/chiffre
                const addImplicitMult = (s) => {
                    // c√óT devient c*T, cT devient c*T aussi
                    return s.replace(/([a-z‚ÇÄ-‚Çâ])([a-z])/g, '$1*$2');
                };
                
                const uImpl = addImplicitMult(u);
                const cImpl = addImplicitMult(c);
                
                if (uImpl === cImpl) return true;
                
                // V√©rifier si l'√©quation est invers√©e (T=1/f √©quivalent √† f=1/T)
                const invertEquation = (s) => {
                    // Pattern: A=1/B ou A=B/C
                    const simpleInverse = s.match(/^([^=]+)=1\/([^/]+)$/);
                    if (simpleInverse) {
                        const [, left, right] = simpleInverse;
                        return `${right}=1/${left}`;
                    }
                    
                    const divPattern = s.match(/^([^=]+)=([^/]+)\/([^/]+)$/);
                    if (divPattern) {
                        const [, left, num, den] = divPattern;
                        // A=B/C peut devenir C=B/A ou A*C=B
                        return null; // On ne peut pas inverser simplement une division g√©n√©rale
                    }
                    
                    return null;
                };
                
                const uInverted = invertEquation(uImpl);
                const cInverted = invertEquation(cImpl);
                
                if (uInverted && uInverted === cImpl) return true;
                if (cInverted && cInverted === uImpl) return true;
                
                // Pour les multiplications, v√©rifier ordre invers√©
                // Ex: Œª=T*c et Œª=c*T sont √©quivalents
                const multiplicationPattern = /([^=]+)=([^*+\-/]+)\*([^*+\-/]+)$/;
                const userMatch = uImpl.match(multiplicationPattern);
                const correctMatch = cImpl.match(multiplicationPattern);
                
                if (userMatch && correctMatch) {
                    const [, uLeft, uA, uB] = userMatch;
                    const [, cLeft, cA, cB] = correctMatch;
                    
                    // Comparer si m√™me c√¥t√© gauche et (A*B === A*B ou A*B === B*A)
                    if (uLeft === cLeft) {
                        if ((uA === cA && uB === cB) || (uA === cB && uB === cA)) {
                            return true;
                        }
                    }
                }
                
                // Pour les divisions, accepter diff√©rentes formes
                // Œª=c/T, Œª=(c)/(T), Œª=c√∑T sont √©quivalents
                const divPattern1 = /([^=]+)=([^/]+)\/(.+)/;
                const divPattern2 = /([^=]+)=\(([^)]+)\)\/\(([^)]+)\)/;
                
                const uDiv = uImpl.match(divPattern1) || uImpl.match(divPattern2);
                const cDiv = cImpl.match(divPattern1) || cImpl.match(divPattern2);
                
                if (uDiv && cDiv) {
                    const [, uLeft2, uNum, uDen] = uDiv;
                    const [, cLeft2, cNum, cDen] = cDiv;
                    
                    if (uLeft2 === cLeft2 && uNum === cNum && uDen === cDen) {
                        return true;
                    }
                }
                
                return false;
            };
            
            const isCorrect = correctFormulas.some(cf => areEquivalent(userFormula, cf));
            
            const explanation = document.getElementById(`formula-explanation-${fIndex}`);
            
            if (formulesAnswers[fIndex] === null) {
                stats.formulesAnswered++;
                if (isCorrect) {
                    stats.formulesCorrect++;
                } else {
                    // Sauvegarder si incorrect
                    if (!stats.savedQuestions.some(q => q.text === formulesData[fIndex].question)) {
                        stats.savedQuestions.push({
                            type: 'formule',
                            text: formulesData[fIndex].question,
                            answer: formulesData[fIndex].correct[0],
                            explanation: formulesData[fIndex].explanation
                        });
                    }
                }
                formulesAnswers[fIndex] = userFormula;
                saveStats();
                updateStats();
                updateFormulesProgress();
                updateSavedList();
            }
            
            if (isCorrect) {
                explanation.innerHTML = `<strong style="color: green;">‚úì Correct !</strong> ${formulesData[fIndex].explanation}`;
            } else {
                explanation.innerHTML = `<strong style="color: red;">‚úó Incorrect</strong> La formule correcte est : ${formulesData[fIndex].correct[0]}<br>${formulesData[fIndex].explanation}`;
            }
            explanation.classList.add('show');
        }

        function updateFormulesProgress() {
            const answered = formulesAnswers.filter(a => a !== null).length;
            const percent = Math.round((answered / formulesData.length) * 100);
            const fill = document.getElementById('formulesProgress');
            fill.style.width = percent + '%';
            fill.textContent = `${answered}/${formulesData.length} (${percent}%)`;
        }

        // ==================== EXERCISES ====================
        function createExercises() {
            document.getElementById('exercisesContainer').innerHTML = exercisesData.map((ex, index) => `
                <div class="exercise-card">
                    <div class="exercise-title">üìê ${ex.title}</div>
                    <div class="exercise-question">${ex.question}</div>
                    
                    <div class="calculation-area">
                        <div class="calculation-label">üí≠ Zone de calcul :</div>
                        <textarea class="calculation-input" 
                                  id="calc-${index}" 
                                  placeholder="√âcrivez vos calculs ici...&#10;Exemple :&#10;f = 1/T&#10;f = 1/0,002&#10;f = 500"></textarea>
                        
                        <div class="result-area">
                            <div class="result-group">
                                <div class="result-label">R√©sultat :</div>
                                <input type="text" class="result-input" id="result-${index}" placeholder="ex: 500">
                            </div>
                            <div class="result-group">
                                <div class="result-label">Unit√© :</div>
                                <input type="text" class="unit-input" id="unit-${index}" placeholder="ex: Hz">
                            </div>
                        </div>
                    </div>
                    
                    <button class="show-solution-btn" onclick="toggleSolution(${index})">
                        üí° Voir la solution
                    </button>
                    <div class="solution" id="solution-${index}">
                        <strong>Solution :</strong><br>
                        ${ex.solution.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `).join('');
        }

        function toggleSolution(index) {
            const solution = document.getElementById(`solution-${index}`);
            solution.classList.toggle('show');
        }

        // ==================== SAVED QUESTIONS ====================
        function updateSavedList() {
            const container = document.getElementById('savedList');
            if (stats.savedQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Aucune question sauvegard√©e pour le moment.</p>';
                return;
            }
            
            container.innerHTML = stats.savedQuestions.map((q, index) => `
                <div class="saved-item">
                    <strong>${q.type.toUpperCase()}</strong><br>
                    <div style="margin: 10px 0;">${q.text}</div>
                    <div style="color: green;"><strong>R√©ponse:</strong> ${q.answer}</div>
                    ${q.explanation ? `<div style="margin-top: 5px; font-size: 0.9em;">${q.explanation}</div>` : ''}
                    <button class="remove-btn" onclick="removeSaved(${index})">Supprimer</button>
                </div>
            `).join('');
        }

        function removeSaved(index) {
            stats.savedQuestions.splice(index, 1);
            saveStats();
            updateStats();
            updateSavedList();
        }

        // ==================== START ====================
        loadCardDifficulties();
        init();
    </script>
</body>
</html>