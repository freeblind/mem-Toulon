<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©cup√©ration des sch√©mas - Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #667eea;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 400px;
        }
        .download-link {
            display: inline-block;
            margin: 10px 0;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagnostic et R√©cup√©ration des Sch√©mas</h1>
        
        <div class="section">
            <h3>√âtape 1 : Diagnostic</h3>
            <button onclick="checkAllStorage()">üîé Analyser le stockage</button>
            <div id="diagnosticResult"></div>
        </div>

        <div class="section">
            <h3>√âtape 2 : Extraction</h3>
            <button onclick="extractFromIndexedDB()">üì¶ Extraire depuis IndexedDB</button>
            <button onclick="extractFromLocalStorage()">üíæ Extraire depuis localStorage</button>
            <div id="extractionResult"></div>
        </div>

        <div class="section">
            <h3>√âtape 3 : Donn√©es r√©cup√©r√©es</h3>
            <div id="dataDisplay"></div>
        </div>

        <div class="section">
            <h3>√âtape 4 : Export</h3>
            <button onclick="downloadAsJSON()">‚¨áÔ∏è T√©l√©charger les donn√©es JSON</button>
            <div id="exportResult"></div>
        </div>
    </div>

    <script>
        let recoveredData = null;

        async function checkAllStorage() {
            const result = document.getElementById('diagnosticResult');
            result.innerHTML = '<p class="info">Analyse en cours...</p>';
            
            let report = '<h4>Rapport de diagnostic :</h4>';
            
            // V√©rifier localStorage
            try {
                const lsKeys = Object.keys(localStorage);
                report += `<p>‚úÖ localStorage accessible - ${lsKeys.length} cl√©s trouv√©es</p>`;
                
                if (lsKeys.length > 0) {
                    report += '<p>Cl√©s pr√©sentes :</p><ul>';
                    lsKeys.forEach(key => {
                        const size = localStorage.getItem(key)?.length || 0;
                        report += `<li><strong>${key}</strong> (${size} caract√®res)</li>`;
                    });
                    report += '</ul>';
                }
            } catch (e) {
                report += `<p class="error">‚ùå Erreur localStorage : ${e.message}</p>`;
            }

            // V√©rifier IndexedDB
            try {
                const databases = await indexedDB.databases();
                report += `<p>‚úÖ IndexedDB accessible - ${databases.length} base(s) trouv√©e(s)</p>`;
                
                if (databases.length > 0) {
                    report += '<p>Bases de donn√©es :</p><ul>';
                    databases.forEach(db => {
                        report += `<li><strong>${db.name}</strong> (version ${db.version})</li>`;
                    });
                    report += '</ul>';
                }

                // Essayer d'ouvrir AnatomieDB
                await checkAnatomieDB(report);
                
            } catch (e) {
                report += `<p class="error">‚ùå Erreur IndexedDB : ${e.message}</p>`;
            }

            result.innerHTML = report;
        }

        async function checkAnatomieDB(report) {
            return new Promise((resolve) => {
                const request = indexedDB.open('AnatomieDB', 1);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    const stores = Array.from(db.objectStoreNames);
                    
                    document.getElementById('diagnosticResult').innerHTML += 
                        `<p class="success">‚úÖ Base AnatomieDB trouv√©e avec ${stores.length} store(s) : ${stores.join(', ')}</p>`;
                    
                    if (stores.includes('schemas')) {
                        const transaction = db.transaction(['schemas'], 'readonly');
                        const store = transaction.objectStore('schemas');
                        const countRequest = store.count();
                        
                        countRequest.onsuccess = () => {
                            document.getElementById('diagnosticResult').innerHTML += 
                                `<p class="success">üéØ ${countRequest.result} sch√©ma(s) trouv√©(s) dans IndexedDB !</p>`;
                        };
                    }
                    
                    db.close();
                    resolve();
                };
                
                request.onerror = () => {
                    document.getElementById('diagnosticResult').innerHTML += 
                        `<p class="error">‚ùå Impossible d'ouvrir AnatomieDB</p>`;
                    resolve();
                };
            });
        }

        async function extractFromIndexedDB() {
            const result = document.getElementById('extractionResult');
            result.innerHTML = '<p class="info">Extraction en cours...</p>';

            try {
                const request = indexedDB.open('AnatomieDB', 1);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('schemas')) {
                        result.innerHTML = '<p class="error">‚ùå Aucun store "schemas" trouv√©</p>';
                        db.close();
                        return;
                    }

                    const transaction = db.transaction(['schemas'], 'readonly');
                    const store = transaction.objectStore('schemas');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const schemas = getAllRequest.result;
                        
                        if (schemas && schemas.length > 0) {
                            recoveredData = schemas;
                            result.innerHTML = `<p class="success">‚úÖ ${schemas.length} sch√©ma(s) extrait(s) avec succ√®s !</p>`;
                            displayData(schemas);
                            
                            // Sauvegarder automatiquement dans localStorage
                            localStorage.setItem('anatomie_schemas', JSON.stringify(schemas));
                            result.innerHTML += '<p class="success">‚úÖ Donn√©es sauvegard√©es dans localStorage</p>';
                        } else {
                            result.innerHTML = '<p class="error">‚ùå Aucun sch√©ma trouv√© dans IndexedDB</p>';
                        }
                        
                        db.close();
                    };
                    
                    getAllRequest.onerror = () => {
                        result.innerHTML = '<p class="error">‚ùå Erreur lors de la lecture des donn√©es</p>';
                        db.close();
                    };
                };
                
                request.onerror = () => {
                    result.innerHTML = '<p class="error">‚ùå Impossible d\'ouvrir la base de donn√©es</p>';
                };
                
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Erreur : ${e.message}</p>`;
            }
        }

        function extractFromLocalStorage() {
            const result = document.getElementById('extractionResult');
            
            try {
                const keys = ['anatomie_schemas', 'schemas', 'anatomieSchemas'];
                let found = false;
                
                for (const key of keys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const schemas = JSON.parse(data);
                        if (Array.isArray(schemas) && schemas.length > 0) {
                            recoveredData = schemas;
                            result.innerHTML = `<p class="success">‚úÖ ${schemas.length} sch√©ma(s) trouv√©(s) dans localStorage (cl√©: ${key})</p>`;
                            displayData(schemas);
                            found = true;
                            break;
                        }
                    }
                }
                
                if (!found) {
                    result.innerHTML = '<p class="error">‚ùå Aucune donn√©e trouv√©e dans localStorage</p>';
                }
                
            } catch (e) {
                result.innerHTML = `<p class="error">‚ùå Erreur : ${e.message}</p>`;
            }
        }

        function displayData(schemas) {
            const display = document.getElementById('dataDisplay');
            
            let html = `<h4>üìä ${schemas.length} sch√©ma(s) r√©cup√©r√©(s) :</h4><ul>`;
            
            schemas.forEach((schema, index) => {
                const markerCount = schema.markers ? schema.markers.length : 0;
                const hasImage = schema.image ? '‚úÖ' : '‚ùå';
                html += `<li>
                    <strong>${schema.name || 'Sch√©ma ' + (index + 1)}</strong><br>
                    ${markerCount} marqueur(s) | Image: ${hasImage}
                </li>`;
            });
            
            html += '</ul>';
            
            html += '<h4>Aper√ßu JSON :</h4>';
            html += `<pre>${JSON.stringify(schemas, null, 2).substring(0, 2000)}${schemas.length > 100 ? '...' : ''}</pre>`;
            
            display.innerHTML = html;
        }

        function downloadAsJSON() {
            if (!recoveredData) {
                document.getElementById('exportResult').innerHTML = 
                    '<p class="error">‚ùå Aucune donn√©e √† exporter. Lancez d\'abord l\'extraction.</p>';
                return;
            }

            const dataStr = JSON.stringify(recoveredData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `schemas-anatomie-backup-${Date.now()}.json`;
            a.click();
            
            document.getElementById('exportResult').innerHTML = 
                '<p class="success">‚úÖ Fichier JSON t√©l√©charg√© !</p>';
        }

        // Auto-diagnostic au chargement
        window.onload = () => {
            checkAllStorage();
        };
    </script>
</body>
</html>
