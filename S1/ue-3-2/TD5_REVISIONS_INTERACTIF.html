<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TD5 - R√©visions UE 3.2 S1</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .progress-bar { background: #f0f0f0; height: 8px; margin: 20px 30px; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%); width: 0%; transition: width 0.5s ease; }
        .question-container { padding: 30px; display: none; }
        .question-container.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .question-header { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid #1e3c72; }
        .question-number { color: #1e3c72; font-weight: bold; font-size: 1.2em; margin-bottom: 10px; }
        .question-text { font-size: 1.1em; line-height: 1.6; color: #333; }
        .answer-input { width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1em; font-family: inherit; resize: vertical; transition: border-color 0.3s; }
        .answer-input:focus { outline: none; border-color: #1e3c72; }
        .button-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s; font-weight: 600; }
        .btn-primary { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(30, 60, 114, 0.4); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }
        .feedback.show { display: block; }
        .feedback.correct { background: #d4edda; border: 2px solid #28a745; color: #155724; }
        .feedback.incorrect { background: #f8d7da; border: 2px solid #dc3545; color: #721c24; }
        .feedback.accepted { background: #d1ecf1; border: 2px solid #17a2b8; color: #0c5460; }
        .solution { margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; }
        .solution h4 { color: #856404; margin-bottom: 10px; }
        .mcq-options { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; }
        .mcq-option { display: flex; align-items: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; cursor: pointer; transition: all 0.3s; }
        .mcq-option:hover { border-color: #1e3c72; background: #f8f9fa; }
        .mcq-option input { width: 20px; height: 20px; margin-right: 15px; cursor: pointer; }
        .mcq-option.selected { border-color: #1e3c72; background: #e7f1ff; }
        .navigation { display: flex; justify-content: space-between; padding: 30px; background: #f8f9fa; border-top: 1px solid #e0e0e0; }
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th, td { padding: 15px; text-align: left; border: 2px solid #e0e0e0; }
        th { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; font-weight: 600; }
        td input[type="text"], td select { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 0.95em; }
        td input:focus, td select:focus { outline: none; border-color: #1e3c72; }
        .solution-row { background: #fff3cd !important; font-style: italic; color: #856404; display: none; }
        .solution-row.show { display: table-row; }
        .stats { padding: 30px; background: #f8f9fa; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #1e3c72; }
        .stat-label { color: #666; margin-top: 10px; }
        .schema-upload { margin-top: 20px; padding: 30px; border: 3px dashed #1e3c72; border-radius: 15px; background: #f8f9fa; }
        .upload-area { text-align: center; padding: 40px; cursor: pointer; }
        .upload-area:hover { background: #e7f1ff; }
        .upload-icon { font-size: 3em; color: #1e3c72; margin-bottom: 15px; }
        .image-container-wrapper { position: relative; display: inline-block; max-width: 100%; }
        .schema-image-display { display: block; max-width: 100%; height: auto; }
        .annotation-canvas { position: absolute; top: 0; left: 0; cursor: crosshair; z-index: 10; }
        .label-item { display: grid; grid-template-columns: 60px 1fr 80px; gap: 15px; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 12px; }
        .label-number-display { width: 50px; height: 50px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.2em; }
        .label-input { padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 1em; width: 100%; }
        .delete-label { padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        @media (max-width: 768px) { .header h1 { font-size: 1.5em; } .button-group { flex-direction: column; } .btn { width: 100%; } .navigation { flex-direction: column; gap: 15px; } table { font-size: 0.85em; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö TD N¬∞5 - R√âVISIONS</h1>
            <p>UE 3.2 S1 - Physique appliqu√©e et technologie en imagerie radiologique</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Mercredi 17 d√©cembre 2025</p>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

        <!-- Question 1 -->
        <div class="question-container active" id="question1">
            <div class="question-header">
                <div class="question-number">Question 1</div>
                <div class="question-text">
                    <strong>D√©finition des rayons X et rayonnements ionisants</strong><br><br>
                    1. D√©finissez les rayons X<br>
                    2. Expliquez pourquoi les rayons X sont dits ionisants
                </div>
            </div>
            <textarea class="answer-input" id="answer1" placeholder="Tapez votre r√©ponse ici..."></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(1)">V√©rifier ma r√©ponse</button>
                <button class="btn btn-success" onclick="acceptAnswer(1)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback1"></div>
        </div>

        <!-- Question 2 -->
        <div class="question-container" id="question2">
            <div class="question-header">
                <div class="question-number">Question 2</div>
                <div class="question-text">
                    <strong>Types d'interaction √©mettrices de rayons X</strong><br><br>
                    Nommez les 2 types d'interaction √©mettrices de rayons X et expliquez le m√©canisme de chacune.
                </div>
            </div>
            <div class="schema-upload">
                <div class="upload-area" id="uploadZone2" onclick="document.getElementById('imageUpload2').click()">
                    <div class="upload-icon">üì§</div>
                    <p><strong>Cliquez pour uploader un sch√©ma (optionnel)</strong></p>
                </div>
                <input type="file" id="imageUpload2" accept="image/*" style="display: none;" onchange="loadSchemaImage(2, event)">
                <div id="imageWorkspace2" style="display: none; margin-top: 20px;">
                    <div class="image-container-wrapper">
                        <img id="schemaImage2" class="schema-image-display">
                        <canvas id="annotationCanvas2" class="annotation-canvas"></canvas>
                    </div>
                    <div style="margin-top: 20px;"><h4>Annotations</h4><div id="labelsList2"></div></div>
                    <button class="btn btn-primary" onclick="addManualQuestion(2)" style="margin-top: 10px;">‚ûï Ajouter annotation</button>
                    <button class="btn btn-danger" onclick="clearAllLabels(2)" style="margin-top: 10px;">üóëÔ∏è Effacer</button>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h4>Ou r√©pondez directement :</h4>
                <textarea class="answer-input" id="answer2" placeholder="1) Interaction √©lectron-noyau (effet de freinage) :&#10;&#10;2) Interaction √©lectron-√©lectron (r√©arrangement √©lectronique) :"></textarea>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(2)">V√©rifier ma r√©ponse</button>
                <button class="btn btn-success" onclick="acceptAnswer(2)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback2"></div>
        </div>

        <!-- Question 3 -->
        <div class="question-container" id="question3">
            <div class="question-header">
                <div class="question-number">Question 3</div>
                <div class="question-text">
                    <strong>Annotation du sch√©ma du tube √† rayons X</strong><br><br>
                    Annotez le sch√©ma en reportant en face de chaque chiffre la r√©ponse attendue.
                </div>
            </div>
            <div class="schema-upload">
                <div class="upload-area" id="uploadZone3" onclick="document.getElementById('imageUpload3').click()">
                    <div class="upload-icon">üì§</div>
                    <p><strong>Cliquez pour uploader le sch√©ma du tube</strong></p>
                </div>
                <input type="file" id="imageUpload3" accept="image/*" style="display: none;" onchange="loadSchemaImage(3, event)">
                <div id="imageWorkspace3" style="display: none; margin-top: 20px;">
                    <div class="image-container-wrapper">
                        <img id="schemaImage3" class="schema-image-display">
                        <canvas id="annotationCanvas3" class="annotation-canvas"></canvas>
                    </div>
                    <div style="margin-top: 20px;"><h4>Annotations</h4><div id="labelsList3"></div></div>
                    <button class="btn btn-primary" onclick="addManualQuestion(3)" style="margin-top: 10px;">‚ûï Ajouter</button>
                    <button class="btn btn-danger" onclick="clearAllLabels(3)" style="margin-top: 10px;">üóëÔ∏è Effacer</button>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <h4>Ou compl√©tez le tableau :</h4>
                <div class="table-container">
                    <table>
                        <thead><tr><th>N¬∞</th><th>R√©ponse</th><th>N¬∞</th><th>R√©ponse</th></tr></thead>
                        <tbody>
                            <tr><td><strong>1</strong></td><td><input type="text" id="q3_1" placeholder="..."></td><td><strong>6</strong></td><td><input type="text" id="q3_6" placeholder="..."></td></tr>
                            <tr class="solution-row"><td>üí°</td><td>Cathode</td><td>üí°</td><td>Rayons X</td></tr>
                            <tr><td><strong>2</strong></td><td><input type="text" id="q3_2" placeholder="..."></td><td><strong>7</strong></td><td><input type="text" id="q3_7" placeholder="..."></td></tr>
                            <tr class="solution-row"><td>üí°</td><td>Filament</td><td>üí°</td><td>Syst√®me de refroidissement</td></tr>
                            <tr><td><strong>3</strong></td><td><input type="text" id="q3_3" placeholder="..."></td><td><strong>8</strong></td><td><input type="text" id="q3_8" placeholder="..."></td></tr>
                            <tr class="solution-row"><td>üí°</td><td>Ddp</td><td>üí°</td><td>Anode</td></tr>
                            <tr><td><strong>4</strong></td><td><input type="text" id="q3_4" placeholder="..."></td><td><strong>9</strong></td><td><input type="text" id="q3_9" placeholder="..."></td></tr>
                            <tr class="solution-row"><td>üí°</td><td>Filtre</td><td>üí°</td><td>Enceinte</td></tr>
                            <tr><td><strong>5</strong></td><td><input type="text" id="q3_5" placeholder="..."></td><td><strong>10</strong></td><td><input type="text" id="q3_10" placeholder="..."></td></tr>
                            <tr class="solution-row"><td>üí°</td><td>Diaphragme</td><td>üí°</td><td>Gaine plomb√©e</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkTable3()">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(3)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback3"></div>
        </div>

        <!-- Question 4 -->
        <div class="question-container" id="question4">
            <div class="question-header">
                <div class="question-number">Question 4</div>
                <div class="question-text">
                    <strong>Param√®tres d'exposition en imagerie de projection</strong><br><br>
                    Citez les 3 param√®tres d'exposition et pr√©cisez leur influence sur le faisceau de rayons X.
                </div>
            </div>
            <textarea class="answer-input" id="answer4" placeholder="1) Premier param√®tre :&#10;&#10;2) Deuxi√®me param√®tre :&#10;&#10;3) Troisi√®me param√®tre :"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(4)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(4)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback4"></div>
        </div>

        <!-- Question 5 -->
        <div class="question-container" id="question5">
            <div class="question-header">
                <div class="question-number">Question 5</div>
                <div class="question-text">
                    <strong>Effet photo-√©lectrique</strong><br><br>
                    Expliquez l'effet photo-√©lectrique.
                </div>
            </div>
            <textarea class="answer-input" id="answer5" placeholder="Expliquez le m√©canisme de l'effet photo√©lectrique..."></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(5)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(5)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback5"></div>
        </div>

        <!-- Question 6 -->
        <div class="question-container" id="question6">
            <div class="question-header">
                <div class="question-number">Question 6</div>
                <div class="question-text">
                    <strong>Capteur plan</strong><br><br>
                    1. Citez les 2 parties composant un capteur plan<br>
                    2. Pr√©cisez le r√¥le de chacune
                </div>
            </div>
            <textarea class="answer-input" id="answer6" placeholder="1) Les 2 parties :&#10;&#10;2) Leurs r√¥les :"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(6)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(6)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback6"></div>
        </div>

        <!-- Question 7 -->
        <div class="question-container" id="question7">
            <div class="question-header">
                <div class="question-number">Question 7</div>
                <div class="question-text">
                    <strong>√âchelle d'Hounsfield et fen√™trage</strong><br><br>
                    1. Expliquez le concept de l'√©chelle d'Hounsfield (valeur de r√©f√©rence)<br>
                    2. Les 3 zones de l'√©chelle<br>
                    3. Le concept du fen√™trage<br>
                    4. Les 2 param√®tres du fen√™trage
                </div>
            </div>
            <textarea class="answer-input" id="answer7" style="min-height: 200px;" placeholder="1) √âchelle d'Hounsfield :&#10;&#10;2) Les 3 zones :&#10;&#10;3) Fen√™trage :&#10;&#10;4) Param√®tres :"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(7)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(7)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback7"></div>
        </div>

        <!-- Question 8 -->
        <div class="question-container" id="question8">
            <div class="question-header">
                <div class="question-number">Question 8 - Tableau</div>
                <div class="question-text">
                    <strong>Param√®tres scanographiques</strong><br><br>
                    Cochez acquisition ou reconstruction pour chaque param√®tre.
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th>Param√®tre</th><th style="text-align:center;">Acquisition</th><th style="text-align:center;">Reconstruction</th></tr></thead>
                    <tbody>
                        <tr><td><strong>Tension (kV)</strong></td><td style="text-align:center;"><input type="radio" name="q8_1" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_1" value="rec"></td></tr>
                        <tr><td><strong>DFOV</strong></td><td style="text-align:center;"><input type="radio" name="q8_2" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_2" value="rec"></td></tr>
                        <tr><td><strong>√âpaisseur nominale de coupe</strong></td><td style="text-align:center;"><input type="radio" name="q8_3" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_3" value="rec"></td></tr>
                        <tr><td><strong>Incr√©ment</strong></td><td style="text-align:center;"><input type="radio" name="q8_4" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_4" value="rec"></td></tr>
                        <tr><td><strong>Charge (mA)</strong></td><td style="text-align:center;"><input type="radio" name="q8_5" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_5" value="rec"></td></tr>
                        <tr><td><strong>Filtres</strong></td><td style="text-align:center;"><input type="radio" name="q8_6" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_6" value="rec"></td></tr>
                        <tr><td><strong>Collimation</strong></td><td style="text-align:center;"><input type="radio" name="q8_7" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_7" value="rec"></td></tr>
                        <tr><td><strong>Pitch</strong></td><td style="text-align:center;"><input type="radio" name="q8_8" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_8" value="rec"></td></tr>
                        <tr><td><strong>SFOV</strong></td><td style="text-align:center;"><input type="radio" name="q8_9" value="acq"></td><td style="text-align:center;"><input type="radio" name="q8_9" value="rec"></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkTable8()">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(8)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback8"></div>
        </div>

        <!-- Question 9 -->
        <div class="question-container" id="question9">
            <div class="question-header">
                <div class="question-number">Question 9</div>
                <div class="question-text">
                    <strong>Filtres de reconstruction</strong><br><br>
                    Citez les 3 familles de filtres de reconstruction.
                </div>
            </div>
            <textarea class="answer-input" id="answer9" placeholder="1)&#10;&#10;2)&#10;&#10;3)"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(9)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(9)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback9"></div>
        </div>

        <!-- Question 10 -->
        <div class="question-container" id="question10">
            <div class="question-header">
                <div class="question-number">Question 10 - Appariement</div>
                <div class="question-text">
                    <strong>D√©finitions scanographiques</strong><br><br>
                    Associez chaque d√©finition au terme correspondant.
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead><tr><th style="width:70%;">D√©finition</th><th>R√©ponse</th></tr></thead>
                    <tbody>
                        <tr><td>Forme adapt√©e √† la morphologie du patient ‚Äì Homog√©n√©iser l'irradiation</td><td><select id="q10_1"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Tube-d√©tecteur en rotation continue et table en mouvement</td><td><select id="q10_2"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Donn√©es brutes de l'image</td><td><select id="q10_3"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Profil d'att√©nuation pour un angle de rotation donn√©</td><td><select id="q10_4"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Limite les p√©nombres radiologiques ‚Äì Affine le profil de coupe</td><td><select id="q10_5"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Convertit l'att√©nuation des RX en signal √©lectrique</td><td><select id="q10_6"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Ensemble des profils d'att√©nuation cumul√©s</td><td><select id="q10_7"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Tube-d√©tecteur fixe et table en mouvement ‚Äì Image de rep√©rage</td><td><select id="q10_8"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                        <tr><td>Situ√©e apr√®s les filtrations ‚Äì D√©limite l'ouverture du champ</td><td><select id="q10_9"><option value="">--</option><option>Filtre Papillon</option><option>Mode h√©lico√Ødal</option><option>Raw Data</option><option>Projection</option><option>Collimation secondaire</option><option>D√©tecteur secondaire</option><option>Sinogramme</option><option>Mode radio</option><option>Collimation primaire</option></select></td></tr>
                    </tbody>
                </table>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkMatching()">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(10)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback10"></div>
        </div>

        <!-- Question 11 -->
        <div class="question-container" id="question11">
            <div class="question-header">
                <div class="question-number">Question 11</div>
                <div class="question-text">
                    <strong>Indicateurs de doses</strong><br><br>
                    Citez les indicateurs de doses et leur unit√© :<br>
                    1. En imagerie de projection<br>
                    2. Au scanner
                </div>
            </div>
            <textarea class="answer-input" id="answer11" placeholder="1) Imagerie de projection :&#10;&#10;2) Scanner :"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(11)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(11)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback11"></div>
        </div>

        <!-- Question 12 -->
        <div class="question-container" id="question12">
            <div class="question-header">
                <div class="question-number">Question 12</div>
                <div class="question-text">
                    <strong>Crit√®res de qualit√© des images en scanographie</strong><br><br>
                    Citez les 4 crit√®res de qualit√©.
                </div>
            </div>
            <textarea class="answer-input" id="answer12" placeholder="1)&#10;&#10;2)&#10;&#10;3)&#10;&#10;4)"></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer(12)">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(12)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback12"></div>
        </div>

        <!-- Question 13 - Vrai/Faux -->
        <div class="question-container" id="question13">
            <div class="question-header">
                <div class="question-number">Question 13 - Vrai/Faux</div>
                <div class="question-text"><strong>NRD - Niveaux de R√©f√©rence Diagnostique</strong></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>1. NRD signifie Niveau de R√©f√©rence Diagnostique</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_1" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_1" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>2. Les NRD sont des indicateurs dosim√©triques permettant d'identifier des actions d'optimisation</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_2" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_2" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>3. Les NRD sont √©tablis pour tous les actes radiologiques</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_3" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_3" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>4. Les NRD sont recueillis annuellement et transmis √† l'IRSN</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_4" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_4" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>5. Les NRD en radiologie sont recueillis pour 10 patients sans tenir compte de l'IMC</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_5" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_5" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>6. Les NRD correspondent au 75√®me percentile de l'ensemble des NRL</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_6" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_6" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>7. VGD signifie Valeur Guide Diagnostique</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_7" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_7" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>8. La VGD correspond √† la m√©diane du nombre d'actes r√©alis√©s en France</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_8" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_8" value="false"><span>FAUX</span></label></div>
            </div>
            <div style="margin-bottom: 15px;">
                <div style="padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px;"><strong>9. NRL signifie Niveau de R√©f√©rence Local</strong></div>
                <div class="mcq-options" style="flex-direction: row; gap: 20px;"><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_9" value="true"><span>VRAI</span></label><label class="mcq-option" style="flex:1;"><input type="radio" name="q13_9" value="false"><span>FAUX</span></label></div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkTrueFalse13()">V√©rifier</button>
                <button class="btn btn-success" onclick="acceptAnswer(13)">Consid√©rer comme bonne</button>
            </div>
            <div class="feedback" id="feedback13"></div>
        </div>

        <!-- Question 14 - Extras -->
        <div class="question-container" id="question14">
            <div style="padding: 40px;">
                <h2 style="color: #1e3c72; text-align: center; margin-bottom: 30px;">üìö Sch√©mas suppl√©mentaires</h2>
                <div id="extrasList"></div>
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="addExtra()">‚ûï Ajouter un sch√©ma</button>
                    <button class="btn btn-primary" onclick="addTextOnly()" style="margin-left: 15px;">üìù Ajouter questions</button>
                </div>
            </div>
        </div>

        <!-- Question 15 - Export -->
        <div class="question-container" id="question15">
            <div style="padding: 40px; text-align: center; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border-radius: 15px;">
                <h2 style="margin-bottom: 20px;">üì• Exporter mes r√©ponses</h2>
                <p style="margin-bottom: 30px;">G√©n√©rer un fichier HTML contenant toutes vos r√©ponses</p>
                <button class="btn" style="background: white; color: #1e3c72; font-size: 1.2em; padding: 15px 40px;" onclick="exportHTML()">üåê EXPORTER EN HTML</button>
            </div>
        </div>

        <!-- Question 16 - Stats -->
        <div class="question-container" id="question16">
            <div class="stats">
                <h2>üéâ Statistiques</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-value" id="correctAnswers">0</div><div class="stat-label">R√©ponses correctes</div></div>
                    <div class="stat-card"><div class="stat-value" id="acceptedAnswers">0</div><div class="stat-label">R√©ponses accept√©es</div></div>
                    <div class="stat-card"><div class="stat-value" id="totalScore">0%</div><div class="stat-label">Score total</div></div>
                </div>
                <button class="btn btn-primary" style="margin-top: 30px;" onclick="resetQuiz()">Recommencer</button>
            </div>
        </div>

        <div class="navigation">
            <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">‚Üê Pr√©c√©dent</button>
            <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()">Suivant ‚Üí</button>
        </div>
    </div>

    <script>
        let currentQuestion = 1;
        const totalQuestions = 16;
        let answers = { correct: 0, accepted: 0, total: 13, answered: new Set() };
        let schemaData = { 2: { points: [], labels: [], canvas: null, ctx: null, image: null }, 3: { points: [], labels: [], canvas: null, ctx: null, image: null } };
        let extrasData = {};
        let extraCounter = 0;

        const keywords = {
            1: ['rayons x', '√©lectromagn√©tique', 'ionisant', 'photon', 'longueur', 'onde', 'ion', '√©nergie', 'atome', 'picom√®tre', 'nanom√®tre'],
            2: ['freinage', 'bremsstrahlung', '√©lectron', 'noyau', 'caract√©ristique', 'r√©arrangement', 'cascade', 'couche'],
            4: ['kv', 'kilovoltage', 'ma', 'milliamp√®re', 'temps', 'exposition', 'p√©n√©tration', 'quantit√©', 'photon'],
            5: ['photo√©lectrique', 'photon', '√©lectron', '√©nergie', 'liaison', 'ionis√©', 'fluorescence', 'r√©arrangement'],
            6: ['d√©tection', 'tft', 'matrice', 'conversion', 'signal', '√©lectrique', 'can', 'num√©ris√©'],
            7: ['hounsfield', 'eau', 'densit√©', 'uh', 'fen√™trage', 'niveau', 'largeur', 'wl', 'ww', 'window'],
            9: ['mou', 'standard', 'dur', 'r√©solution', 'contraste', 'spatial'],
            11: ['pds', 'produit', 'dose', 'surface', 'pdl', 'longueur', 'idsv', 'volumique', 'mgy'],
            12: ['r√©solution', 'contraste', 'spatiale', 'temporelle', 'art√©fact', 'bruit']
        };

        const solutions = {
            1: "Les rayons X sont des ondes √©lectromagn√©tiques √† haute fr√©quence (longueur d'onde entre 5 pm et 10 nm). Ils sont ionisants car leur √©nergie est suffisante pour arracher des √©lectrons aux atomes, transformant la mati√®re en ions.",
            2: "1) Interaction √©lectron-noyau (freinage/Bremsstrahlung) : l'√©lectron d√©vi√© par le noyau perd de l'√©nergie sous forme de rayonnement X.\n2) Interaction √©lectron-√©lectron : l'√©lectron incident √©jecte un √©lectron de couche interne, provoquant un r√©arrangement √©lectronique avec √©mission de rayons X caract√©ristiques.",
            4: "1) kV (kilovoltage) : influe sur l'√©nergie des photons X et leur pouvoir de p√©n√©tration\n2) mA (milliamp√®res) : influe sur la quantit√© d'√©lectrons et donc de photons X\n3) Temps d'exposition (ms) : influe sur la quantit√© de photons X",
            5: "L'effet photo√©lectrique se produit quand un photon X c√®de toute son √©nergie √† un √©lectron de l'atome. Le transfert n√©cessite que l'√©nergie du photon soit sup√©rieure √† l'√©nergie de liaison. L'atome ionis√© et excit√© retourne √† l'√©quilibre par r√©arrangement √©lectronique avec √©mission de photons de fluorescence.",
            6: "1) Composition : couche de d√©tection + matrice TFT\n2) R√¥les : La couche de d√©tection convertit les RX en charges √©lectriques (direct) ou photons lumineux (indirect). La matrice TFT cr√©e un signal √©lectrique num√©ris√© via un CAN.",
            7: "1) L'√©chelle d'Hounsfield compare les densit√©s du corps en r√©f√©rence √† l'eau (0 UH).\n2) 3 zones : structures peu denses (poumons, valeurs n√©gatives), tissus mous (-100 √† +100 UH), structures denses (os, +100 √† plusieurs milliers UH).\n3) Le fen√™trage centre l'√©tude en contraste sur une portion de l'√©chelle.\n4) Param√®tres : WL (niveau) et WW (largeur).",
            9: "1) MOU : r√©solution en densit√© (structures de densit√© proche)\n2) STANDARD : compromis entre les deux\n3) DUR : r√©solution spatiale",
            11: "1) Imagerie de projection : PDS (Produit Dose Surface) en mGy.cm¬≤\n2) Scanner : PDL (Produit Dose Longueur) en mGy.cm et IDSV (Indice de Dose Scanographique Volumique) en mGy",
            12: "1) R√©solution en contraste\n2) R√©solution spatiale\n3) R√©solution temporelle\n4) Art√©facts"
        };

        const q10Solutions = ['Filtre Papillon', 'Mode h√©lico√Ødal', 'Raw Data', 'Projection', 'Collimation secondaire', 'D√©tecteur secondaire', 'Sinogramme', 'Mode radio', 'Collimation primaire'];
        const q8Solutions = ['acq', 'rec', 'rec', 'rec', 'acq', 'rec', 'acq', 'acq', 'acq'];
        const q13Solutions = ['true', 'true', 'false', 'true', 'false', 'true', 'true', 'true', 'true'];

        function updateProgress() { document.getElementById('progressFill').style.width = ((currentQuestion - 1) / totalQuestions * 100) + '%'; }

        function showQuestion(n) {
            if (n < 1 || n > totalQuestions) return;
            document.querySelectorAll('.question-container').forEach(q => q.classList.remove('active'));
            document.getElementById('question' + n).classList.add('active');
            currentQuestion = n;
            updateProgress();
            document.getElementById('prevBtn').style.display = n === 1 ? 'none' : 'block';
            document.getElementById('nextBtn').style.display = n === totalQuestions ? 'none' : 'block';
            if (n === 16) {
                document.getElementById('correctAnswers').textContent = answers.correct;
                document.getElementById('acceptedAnswers').textContent = answers.accepted;
                document.getElementById('totalScore').textContent = Math.round((answers.correct + answers.accepted) / answers.total * 100) + '%';
            }
        }

        function nextQuestion() { if (currentQuestion < totalQuestions) showQuestion(currentQuestion + 1); }
        function previousQuestion() { if (currentQuestion > 1) showQuestion(currentQuestion - 1); }

        function checkAnswer(q) {
            const answer = document.getElementById('answer' + q).value.toLowerCase();
            const feedback = document.getElementById('feedback' + q);
            if (!answer.trim()) { feedback.className = 'feedback show incorrect'; feedback.innerHTML = '‚ö†Ô∏è Veuillez saisir une r√©ponse.'; return; }
            let matchCount = 0;
            (keywords[q] || []).forEach(k => { if (answer.includes(k)) matchCount++; });
            const threshold = Math.ceil((keywords[q] || []).length * 0.3);
            feedback.classList.remove('correct', 'incorrect', 'accepted');
            feedback.classList.add('show');
            if (!answers.answered.has(q)) {
                if (matchCount >= threshold) {
                    feedback.classList.add('correct');
                    feedback.innerHTML = '<strong>‚úÖ Bonne r√©ponse !</strong> (' + matchCount + ' mots-cl√©s)<div class="solution"><h4>Solution :</h4>' + (solutions[q] || '') + '</div>';
                    answers.correct++; answers.answered.add(q);
                } else {
                    feedback.classList.add('incorrect');
                    feedback.innerHTML = '<strong>‚ùå Incomplet</strong> (' + matchCount + '/' + threshold + ' mots-cl√©s requis)<div class="solution"><h4>Solution :</h4>' + (solutions[q] || '') + '</div>';
                }
            } else { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ D√©j√† valid√©e'; }
        }

        function acceptAnswer(q) {
            const feedback = document.getElementById('feedback' + q);
            if (!answers.answered.has(q)) {
                feedback.className = 'feedback show accepted';
                feedback.innerHTML = '<strong>‚úì Accept√©e</strong>' + (solutions[q] ? '<div class="solution"><h4>Solution :</h4>' + solutions[q] + '</div>' : '');
                answers.accepted++; answers.answered.add(q);
            } else { feedback.className = 'feedback show accepted'; feedback.innerHTML = '‚úì D√©j√† valid√©e'; }
        }

        function checkTable3() {
            const feedback = document.getElementById('feedback3');
            let filled = true;
            for (let i = 1; i <= 10; i++) { if (!document.getElementById('q3_' + i).value.trim()) filled = false; }
            if (!filled) { feedback.className = 'feedback show incorrect'; feedback.innerHTML = '‚ö†Ô∏è Remplissez tous les champs.'; return; }
            document.querySelectorAll('#question3 .solution-row').forEach(r => r.classList.add('show'));
            if (!answers.answered.has(3)) { feedback.className = 'feedback show correct'; feedback.innerHTML = '‚úÖ Tableau compl√©t√© ! Solutions affich√©es.'; answers.correct++; answers.answered.add(3); }
            else { feedback.className = 'feedback show correct'; feedback.innerHTML = '‚úÖ D√©j√† valid√©e'; }
        }

        function checkTable8() {
            const feedback = document.getElementById('feedback8');
            let correct = 0;
            for (let i = 1; i <= 9; i++) {
                const sel = document.querySelector('input[name="q8_' + i + '"]:checked');
                if (sel && sel.value === q8Solutions[i-1]) correct++;
            }
            feedback.classList.remove('correct', 'incorrect', 'accepted');
            feedback.classList.add('show');
            if (!answers.answered.has(8)) {
                if (correct >= 7) { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ ' + correct + '/9 correct !'; answers.correct++; answers.answered.add(8); }
                else { feedback.classList.add('incorrect'); feedback.innerHTML = '‚ùå ' + correct + '/9. Solutions: kV(Acq), DFOV(Rec), √âpaisseur(Rec), Incr√©ment(Rec), mA(Acq), Filtres(Rec), Collimation(Acq), Pitch(Acq), SFOV(Acq)'; }
            } else { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ D√©j√† valid√©e'; }
        }

        function checkMatching() {
            const feedback = document.getElementById('feedback10');
            let correct = 0;
            for (let i = 1; i <= 9; i++) { if (document.getElementById('q10_' + i).value === q10Solutions[i-1]) correct++; }
            feedback.classList.remove('correct', 'incorrect', 'accepted');
            feedback.classList.add('show');
            if (!answers.answered.has(10)) {
                if (correct >= 7) { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ ' + correct + '/9 correct !'; answers.correct++; answers.answered.add(10); }
                else { feedback.classList.add('incorrect'); feedback.innerHTML = '‚ùå ' + correct + '/9. Solutions: 1)Filtre Papillon, 2)Mode h√©lico√Ødal, 3)Raw Data, 4)Projection, 5)Collimation secondaire, 6)D√©tecteur secondaire, 7)Sinogramme, 8)Mode radio, 9)Collimation primaire'; }
            } else { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ D√©j√† valid√©e'; }
        }

        function checkTrueFalse13() {
            const feedback = document.getElementById('feedback13');
            let correct = 0;
            for (let i = 1; i <= 9; i++) {
                const sel = document.querySelector('input[name="q13_' + i + '"]:checked');
                if (sel && sel.value === q13Solutions[i-1]) correct++;
            }
            feedback.classList.remove('correct', 'incorrect', 'accepted');
            feedback.classList.add('show');
            if (!answers.answered.has(13)) {
                if (correct >= 7) { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ ' + correct + '/9 correct !'; answers.correct++; answers.answered.add(13); }
                else { feedback.classList.add('incorrect'); feedback.innerHTML = '‚ùå ' + correct + '/9. Solutions: 1)V, 2)V, 3)F (zones radiosensibles seulement), 4)V, 5)F (30 patients, IMC 18-35), 6)V, 7)V, 8)V, 9)V'; }
            } else { feedback.classList.add('correct'); feedback.innerHTML = '‚úÖ D√©j√† valid√©e'; }
        }

        function loadSchemaImage(q, event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('schemaImage' + q);
                schemaData[q].image = e.target.result;
                img.src = e.target.result;
                img.onload = function() {
                    document.getElementById('uploadZone' + q).style.display = 'none';
                    document.getElementById('imageWorkspace' + q).style.display = 'block';
                    const canvas = document.getElementById('annotationCanvas' + q);
                    canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                    canvas.style.width = '100%'; canvas.style.height = 'auto';
                    schemaData[q].canvas = canvas; schemaData[q].ctx = canvas.getContext('2d');
                    canvas.onclick = function(ev) { handleCanvasClick(q, ev); };
                };
            };
            reader.readAsDataURL(file);
        }

        function handleCanvasClick(q, event) {
            const data = schemaData[q];
            const rect = data.canvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) * (data.canvas.width / rect.width);
            const y = (event.clientY - rect.top) * (data.canvas.height / rect.height);
            const num = data.labels.length + 1;
            data.points.push({ x, y, number: num });
            data.labels.push({ number: num, question: '', answer: '' });
            redrawAnnotations(q); renderLabels(q);
        }

        function redrawAnnotations(q) {
            const data = schemaData[q];
            if (!data.ctx) return;
            data.ctx.clearRect(0, 0, data.canvas.width, data.canvas.height);
            data.points.forEach(p => {
                data.ctx.beginPath(); data.ctx.arc(p.x, p.y, 20, 0, 2 * Math.PI);
                data.ctx.fillStyle = 'rgba(30, 60, 114, 0.9)'; data.ctx.fill();
                data.ctx.strokeStyle = 'white'; data.ctx.lineWidth = 3; data.ctx.stroke();
                data.ctx.fillStyle = 'white'; data.ctx.font = 'bold 16px Arial';
                data.ctx.textAlign = 'center'; data.ctx.textBaseline = 'middle';
                data.ctx.fillText(p.number, p.x, p.y);
            });
        }

        function renderLabels(q) {
            const data = schemaData[q];
            const container = document.getElementById('labelsList' + q);
            container.innerHTML = '';
            data.labels.forEach((label, idx) => {
                const item = document.createElement('div');
                item.className = 'label-item';
                item.innerHTML = '<div class="label-number-display">' + label.number + '</div>' +
                    '<div style="flex:1;"><input type="text" class="label-input" placeholder="Question" value="' + label.question + '" onchange="schemaData[' + q + '].labels[' + idx + '].question=this.value" style="margin-bottom:8px;width:100%;">' +
                    '<input type="text" class="label-input" placeholder="R√©ponse" value="' + label.answer + '" onchange="schemaData[' + q + '].labels[' + idx + '].answer=this.value" style="width:100%;"></div>' +
                    '<button class="delete-label" onclick="deleteLabel(' + q + ',' + idx + ')">üóëÔ∏è</button>';
                container.appendChild(item);
            });
        }

        function deleteLabel(q, idx) {
            schemaData[q].labels.splice(idx, 1); schemaData[q].points.splice(idx, 1);
            schemaData[q].labels.forEach((l, i) => { l.number = i + 1; schemaData[q].points[i].number = i + 1; });
            redrawAnnotations(q); renderLabels(q);
        }

        function addManualQuestion(q) {
            const num = schemaData[q].labels.length + 1;
            schemaData[q].labels.push({ number: num, question: '', answer: '' });
            renderLabels(q);
        }

        function clearAllLabels(q) {
            if (confirm('Effacer toutes les annotations ?')) {
                schemaData[q].labels = []; schemaData[q].points = [];
                redrawAnnotations(q); renderLabels(q);
            }
        }

        function addExtra() {
            extraCounter++;
            const id = 'extra_' + extraCounter;
            extrasData[id] = { points: [], labels: [], image: null, title: '' };
            const container = document.getElementById('extrasList');
            const div = document.createElement('div');
            div.id = id;
            div.style.cssText = 'background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:20px;border:2px solid #1e3c72;';
            div.innerHTML = '<input type="text" placeholder="Titre" style="width:100%;padding:10px;margin-bottom:15px;border:2px solid #e0e0e0;border-radius:8px;" onchange="extrasData[\'' + id + '\'].title=this.value">' +
                '<div class="schema-upload"><div class="upload-area" onclick="document.getElementById(\'upload_' + id + '\').click()"><div class="upload-icon">üì§</div><p>Uploader sch√©ma</p></div>' +
                '<input type="file" id="upload_' + id + '" accept="image/*" style="display:none;" onchange="loadExtra(\'' + id + '\',event)"></div>' +
                '<div id="workspace_' + id + '" style="display:none;margin-top:20px;"><div class="image-container-wrapper"><img id="img_' + id + '" class="schema-image-display"><canvas id="canvas_' + id + '" class="annotation-canvas"></canvas></div>' +
                '<div style="margin-top:20px;"><h4>Annotations</h4><div id="labels_' + id + '"></div></div>' +
                '<button class="btn btn-primary" onclick="addExtraQ(\'' + id + '\')" style="margin-top:10px;">‚ûï Ajouter</button></div>' +
                '<button class="btn btn-danger" onclick="deleteExtra(\'' + id + '\')" style="margin-top:15px;">üóëÔ∏è Supprimer</button>';
            container.appendChild(div);
        }

        function addTextOnly() {
            extraCounter++;
            const id = 'extra_' + extraCounter;
            extrasData[id] = { labels: [], title: '' };
            const container = document.getElementById('extrasList');
            const div = document.createElement('div');
            div.id = id;
            div.style.cssText = 'background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:20px;border:2px solid #1e3c72;';
            div.innerHTML = '<input type="text" placeholder="Titre" style="width:100%;padding:10px;margin-bottom:15px;border:2px solid #e0e0e0;border-radius:8px;" onchange="extrasData[\'' + id + '\'].title=this.value">' +
                '<div style="margin-top:20px;"><h4>Questions</h4><div id="labels_' + id + '"></div></div>' +
                '<button class="btn btn-primary" onclick="addExtraQ(\'' + id + '\')" style="margin-top:10px;">‚ûï Ajouter question</button>' +
                '<button class="btn btn-danger" onclick="deleteExtra(\'' + id + '\')" style="margin-top:15px;">üóëÔ∏è Supprimer</button>';
            container.appendChild(div);
        }

        function loadExtra(id, event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                extrasData[id].image = e.target.result;
                const img = document.getElementById('img_' + id);
                img.src = e.target.result;
                img.onload = function() {
                    document.getElementById('workspace_' + id).style.display = 'block';
                    const canvas = document.getElementById('canvas_' + id);
                    canvas.width = img.naturalWidth; canvas.height = img.naturalHeight;
                    canvas.style.width = '100%'; canvas.style.height = 'auto';
                    extrasData[id].canvas = canvas; extrasData[id].ctx = canvas.getContext('2d');
                    canvas.onclick = function(ev) { handleExtraClick(id, ev); };
                };
            };
            reader.readAsDataURL(file);
        }

        function handleExtraClick(id, event) {
            const data = extrasData[id];
            const rect = data.canvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) * (data.canvas.width / rect.width);
            const y = (event.clientY - rect.top) * (data.canvas.height / rect.height);
            const num = data.labels.length + 1;
            if (!data.points) data.points = [];
            data.points.push({ x, y, number: num });
            data.labels.push({ number: num, question: '', answer: '' });
            redrawExtra(id); renderExtraLabels(id);
        }

        function redrawExtra(id) {
            const data = extrasData[id];
            if (!data.ctx || !data.points) return;
            data.ctx.clearRect(0, 0, data.canvas.width, data.canvas.height);
            data.points.forEach(p => {
                data.ctx.beginPath(); data.ctx.arc(p.x, p.y, 20, 0, 2 * Math.PI);
                data.ctx.fillStyle = 'rgba(30, 60, 114, 0.9)'; data.ctx.fill();
                data.ctx.strokeStyle = 'white'; data.ctx.lineWidth = 3; data.ctx.stroke();
                data.ctx.fillStyle = 'white'; data.ctx.font = 'bold 16px Arial';
                data.ctx.textAlign = 'center'; data.ctx.textBaseline = 'middle';
                data.ctx.fillText(p.number, p.x, p.y);
            });
        }

        function renderExtraLabels(id) {
            const data = extrasData[id];
            const container = document.getElementById('labels_' + id);
            container.innerHTML = '';
            data.labels.forEach((label, idx) => {
                const item = document.createElement('div');
                item.className = 'label-item';
                item.innerHTML = '<div class="label-number-display">' + label.number + '</div>' +
                    '<div style="flex:1;"><input type="text" class="label-input" placeholder="Question" value="' + label.question + '" onchange="extrasData[\'' + id + '\'].labels[' + idx + '].question=this.value" style="margin-bottom:8px;width:100%;">' +
                    '<input type="text" class="label-input" placeholder="R√©ponse" value="' + label.answer + '" onchange="extrasData[\'' + id + '\'].labels[' + idx + '].answer=this.value" style="width:100%;"></div>' +
                    '<button class="delete-label" onclick="deleteExtraLabel(\'' + id + '\',' + idx + ')">üóëÔ∏è</button>';
                container.appendChild(item);
            });
        }

        function addExtraQ(id) {
            const num = extrasData[id].labels.length + 1;
            extrasData[id].labels.push({ number: num, question: '', answer: '' });
            renderExtraLabels(id);
        }

        function deleteExtraLabel(id, idx) {
            extrasData[id].labels.splice(idx, 1);
            if (extrasData[id].points) { extrasData[id].points.splice(idx, 1); extrasData[id].labels.forEach((l, i) => { l.number = i + 1; extrasData[id].points[i].number = i + 1; }); redrawExtra(id); }
            else { extrasData[id].labels.forEach((l, i) => { l.number = i + 1; }); }
            renderExtraLabels(id);
        }

        function deleteExtra(id) { if (confirm('Supprimer ?')) { document.getElementById(id).remove(); delete extrasData[id]; } }

        function exportHTML() {
            const clone = document.documentElement.cloneNode(true);
            document.querySelectorAll('input, textarea, select').forEach(src => {
                if (!src.id) return;
                const target = clone.querySelector('#' + CSS.escape(src.id));
                if (!target) return;
                if (src.tagName === 'TEXTAREA') { target.value = src.value; target.textContent = src.value; }
                else if (src.tagName === 'SELECT') { target.value = src.value; }
                else if (src.tagName === 'INPUT') {
                    if (src.type === 'file') return;
                    if (src.type === 'checkbox' || src.type === 'radio') { target.checked = src.checked; if (src.checked) target.setAttribute('checked', 'checked'); else target.removeAttribute('checked'); }
                    else { target.value = src.value; target.setAttribute('value', src.value); }
                }
            });
            clone.querySelectorAll('.question-container').forEach(q => { q.classList.remove('active'); q.style.display = 'block'; });
            const nav = clone.querySelector('.navigation'); if (nav) nav.style.display = 'none';
            const progress = clone.querySelector('.progress-bar'); if (progress) progress.style.display = 'none';
            ['question15', 'question16'].forEach(id => { const el = clone.querySelector('#' + id); if (el) el.style.display = 'none'; });
            const html = '<!DOCTYPE html>' + clone.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'TD5_Revisions_' + new Date().toISOString().slice(0, 10) + '.html';
            a.click(); URL.revokeObjectURL(a.href);
            alert('‚úÖ Export r√©ussi !');
        }

        function resetQuiz() {
            currentQuestion = 1; answers = { correct: 0, accepted: 0, total: 13, answered: new Set() };
            document.querySelectorAll('textarea, input[type="text"]').forEach(i => i.value = '');
            document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(i => i.checked = false);
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('.feedback').forEach(f => f.classList.remove('show', 'correct', 'incorrect', 'accepted'));
            document.querySelectorAll('.solution-row').forEach(r => r.classList.remove('show'));
            showQuestion(1);
        }

        updateProgress();
    </script>
</body>
</html>
