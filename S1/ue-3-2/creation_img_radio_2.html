<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formation d'une Image Radiologique - Multi RX anim√©s</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e2e8f0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      font-size: 28px;
      font-weight: 700;
      color: #f1f5f9;
      margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    .subtitle {
      font-size: 14px;
      color: #94a3b8;
      font-style: italic;
    }

    #controls {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
    }

    button {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
    }

    button:active {
      transform: translateY(0);
    }

    #scene-container {
      background: #0a0f1e;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      margin-bottom: 25px;
      max-width: 1100px;
      width: 100%;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    svg {
      display: block;
      width: 100%;
      height: auto;
      max-width: 1100px;
    }

    /* Timeline */
    #timeline-wrapper {
      margin: 10px auto 8px;
      max-width: 600px;
      text-align: center;
    }

    #timeline {
      width: 100%;
      height: 6px;
      background: #020617;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.7);
      margin-bottom: 4px;
    }

    #timeline-progress {
      height: 100%;
      width: 20%;
      background: linear-gradient(90deg, #22c55e, #3b82f6);
      transition: width 0.4s ease;
    }

    #timeline-text {
      font-size: 11px;
      color: #cbd5e1;
    }

    #timeline-text strong {
      color: #fbbf24;
    }

    #explanations {
      max-width: 1100px;
      width: 100%;
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border-radius: 12px;
      padding: 20px 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(59, 130, 246, 0.15);
    }

    #explanations p {
      line-height: 1.8;
      margin-bottom: 12px;
    }

    #explanations strong {
      color: #60a5fa;
      font-weight: 600;
    }

    #explanations .highlight {
      color: #fbbf24;
    }

    /* √âtapes d'apparition */
    .phase2, .phase3, .phase4, .phase5 {
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
    }

    #scene[data-step="2"] .phase2,
    #scene[data-step="3"] .phase2,
    #scene[data-step="4"] .phase2,
    #scene[data-step="5"] .phase2 {
      opacity: 1;
    }

    #scene[data-step="3"] .phase3,
    #scene[data-step="4"] .phase3,
    #scene[data-step="5"] .phase3 {
      opacity: 1;
    }

    #scene[data-step="4"] .phase4,
    #scene[data-step="5"] .phase4 {
      opacity: 1;
    }

    #scene[data-step="5"] .phase5 {
      opacity: 1;
    }

    .label {
      fill: #f1f5f9;
      font-size: 13px;
      font-weight: 600;
    }

    .label-small {
      fill: #cbd5e1;
      font-size: 11px;
    }

    .label-tiny {
      fill: #94a3b8;
      font-size: 10px;
    }

    .zone-title {
      fill: #60a5fa;
      font-size: 14px;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(96, 165, 250, 0.5);
    }

    /* Rayons X - INCIDENTS (avant patient) */
    .ray-incident {
      stroke: #60a5fa;
      stroke-linecap: round;
      stroke-dasharray: 35 245;
      filter: url(#xrayGlow);
    }

    /* Rayons X - DANS LE CORPS */
    .ray-body {
      stroke: #60a5fa;
      stroke-linecap: round;
      stroke-dasharray: 35 245;
      filter: url(#xrayGlow);
    }

    /* Rayons X - TRANSMIS (apr√®s patient, intensit√© variable) */
    .ray-transmitted {
      stroke-linecap: round;
      stroke-dasharray: 35 245;
      filter: url(#xrayGlowPost);
      transition: stroke-width 0.4s ease, stroke-opacity 0.4s ease;
    }

    .ray-transmitted[data-density="air"] {
      stroke: #60a5fa;
      stroke-width: 4.5;
      stroke-opacity: 1;
    }

    .ray-transmitted[data-density="fat"] {
      stroke: #68a3d4;
      stroke-width: 3.2;
      stroke-opacity: 0.85;
    }

    .ray-transmitted[data-density="soft"] {
      stroke: #7c9cbf;
      stroke-width: 2.4;
      stroke-opacity: 0.65;
    }

    .ray-transmitted[data-density="bone"] {
      stroke: #9ca3af;
      stroke-width: 1.6;
      stroke-opacity: 0.4;
    }

    .ray-transmitted[data-density="bone-dense"] {
      stroke: #b4b8c0;
      stroke-width: 1.1;
      stroke-opacity: 0.22;
    }

    /* Rayons diffus√©s */
    .scatter-ray {
      stroke: #818cf8;
      stroke-width: 1.8;
      stroke-linecap: round;
      stroke-dasharray: 4 8;
      filter: url(#scatterGlow);
      animation: scatterPulse 2s ease-in-out infinite;
    }

    .scatter-secondary {
      stroke: #6366f1;
      stroke-width: 1.2;
      stroke-linecap: round;
      stroke-dasharray: 3 6;
      opacity: 0.7;
      filter: url(#scatterGlow);
    }

    @keyframes scatterPulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 0.9; }
    }

    /* Tube √† rayons X */
    .tube-body {
      fill: #1e293b;
      stroke: #64748b;
      stroke-width: 2;
    }

    .tube-cathode {
      fill: #334155;
      stroke: #94a3b8;
      stroke-width: 1.5;
    }

    .tube-anode {
      fill: #dc2626;
      stroke: #ef4444;
      stroke-width: 1.5;
    }

    .tube-focus {
      fill: #fbbf24;
      filter: url(#focusGlow);
    }

    /* Patient - Corps */
    .body-outline {
      fill: rgba(203, 213, 225, 0.08);
      stroke: #64748b;
      stroke-width: 2;
    }

    .skin {
      fill: rgba(248, 213, 180, 0.15);
      stroke: #94a3b8;
      stroke-width: 1;
    }

    .soft-tissue {
      fill: rgba(220, 190, 170, 0.2);
      stroke: #b45309;
      stroke-width: 1;
      stroke-opacity: 0.3;
    }

    .bone {
      fill: #f5f5f5;
      stroke: #e5e5e5;
      stroke-width: 1.5;
      opacity: 0.95;
    }

    .bone-detail {
      fill: #fafafa;
      stroke: #e5e5e5;
      stroke-width: 1;
    }

    .lung-right, .lung-left {
      fill: rgba(56, 189, 248, 0.12);
      stroke: #38bdf8;
      stroke-width: 1.5;
      stroke-dasharray: 5 3;
    }

    .heart {
      fill: rgba(239, 68, 68, 0.25);
      stroke: #ef4444;
      stroke-width: 1.5;
    }

    .liver {
      fill: rgba(217, 119, 6, 0.2);
      stroke: #d97706;
      stroke-width: 1;
    }

    .stomach {
      fill: rgba(168, 85, 247, 0.15);
      stroke: #a855f7;
      stroke-width: 1;
    }

    .detector-outline {
      fill: #0f172a;
      stroke: #475569;
      stroke-width: 2;
    }

    .detector-cell {
      fill: none;
      stroke: #1e293b;
      stroke-width: 0.8;
    }

    .image-radiante-zone {
      fill: rgba(96, 165, 250, 0.03);
      stroke: #3b82f6;
      stroke-width: 1.5;
      stroke-dasharray: 8 5;
    }

    .radio-body {
      fill: #9ca3af;
      opacity: 0.5;
    }

    .radio-bone {
      fill: #f5f5f5;
      opacity: 0.95;
    }

    .radio-lung {
      fill: #1f2937;
      opacity: 0.9;
    }

    .radio-heart {
      fill: #d1d5db;
      opacity: 0.8;
    }

    .radio-organ {
      fill: #e5e7eb;
      opacity: 0.7;
    }

    .scale-rect {
      stroke: #64748b;
      stroke-width: 1.5;
    }

    .scale-label {
      fill: #cbd5e1;
      font-size: 11px;
    }

    .scale-arrow {
      fill: none;
      stroke: #94a3b8;
      stroke-width: 1.5;
    }

    .info-bubble {
      fill: rgba(30, 41, 59, 0.95);
      stroke: #3b82f6;
      stroke-width: 1.5;
      rx: 8;
      ry: 8;
    }

    .info-text {
      fill: #e2e8f0;
      font-size: 11px;
    }

    /* Photons RX anim√©s (boules jaunes) */
    .debug-photon {
      fill: #facc15;
      stroke: #fef3c7;
      stroke-width: 2;
      filter: url(#xrayGlow);
      opacity: 1;
    }

    .rx-photon {
      cursor: default;
    }

    /* Gros rayon jaune statique de debug */
    .debug-ray-static {
      stroke: #fde047;
      stroke-width: 12;
      stroke-linecap: round;
      filter: url(#xrayGlow);
    }

    /* Sch√©ma des √©tapes en bas */
    #steps-diagram {
      margin-top: 12px;
    }

    .steps-rect {
      fill: #020617;
      stroke: #3b82f6;
      stroke-width: 1.5;
      rx: 8;
      ry: 8;
    }

    .steps-label {
      fill: #e2e8f0;
      font-size: 12px;
      font-weight: 600;
    }

    .steps-sub {
      fill: #94a3b8;
      font-size: 10px;
    }

    .steps-brace {
      fill: none;
      stroke: #64748b;
      stroke-width: 2;
    }

    .steps-title {
      fill: #cbd5e1;
      font-size: 11px;
      font-style: italic;
    }

    .step-block {
      transition: opacity 0.3s ease, transform 0.2s ease;
    }

    .step-block.inactive {
      opacity: 0.35;
    }

    .step-block.active {
      opacity: 1;
      transform: translateY(-1px);
    }

    .step-block.active .steps-rect {
      stroke: #fbbf24;
      stroke-width: 2;
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 22px;
      }

      #controls {
        flex-direction: column;
        width: 100%;
      }

      button {
        width: 100%;
      }

      svg {
        overflow: visible;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Formation d'une Image Radiologique</h1>
    <div class="subtitle">Avec plusieurs rayons X anim√©s et att√©nuation diff√©rentielle</div>
  </header>

  <div id="controls">
    <button id="btn-play">‚ñ∂ Lecture</button>
    <button id="btn-prev">‚Üê √âtape pr√©c√©dente</button>
    <button id="btn-step">‚ûú √âtape suivante</button>
    <button id="btn-reset">‚ü≤ Recommencer</button>
    <button id="btn-pause">‚è∏ Pause</button>
  </div>

  <div id="scene-container">
    <div id="scene" data-step="1">
      <svg viewBox="0 0 1100 500" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="grayscaleGradient" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#ffffff" stop-opacity="1"/>
            <stop offset="20%" stop-color="#f5f5f5" stop-opacity="1"/>
            <stop offset="40%" stop-color="#d4d4d8" stop-opacity="1"/>
            <stop offset="60%" stop-color="#a1a1aa" stop-opacity="1"/>
            <stop offset="80%" stop-color="#52525b" stop-opacity="1"/>
            <stop offset="100%" stop-color="#18181b" stop-opacity="1"/>
          </linearGradient>

          <filter id="xrayGlow" x="-100%" y="-100%" width="300%" height="300%">
            <feGaussianBlur stdDeviation="2.5" result="blur"/>
            <feColorMatrix
              in="blur"
              type="matrix"
              values="0 0 0 0 0.37
                      0 0 0 0 0.65
                      0 0 0 0 0.98
                      0 0 0 0.9
                      0 0 0 0 1"/>
            <feMerge>
              <feMergeNode/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="xrayGlowPost" x="-100%" y="-100%" width="300%" height="300%">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge>
              <feMergeNode in="blur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="scatterGlow" x="-100%" y="-100%" width="300%" height="300%">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feColorMatrix
              in="blur"
              type="matrix"
              values="0 0 0 0 0.51
                      0 0 0 0 0.55
                      0 0 0 0 0.97
                      0 0 0 0.8
                      0 0 0 0 1"/>
            <feMerge>
              <feMergeNode/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <filter id="focusGlow">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feColorMatrix
              in="blur"
              type="matrix"
              values="0 0 0 0 0.98
                      0 0 0 0 0.75
                      0 0 0 0 0.14
                      0 0 0 0.9
                      0 0 0 0 1"/>
            <feMerge>
              <feMergeNode/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>

          <marker id="arrowBlue" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
            <path d="M0,0 L0,6 L9,3 z" fill="#3b82f6"/>
          </marker>
        </defs>

        <!-- TUBE RX -->
        <g id="tube-rx">
          <rect x="30" y="180" width="100" height="120" rx="12" class="tube-body"/>
          <rect x="45" y="200" width="30" height="80" rx="4" class="tube-cathode"/>
          <line x1="60" y1="195" x2="60" y2="210" stroke="#f59e0b" stroke-width="2"/>
          <line x1="60" y1="270" x2="60" y2="285" stroke="#f59e0b" stroke-width="2"/>
          <path d="M 85 210 L 105 230 L 105 250 L 85 270 Z" class="tube-anode"/>
          <circle cx="95" cy="240" r="6" class="tube-focus"/>
          <path d="M 115 220 L 130 235 L 130 245 L 115 260 Z" fill="none" stroke="#60a5fa" stroke-width="2"/>
          <text x="80" y="170" text-anchor="middle" class="label">Tube √† rayons X</text>
          <text x="60" y="315" text-anchor="middle" class="label-small">Cathode (-)</text>
          <text x="95" y="315" text-anchor="middle" class="label-small">Anode (+)</text>
        </g>

        <!-- RAYONS INCIDENTS -->
        <g id="incident-rays" class="phase1">
          <line x1="130" y1="160" x2="280" y2="160" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="180" x2="280" y2="180" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="200" x2="280" y2="200" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="220" x2="280" y2="220" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="240" x2="280" y2="240" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="260" x2="280" y2="260" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="280" x2="280" y2="280" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="300" x2="280" y2="300" class="ray-incident" stroke-width="3"/>
          <line x1="130" y1="320" x2="280" y2="320" class="ray-incident" stroke-width="3"/>
          <rect x="150" y="130" width="110" height="22" class="info-bubble"/>
          <text x="205" y="145" text-anchor="middle" class="info-text">Intensit√© homog√®ne</text>
        </g>

        <!-- PATIENT -->
        <g id="patient">
          <ellipse cx="400" cy="240" rx="80" ry="180" class="body-outline"/>
          <ellipse cx="400" cy="240" rx="75" ry="175" class="skin"/>
          <ellipse cx="400" cy="90" rx="40" ry="45" class="body-outline"/>
          <circle cx="400" cy="85" r="35" class="bone" opacity="0.3"/>
          <ellipse cx="400" cy="140" rx="85" ry="25" class="soft-tissue"/>

          <g id="spine">
            <rect x="395" y="145" width="10" height="200" class="bone" rx="2"/>
            <circle cx="400" cy="155" r="6" class="bone-detail"/>
            <circle cx="400" cy="175" r="6" class="bone-detail"/>
            <circle cx="400" cy="195" r="6" class="bone-detail"/>
            <circle cx="400" cy="215" r="6" class="bone-detail"/>
            <circle cx="400" cy="235" r="6" class="bone-detail"/>
            <circle cx="400" cy="255" r="6" class="bone-detail"/>
            <circle cx="400" cy="275" r="6" class="bone-detail"/>
            <circle cx="400" cy="295" r="6" class="bone-detail"/>
            <circle cx="400" cy="315" r="6" class="bone-detail"/>
            <circle cx="400" cy="335" r="6" class="bone-detail"/>
          </g>

          <g id="ribs">
            <ellipse cx="420" cy="170" rx="35" ry="8" class="bone" transform="rotate(15 420 170)"/>
            <ellipse cx="425" cy="190" rx="38" ry="8" class="bone" transform="rotate(12 425 190)"/>
            <ellipse cx="428" cy="210" rx="40" ry="8" class="bone" transform="rotate(8 428 210)"/>
            <ellipse cx="428" cy="230" rx="40" ry="8" class="bone" transform="rotate(5 428 230)"/>
            <ellipse cx="425" cy="250" rx="38" ry="8" class="bone" transform="rotate(2 425 250)"/>

            <ellipse cx="380" cy="170" rx="35" ry="8" class="bone" transform="rotate(-15 380 170)"/>
            <ellipse cx="375" cy="190" rx="38" ry="8" class="bone" transform="rotate(-12 375 190)"/>
            <ellipse cx="372" cy="210" rx="40" ry="8" class="bone" transform="rotate(-8 372 210)"/>
            <ellipse cx="372" cy="230" rx="40" ry="8" class="bone" transform="rotate(-5 372 230)"/>
            <ellipse cx="375" cy="250" rx="38" ry="8" class="bone" transform="rotate(-2 375 250)"/>
          </g>

          <g id="lungs">
            <ellipse cx="360" cy="210" rx="35" ry="55" class="lung-left"/>
            <ellipse cx="440" cy="210" rx="35" ry="55" class="lung-right"/>
          </g>

          <path d="M 385 200 Q 380 185 390 180 Q 400 175 405 180 Q 410 175 420 180 Q 430 185 425 200 Q 420 220 405 235 Q 390 220 385 200 Z" class="heart"/>

          <ellipse cx="425" cy="290" rx="40" ry="30" class="liver"/>
          <ellipse cx="370" cy="280" rx="25" ry="20" class="stomach"/>

          <g id="pelvis">
            <ellipse cx="400" cy="360" rx="60" ry="30" class="bone" opacity="0.9"/>
            <ellipse cx="370" cy="365" rx="15" ry="18" class="bone" opacity="0.85"/>
            <ellipse cx="430" cy="365" rx="15" ry="18" class="bone" opacity="0.85"/>
          </g>

          <text x="400" y="55" text-anchor="middle" class="label">Patient</text>
        </g>

        <!-- RAYONS DANS LE CORPS -->
        <g id="body-rays" class="phase2">
          <line x1="280" y1="160" x2="480" y2="160" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="180" x2="480" y2="180" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="200" x2="480" y2="200" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="220" x2="480" y2="220" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="240" x2="480" y2="240" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="260" x2="480" y2="260" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="280" x2="480" y2="280" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="300" x2="480" y2="300" class="ray-body" stroke-width="3"/>
          <line x1="280" y1="320" x2="480" y2="320" class="ray-body" stroke-width="3"/>
        </g>

        <!-- RAYONS DIFFUS√âS -->
        <g id="scattered-rays" class="phase3">
          <path d="M 380 200 L 360 160" class="scatter-ray"/>
          <path d="M 420 210 L 450 180" class="scatter-ray"/>
          <path d="M 390 250 L 370 290" class="scatter-ray"/>
          <path d="M 410 270 L 440 310" class="scatter-ray"/>
          <path d="M 400 230 L 380 260" class="scatter-ray"/>
          <path d="M 400 190 L 420 170" class="scatter-ray"/>
          <path d="M 370 220 L 350 240" class="scatter-secondary"/>
          <path d="M 430 230 L 460 250" class="scatter-secondary"/>
          <path d="M 385 280 L 365 310" class="scatter-secondary"/>
          <path d="M 415 290 L 445 320" class="scatter-secondary"/>
          <rect x="340" y="350" width="120" height="22" class="info-bubble"/>
          <text x="400" y="365" text-anchor="middle" class="info-text">Rayonnement diffus√©</text>
        </g>

        <!-- IMAGE RADIANTE -->
        <g id="image-radiante" class="phase3">
          <rect x="480" y="100" width="120" height="300" class="image-radiante-zone"/>
          <text x="540" y="90" text-anchor="middle" class="zone-title">Image radiante</text>
          <text x="540" y="415" text-anchor="middle" class="label-tiny">(Sortie du patient)</text>
        </g>

        <!-- RAYONS TRANSMIS -->
        <g id="transmitted-rays" class="phase3">
          <line x1="480" y1="160" x2="750" y2="160" class="ray-transmitted" data-density="air"/>
          <line x1="480" y1="180" x2="750" y2="180" class="ray-transmitted" data-density="air"/>
          <line x1="480" y1="200" x2="750" y2="200" class="ray-transmitted" data-density="soft"/>
          <line x1="480" y1="220" x2="750" y2="220" class="ray-transmitted" data-density="bone"/>
          <line x1="480" y1="240" x2="750" y2="240" class="ray-transmitted" data-density="bone-dense"/>
          <line x1="480" y1="260" x2="750" y2="260" class="ray-transmitted" data-density="bone"/>
          <line x1="480" y1="280" x2="750" y2="280" class="ray-transmitted" data-density="soft"/>
          <line x1="480" y1="300" x2="750" y2="300" class="ray-transmitted" data-density="soft"/>
          <line x1="480" y1="320" x2="750" y2="320" class="ray-transmitted" data-density="fat"/>
          <rect x="560" y="130" width="160" height="36" class="info-bubble"/>
          <text x="640" y="145" text-anchor="middle" class="info-text">Derri√®re le patient :</text>
          <text x="640" y="160" text-anchor="middle" class="info-text">intensit√© ‚â† selon la densit√©</text>
        </g>

        <!-- D√âTECTEUR -->
        <g id="detector" class="phase4">
          <rect x="750" y="100" width="180" height="300" class="detector-outline" rx="8"/>
          <g id="detector-grid">
            <line x1="770" y1="105" x2="770" y2="395" class="detector-cell"/>
            <line x1="790" y1="105" x2="790" y2="395" class="detector-cell"/>
            <line x1="810" y1="105" x2="810" y2="395" class="detector-cell"/>
            <line x1="830" y1="105" x2="830" y2="395" class="detector-cell"/>
            <line x1="850" y1="105" x2="850" y2="395" class="detector-cell"/>
            <line x1="870" y1="105" x2="870" y2="395" class="detector-cell"/>
            <line x1="890" y1="105" x2="890" y2="395" class="detector-cell"/>
            <line x1="910" y1="105" x2="910" y2="395" class="detector-cell"/>

            <line x1="755" y1="120" x2="925" y2="120" class="detector-cell"/>
            <line x1="755" y1="140" x2="925" y2="140" class="detector-cell"/>
            <line x1="755" y1="160" x2="925" y2="160" class="detector-cell"/>
            <line x1="755" y1="180" x2="925" y2="180" class="detector-cell"/>
            <line x1="755" y1="200" x2="925" y2="200" class="detector-cell"/>
            <line x1="755" y1="220" x2="925" y2="220" class="detector-cell"/>
            <line x1="755" y1="240" x2="925" y2="240" class="detector-cell"/>
            <line x1="755" y1="260" x2="925" y2="260" class="detector-cell"/>
            <line x1="755" y1="280" x2="925" y2="280" class="detector-cell"/>
            <line x1="755" y1="300" x2="925" y2="300" class="detector-cell"/>
            <line x1="755" y1="320" x2="925" y2="320" class="detector-cell"/>
            <line x1="755" y1="340" x2="925" y2="340" class="detector-cell"/>
            <line x1="755" y1="360" x2="925" y2="360" class="detector-cell"/>
            <line x1="755" y1="380" x2="925" y2="380" class="detector-cell"/>
          </g>
          <text x="840" y="90" text-anchor="middle" class="label">D√©tecteur num√©rique</text>
          <text x="840" y="415" text-anchor="middle" class="label-tiny">(R√©cepteur)</text>
        </g>

        <!-- IMAGE RADIO -->
        <g id="radiological-image" class="phase5">
          <ellipse cx="840" cy="250" rx="70" ry="160" class="radio-body"/>
          <ellipse cx="840" cy="110" rx="35" ry="40" class="radio-body"/>
          <circle cx="840" cy="108" r="30" class="radio-bone"/>
          <ellipse cx="810" cy="195" rx="28" ry="45" class="radio-lung"/>
          <ellipse cx="870" cy="195" rx="28" ry="45" class="radio-lung"/>
          <rect x="836" y="145" width="8" height="180" class="radio-bone" rx="1"/>

          <ellipse cx="855" cy="170" rx="30" ry="6" class="radio-bone" opacity="0.9" transform="rotate(12 855 170)"/>
          <ellipse cx="858" cy="190" rx="32" ry="6" class="radio-bone" opacity="0.9" transform="rotate(8 858 190)"/>
          <ellipse cx="860" cy="210" rx="33" ry="6" class="radio-bone" opacity="0.9" transform="rotate(5 860 210)"/>
          <ellipse cx="860" cy="230" rx="33" ry="6" class="radio-bone" opacity="0.9" transform="rotate(2 860 230)"/>

          <ellipse cx="825" cy="170" rx="30" ry="6" class="radio-bone" opacity="0.9" transform="rotate(-12 825 170)"/>
          <ellipse cx="822" cy="190" rx="32" ry="6" class="radio-bone" opacity="0.9" transform="rotate(-8 822 190)"/>
          <ellipse cx="820" cy="210" rx="33" ry="6" class="radio-bone" opacity="0.9" transform="rotate(-5 820 210)"/>
          <ellipse cx="820" cy="230" rx="33" ry="6" class="radio-bone" opacity="0.9" transform="rotate(-2 820 230)"/>

          <path d="M 825 190 Q 820 180 827 175 Q 835 172 840 175 Q 845 172 853 175 Q 860 180 855 190 Q 850 205 840 217 Q 830 205 825 190 Z" class="radio-heart"/>
          <ellipse cx="855" cy="280" rx="35" ry="25" class="radio-organ"/>
          <ellipse cx="840" cy="345" rx="55" ry="25" class="radio-bone"/>
          <text x="840" y="90" text-anchor="middle" class="zone-title">Image radiologique</text>
        </g>

        <!-- √âCHELLE DENSIT√â -->
        <g id="density-scale" class="phase5">
          <rect x="970" y="100" width="25" height="300" fill="url(#grayscaleGradient)" class="scale-rect"/>
          <text x="1005" y="120" class="scale-label">M√âTAL (blanc)</text>
          <line x1="995" y1="115" x2="1003" y2="115" class="scale-arrow" marker-end="url(#arrowBlue)"/>
          <text x="1005" y="160" class="scale-label">OS (tr√®s clair)</text>
          <line x1="995" y1="155" x2="1003" y2="155" class="scale-arrow" marker-end="url(#arrowBlue)"/>
          <text x="1005" y="220" class="scale-label">EAU (gris moyen)</text>
          <line x1="995" y1="215" x2="1003" y2="215" class="scale-arrow" marker-end="url(#arrowBlue)"/>
          <text x="1005" y="280" class="scale-label">GRAISSE (gris fonc√©)</text>
          <line x1="995" y1="275" x2="1003" y2="275" class="scale-arrow" marker-end="url(#arrowBlue)"/>
          <text x="1005" y="365" class="scale-label">AIR (noir)</text>
          <line x1="995" y1="360" x2="1003" y2="360" class="scale-arrow" marker-end="url(#arrowBlue)"/>
          <text x="1000" y="80" text-anchor="start" class="label" style="font-size: 12px;">√âchelle de densit√©</text>
          <text x="1000" y="420" text-anchor="start" class="label-tiny">‚Üë Att√©nuation croissante</text>
        </g>

        <!-- PHOTONS RX ANIM√âS (dans le faisceau principal) -->
        <g id="rx-photons-main">
          <!-- Air poumon haut -->
          <circle class="debug-photon rx-photon" cx="130" cy="180" r="9"
                  data-target-opacity="0.95" data-target-radius="9" />
          <!-- Tissus mous -->
          <circle class="debug-photon rx-photon" cx="130" cy="200" r="9"
                  data-target-opacity="0.60" data-target-radius="8" />
          <!-- C√¥te / os -->
          <circle class="debug-photon rx-photon" cx="130" cy="220" r="9"
                  data-target-opacity="0.40" data-target-radius="7" />
          <!-- Colonne (os tr√®s dense) -->
          <circle class="debug-photon rx-photon" cx="130" cy="240" r="9"
                  data-target-opacity="0.22" data-target-radius="6" />
          <!-- Air poumon bas -->
          <circle class="debug-photon rx-photon" cx="130" cy="260" r="9"
                  data-target-opacity="0.90" data-target-radius="9" />
        </g>

        <!-- RAYON X DEBUG BAS + PHOTON -->
        <g id="debug-ray-group">
          <line x1="130" y1="365" x2="925" y2="365" class="debug-ray-static"/>
          <circle id="debug-photon" cx="130" cy="365" r="10"
                  class="debug-photon rx-photon"
                  data-target-opacity="0.30" data-target-radius="10" />
          <text x="540" y="345" text-anchor="middle" class="label-small">
            DEBUG : gros rayon bas + photons jaunes anim√©s (att√©nuation diff√©rentielle)
          </text>
        </g>

      </svg>

      <!-- TIMELINE -->
      <div id="timeline-wrapper">
        <div id="timeline">
          <div id="timeline-progress"></div>
        </div>
        <div id="timeline-text">
          √âtape <strong><span id="timeline-current">1</span></strong> / 5
        </div>
      </div>

      <!-- SCH√âMA DES √âTAPES EN BAS -->
      <svg id="steps-diagram" viewBox="0 0 1100 80" xmlns="http://www.w3.org/2000/svg">
        <!-- accolade horizontale stylis√©e sous les blocs -->
        <path
          d="M80,60
             q 20,10 40,10
             h 780
             q 20,0 40,-10"
          class="steps-brace"/>
        <text x="550" y="75" text-anchor="middle" class="steps-title">
          √âtapes de formation de l'image radiologique
        </text>

        <!-- 5 blocs d'√©tapes -->
        <g>
          <!-- √âtape 1 -->
          <g class="step-block" data-step="1">
            <rect x="80" y="15" width="170" height="35" class="steps-rect"/>
            <text x="95" y="30" class="steps-label">√âtape 1</text>
            <text x="95" y="43" class="steps-sub">Faisceau incident homog√®ne</text>
          </g>

          <!-- √âtape 2 -->
          <g class="step-block" data-step="2">
            <rect x="270" y="15" width="170" height="35" class="steps-rect"/>
            <text x="285" y="30" class="steps-label">√âtape 2</text>
            <text x="285" y="43" class="steps-sub">Att√©nuation dans le patient</text>
          </g>

          <!-- √âtape 3 -->
          <g class="step-block" data-step="3">
            <rect x="460" y="15" width="170" height="35" class="steps-rect"/>
            <text x="475" y="30" class="steps-label">√âtape 3</text>
            <text x="475" y="43" class="steps-sub">Rayonnement diffus√©</text>
          </g>

          <!-- √âtape 4 -->
          <g class="step-block" data-step="4">
            <rect x="650" y="15" width="170" height="35" class="steps-rect"/>
            <text x="665" y="30" class="steps-label">√âtape 4</text>
            <text x="665" y="43" class="steps-sub">D√©tection du faisceau</text>
          </g>

          <!-- √âtape 5 -->
          <g class="step-block" data-step="5">
            <rect x="840" y="15" width="170" height="35" class="steps-rect"/>
            <text x="855" y="30" class="steps-label">√âtape 5</text>
            <text x="855" y="43" class="steps-sub">Image radiologique finale</text>
          </g>
        </g>
      </svg>
    </div>
  </div>

  <div id="explanations"></div>

  <script>
    const scene = document.getElementById('scene');
    const explanations = document.getElementById('explanations');
    const btnPlay = document.getElementById('btn-play');
    const btnStep = document.getElementById('btn-step');
    const btnPrev = document.getElementById('btn-prev');
    const btnReset = document.getElementById('btn-reset');
    const btnPause = document.getElementById('btn-pause');
    const timelineProgress = document.getElementById('timeline-progress');
    const timelineCurrent = document.getElementById('timeline-current');
    const stepBlocks = document.querySelectorAll('.step-block');

    let currentStep = 1;
    const maxStep = 5;
    let playTimer = null;
    let isPaused = false;

    const explanationTexts = {
      1: `
        <p>
          <strong>√âtape 1 ‚Äì Faisceau incident homog√®ne</strong><br><br>
          Le tube √©met un faisceau de rayons X d'<span class="highlight">intensit√© identique</span>
          avant de rencontrer le patient. Les photons (boules jaunes) sont tous lumineux au d√©part.
        </p>
      `,
      2: `
        <p>
          <strong>√âtape 2 ‚Äì Att√©nuation dans le patient</strong><br><br>
          Dans la zone du patient, les photons traversent des tissus de densit√© diff√©rente :<br>
          ‚Ä¢ <span class="highlight">Air (poumons)</span> : tr√®s peu d'att√©nuation ‚Üí photons restent tr√®s lumineux.<br>
          ‚Ä¢ <span class="highlight">Tissus mous</span> : att√©nuation moyenne.<br>
          ‚Ä¢ <span class="highlight">Os / colonne</span> : forte att√©nuation ‚Üí photons deviennent petits et peu visibles.<br><br>
          Visuellement : plus la zone est dense, plus le photon <strong>perd en taille et en luminosit√©</strong>.
        </p>
      `,
      3: `
        <p>
          <strong>√âtape 3 ‚Äì Rayonnement diffus√©</strong><br><br>
          Une partie des photons subit une diffusion (effet Compton) et est d√©vi√©e de sa trajectoire.
          Ces rayons diffus√©s se superposent √† l'image utile et diminuent le <span class="highlight">contraste</span>.
        </p>
      `,
      4: `
        <p>
          <strong>√âtape 4 ‚Äì D√©tection du faisceau transmis</strong><br><br>
          Le d√©tecteur mesure la quantit√© de photons qui l'atteignent. Les zones o√π les photons ont √©t√©
          tr√®s att√©nu√©s (os, colonne) donnent des zones <strong>claires</strong>; les zones peu att√©nu√©es
          (air) donnent des zones <strong>sombres/noires</strong>.
        </p>
      `,
      5: `
        <p>
          <strong>√âtape 5 ‚Äì Image radiologique finale</strong><br><br>
          Les diff√©rences d'att√©nuation (photons plus ou moins att√©nu√©s) se traduisent en niveaux de gris :
          <span class="highlight">air noir, os blancs, tissus en gris</span>. C'est le principe de l'image radiologique.
        </p>
      `
    };

    function updateExplanations(step) {
      explanations.innerHTML = explanationTexts[step] || explanationTexts[1];
    }

    function updateTimeline(step) {
      if (timelineProgress) {
        const pct = (step / maxStep) * 100;
        timelineProgress.style.width = pct + '%';
      }
      if (timelineCurrent) {
        timelineCurrent.textContent = String(step);
      }
    }

    function updateStepsDiagram(step) {
      stepBlocks.forEach(block => {
        const s = parseInt(block.dataset.step, 10);
        if (s === step) {
          block.classList.add('active');
          block.classList.remove('inactive');
        } else {
          block.classList.add('inactive');
          block.classList.remove('active');
        }
      });
    }

    function setStep(step) {
      if (step < 1) step = 1;
      if (step > maxStep) step = maxStep;
      currentStep = step;
      scene.setAttribute('data-step', String(step));
      updateExplanations(step);
      updateTimeline(step);
      updateStepsDiagram(step);
    }

    function playAnimation() {
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
      setStep(1);
      let s = 1;
      playTimer = setInterval(() => {
        s++;
        if (s > maxStep) {
          clearInterval(playTimer);
          playTimer = null;
          return;
        }
        setStep(s);
      }, 3000);
    }

    function nextStep() {
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
      if (currentStep < maxStep) {
        setStep(currentStep + 1);
      } else {
        setStep(1);
      }
    }

    function prevStep() {
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
      if (currentStep > 1) {
        setStep(currentStep - 1);
      } else {
        setStep(maxStep);
      }
    }

    function reset() {
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
      setStep(1);
    }

    function togglePause() {
      isPaused = !isPaused;
      btnPause.textContent = isPaused ? '‚ñ∂ Reprendre' : '‚è∏ Pause';
    }

    btnPlay.addEventListener('click', playAnimation);
    btnStep.addEventListener('click', nextStep);
    btnPrev.addEventListener('click', prevStep);
    btnReset.addEventListener('click', reset);
    btnPause.addEventListener('click', togglePause);

    // Animation des rayons incidents + dans le corps
    function animateIncidentRays() {
      const rays = document.querySelectorAll('.ray-incident, .ray-body');
      let offset = 0;
      function step() {
        if (!isPaused) {
          offset = (offset + 2) % 280;
          rays.forEach(ray => {
            ray.style.strokeDashoffset = -offset;
          });
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // Animation des rayons transmis
    function animateTransmittedRays() {
      const rays = document.querySelectorAll('.ray-transmitted');
      let offset = 0;
      function step() {
        if (!isPaused) {
          offset = (offset + 2) % 280;
          rays.forEach(ray => {
            ray.style.strokeDashoffset = -offset;
          });
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    // Animation des photons RX (boules jaunes) avec att√©nuation diff√©rentielle
    function animateRxPhotons() {
      const nodes = document.querySelectorAll('.rx-photon');
      if (!nodes.length) {
        console.warn('DEBUG: aucun .rx-photon trouv√©');
        return;
      }

      const xStart = 130;
      const xEnd = 925;
      const patientEntry = 280;
      const patientExit = 480;

      const photons = [];
      nodes.forEach((node, index) => {
        const baseRadius = parseFloat(node.getAttribute('r') || '9');
        const targetRadius = parseFloat(node.dataset.targetRadius || baseRadius);
        const targetOpacity = parseFloat(node.dataset.targetOpacity || '0.5');

        photons.push({
          node,
          t: (index / nodes.length),
          baseRadius,
          targetRadius,
          targetOpacity
        });
      });

      function step() {
        if (!isPaused) {
          photons.forEach(p => {
            p.t += 0.004;
            if (p.t > 1) p.t -= 1;

            const x = xStart + p.t * (xEnd - xStart);
            p.node.setAttribute('cx', x);

            let opacity = 1;
            let radius = p.baseRadius;

            if (x <= patientEntry) {
              opacity = 1;
              radius = p.baseRadius;
            } else if (x >= patientExit) {
              opacity = p.targetOpacity;
              radius = p.targetRadius;
            } else {
              const localT = (x - patientEntry) / (patientExit - patientEntry); // 0 ‚Üí 1 dans le patient
              opacity = 1 + (p.targetOpacity - 1) * localT;
              radius = p.baseRadius + (p.targetRadius - p.baseRadius) * localT;
            }

            p.node.style.opacity = opacity.toFixed(2);
            p.node.setAttribute('r', radius.toFixed(1));
          });
        }
        requestAnimationFrame(step);
      }

      requestAnimationFrame(step);
    }

    // Init
    setStep(1);
    animateIncidentRays();
    animateTransmittedRays();
    animateRxPhotons();

    console.log('üî¨ Formation d\'une Image Radiologique - multi RX anim√©s');
    console.log('üëâ Timeline + mise en √©vidence de l‚Äô√©tape courante en bas.');
  </script>
</body>
</html>
