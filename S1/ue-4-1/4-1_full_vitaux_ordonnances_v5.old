<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UE 4.1 S1 ‚Äî Quiz complet (Partiel + QCM + V/F)</title>
  <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root{
            --primary: #667eea;
            --primary2:#764ba2;
            --bg: #f1f3f6;
            --card: #f8f9fa;
            --white: #ffffff;
            --text: #2c3e50;
            --muted: #6c757d;
            --border: #e9ecef;
            --ok: #28a745;
            --bad: #dc3545;
            --warn:#ffc107;
            --shadow: 0 20px 60px rgba(0,0,0,0.30);
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
        }

        .container{
            max-width: 1200px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* Header */
        header.header{
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary2) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        header.header h1{
            font-size: clamp(22px, 2.2vw, 34px);
            margin-bottom: 10px;
        }
        header.header .sub{
            font-size: 1.05em;
            opacity: 0.92;
            margin: 0 auto;
            max-width: 80ch;
            line-height: 1.5;
        }
        .row{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            margin-top: 18px;
            justify-content:center;
        }
        .pill{
            display:inline-flex;
            gap:8px;
            align-items:center;
            padding: 10px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.28);
            background: rgba(255,255,255,0.18);
            font-size: 0.95em;
            color: rgba(255,255,255,0.92);
        }
        .pill b{ color: white; }

        /* Mode selector (tabs) */
        .mode-selector{
            display:flex;
            background: var(--card);
            border-bottom: 3px solid var(--border);
            flex-wrap: nowrap;
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            }
        .mode-btn, .tab{
            flex: 0 0 auto;
            min-width: 220px;
            padding: 18px 16px;
            border: none;
            border-right: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 650;
            color: var(--muted);
            position: relative;
            transition: all 0.2s ease;
            text-align:center;
        }
        .mode-btn:hover, .tab:hover{
            background: rgba(0,0,0,0.06);
            color: var(--text);
            transform: translateY(-1px);
        }
        
        .mode-btn:focus-visible, .tab:focus-visible{
            outline: 3px solid rgba(0,0,0,0.15);
            outline-offset: -3px;
        }
.mode-btn.active, .tab.active{
            color: var(--primary);
            background: var(--white);
            box-shadow: inset 0 -4px 0 var(--primary);
        }
        .mode-btn.active::after, .tab.active::after{
            content:'';
            position:absolute;
            left:0; right:0; bottom:0;
            height: 3px;
            background: var(--primary);
        }

        /* Content wrapper */
        .content{
            padding: 26px;
            background: var(--white);
        }

        /* Controls bar */
        .controls-bar{
            display:flex;
            gap:12px;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
            position: sticky;
            top: 14px;
            z-index: 10;
        }
        .toggle{
            display:flex;
            gap: 14px;
            align-items:center;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 0.95em;
        }
        .toggle input{
            width: 16px;
            height: 16px;
            transform: translateY(1px);
            cursor: pointer;
        }
        .actions{
            display:flex;
            gap: 10px;
            align-items:center;
            flex-wrap: wrap;
        }

        button, .btn{
            cursor:pointer;
            border: 2px solid var(--border);
            background: var(--white);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 650;
            transition: all 0.2s ease;
        }
        button:hover, .btn:hover{
            border-color: var(--primary);
            background: rgba(102,126,234,0.06);
        }
        button:active{ transform: translateY(1px); }

        /* Primary/secondary buttons */
        #checkAll{
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        #checkAll:hover{ filter: brightness(0.98); }
        #resetTab{
            background: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        #resetTab:hover{ filter: brightness(0.98); }

        /* KPI */
        .kpi{
            display:flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 18px;
        }
        .kpi .box{
            flex: 1 1 200px;
            min-width: 200px;
            background: var(--card);
            border-radius: 15px;
            padding: 14px 16px;
            border-left: 5px solid var(--primary);
        }
        .kpi .big{ font-size: 1.25em; font-weight: 800; color: var(--text); }
        .kpi .small{ color: var(--muted); font-size: 0.92em; }

        /* Question cards */
        .grid{
            display:grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin-top: 18px;
        }
        .card{
            background: var(--card);
            border-radius: 15px;
            padding: 22px;
            border-left: 5px solid var(--primary);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover{
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        .card h2{
            font-size: 1.08em;
            margin-bottom: 8px;
            display:flex;
            gap:10px;
            align-items: baseline;
            flex-wrap: wrap;
            color: var(--text);
        }
        .meta{
            color: var(--muted);
            font-size: 0.9em;
            display:flex;
            gap:10px;
            flex-wrap: wrap;
            align-items:center;
        }
        .qtext{
            margin: 14px 0 16px;
            line-height: 1.6;
            font-weight: 500;
        }

        .badge{
            display:inline-flex;
            align-items:center;
            padding: 5px 10px;
            border-radius: 999px;
            font-size: 0.82em;
            border: 2px solid var(--border);
            background: var(--white);
            color: var(--muted);
        }
        .badge.ok{ border-color: rgba(40,167,69,0.35); color: var(--ok); background: rgba(40,167,69,0.10); }
        .badge.bad{ border-color: rgba(220,53,69,0.35); color: var(--bad); background: rgba(220,53,69,0.10); }
        .badge.warn{ border-color: rgba(255,193,7,0.45); color: #856404; background: rgba(255,193,7,0.18); }

        .mono{ font-family: var(--mono); }

        textarea, input[type="text"], input[type="number"]{
            width: 100%;
            border: 2px solid var(--border);
            background: var(--white);
            color: var(--text);
            border-radius: 12px;
            padding: 12px 12px;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        textarea{ min-height: 110px; resize: vertical; }
        input[type="number"]{ max-width: 260px; }
        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus{
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102,126,234,0.15);
        }

        .choices{ display:flex; flex-direction:column; gap:10px; }
        label.choice{
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            cursor:pointer;
            display:flex;
            gap:10px;
            align-items:flex-start;
            transition: all 0.2s ease;
        }
        label.choice:hover{
            border-color: var(--primary);
            background: rgba(102,126,234,0.06);
            transform: translateX(4px);
        }
        label.choice input{ margin-top: 3px; }

        .twoCol{ display:grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 900px){
            .twoCol{ grid-template-columns: 1fr 1fr; }
        }

        .inline{ display:flex; gap:10px; flex-wrap: wrap; align-items: center; }
        .hr{ height: 1px; background: var(--border); margin: 14px 0; }

        .help{
            color: var(--muted);
            font-size: 0.92em;
            margin-top: 8px;
            font-style: italic;
        }

        .feedback{
            margin-top: 14px;
            border-radius: 14px;
            border: 2px solid var(--border);
            background: var(--white);
            padding: 14px;
        }
        .feedback.ok{ border-color: rgba(40,167,69,0.35); background: rgba(40,167,69,0.10); }
        .feedback.bad{ border-color: rgba(220,53,69,0.35); background: rgba(220,53,69,0.10); }
        .feedback.warn{ border-color: rgba(255,193,7,0.45); background: rgba(255,193,7,0.18); }
        .feedback .title{ font-weight: 800; margin-bottom: 6px; }
        .feedback ul{ margin: 8px 0 0 18px; }

        .select{
            width: 100%;
            border: 2px solid var(--border);
            background: var(--white);
            color: var(--text);
            border-radius: 12px;
            padding: 10px 12px;
            outline:none;
        }
        select option{
            background: var(--white);
            color: var(--text);
        }

        .tableLike{
            border: 2px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            background: var(--white);
        }
        .trow{
            display:grid;
            grid-template-columns: 1fr 200px;
            gap: 0;
            border-top: 1px solid var(--border);
            align-items:center;
        }
        .trow:first-child{ border-top: 0; }
        .tcell{ padding: 12px; }
        .tcell.right{
            border-left: 1px solid var(--border);
            background: var(--card);
        }

        .footerNote{
            margin-top: 18px;
            color: var(--muted);
            font-size: 0.9em;
            text-align: center;
        }
    
/* ===== Ordonnance (visuel) ===== */
.ordo-paper{
  background: #fff;
  border: 1px solid rgba(0,0,0,0.10);
  border-radius: 14px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.10);
  padding: 18px 18px 14px;
  margin: 12px 0 6px;
  font-family: Georgia, "Times New Roman", serif;
  line-height: 1.45;
  color: #1f2d3a;
  position: relative;
  overflow: hidden;
}
.ordo-paper:before{
  content:"";
  position:absolute;
  inset:0;
  background: repeating-linear-gradient(
    to bottom,
    rgba(0,0,0,0.00),
    rgba(0,0,0,0.00) 22px,
    rgba(102,126,234,0.06) 23px
  );
  pointer-events:none;
}
.ordo-paper > *{ position: relative; }

.ordo-head{
  display:flex;
  justify-content: space-between;
  gap: 14px;
  align-items:flex-start;
}
.ordo-head .left{
  font-weight: 700;
  font-size: 1.02em;
}
.ordo-head .left .sub{
  font-weight: 600;
  font-size: 0.95em;
  opacity: 0.85;
}
.ordo-head .right{
  text-align:right;
  font-size: 0.95em;
  font-weight: 650;
  opacity: 0.85;
  white-space: nowrap;
}
.ordo-rule{
  height:1px;
  background: rgba(0,0,0,0.10);
  margin: 10px 0 12px;
}
.ordo-section{
  margin-top: 10px;
}
.ordo-title{
  text-transform: uppercase;
  letter-spacing: 0.06em;
  font-size: 0.78em;
  font-weight: 800;
  color: rgba(0,0,0,0.55);
  margin-bottom: 6px;
}
.ordo-lines > div{
  margin: 2px 0;
}
.ordo-lines .mut{
  opacity: 0.82;
}
.ordo-footer{
  display:flex;
  justify-content: space-between;
  gap: 14px;
  margin-top: 14px;
  align-items:flex-end;
}
.ordo-footer .doc{
  font-weight: 650;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  color: var(--text);
}
.ordo-sig{
  width: 220px;
  height: 74px;
  border-top: 1px solid rgba(0,0,0,0.14);
  display:flex;
  align-items:flex-end;
  justify-content:flex-end;
  padding-top: 6px;
}
.ordo-sig svg{
  width: 210px;
  height: 64px;
}
.doc-sig{
  margin-top: 4px;
  width: 210px;
  height: 54px;
}
.doc-sig svg{
  width: 210px;
  height: 54px;
  opacity: 0.9;
}
.ordo-progress{
  display:flex;
  gap: 10px;
  align-items:center;
  flex-wrap: wrap;
  margin-top: 8px;
}

</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>UE 4.1 S1 ‚Äî Quiz complet (Partiel + QCM + Vrai/Faux)</h1>
      <div class="sub">
        V√©rification <b>laxiste</b> sur les r√©ponses r√©dig√©es : accents, apostrophes, tirets, singulier/pluriel, ordre, listes en vrac‚Ä¶ tout est tol√©r√©.
        Pour les calculs : tol√©rances num√©riques.
      </div>
      <div class="row">
        <div class="pill">üìå <b>Objectif</b> : entra√Ænement ‚Äúpartiel‚Äù + variantes plus dures</div>
        <div class="pill">üß† <b>Astuce</b> : r√©ponds en listes (1 id√©e par ligne)</div>
        <div class="pill">‚öñÔ∏è <b>Score</b> : points partiels + feedback</div>
      </div>
    </header>

    <div class="mode-selector">
      <button class="mode-btn tab active" data-tab="partiel">Partiel (r√©daction + tableaux + calcul)</button>
      <button class="mode-btn tab" data-tab="qcm">QCM</button>
      <button class="mode-btn tab" data-tab="vf">Vrai/Faux</button>
      <button class="mode-btn tab" data-tab="mix">Mix (mode examen)</button>
      <button class="mode-btn tab" data-tab="cas_vitaux">Cas cliniques ‚Äî constantes</button>
      <button class="mode-btn tab" data-tab="cas_pm">Conformit√© des prescriptions</button>
    </div>

    <div class="content">
      <div class="controls-bar">
        <div class="toggle">
          <label><input id="shuffle" type="checkbox" /> M√©langer</label>
          <label><input id="hideHelp" type="checkbox" /> Masquer indices</label>
        </div>
        <div class="actions">
          <button id="checkAll">Corriger l‚Äôonglet</button>
          <button id="resetTab">R√©essayer l‚Äôonglet</button>
        </div>
      </div>

      <div id="kpis" class="kpi"></div>
      <div id="content" class="grid"></div>

      <div class="footerNote">
        Fonctionne 100% hors-ligne. Rien n‚Äôest envoy√©.
      </div>
    </div>
  </div>

<script>
/* =========================
   Utils ‚Äî normalisation ‚Äúlaxiste‚Äù
========================= */
function norm(s){
  if(s == null) return "";
  s = String(s).toLowerCase().trim();
  s = s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  s = s.replace(/['‚Äô`¬¥\-_/]+/g," ");
  s = s.replace(/[^\p{L}\p{N}]+/gu," ");
  s = s.replace(/\s+/g," ").trim();
  return s;
}
function stemish(w){
  w = norm(w);
  w = w.replace(/\b(\p{L}{3,})(s|x)\b/gu, "$1");
  return w;
}
function unique(arr){ return [...new Set(arr)]; }
function splitLinesOrCommas(s){
  if(!s) return [];
  return s
    .split(/\n|;|,|\u2022|‚Ä¢/g)
    .map(x=>x.trim())
    .filter(x=>x.length>0);
}
function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"); }
function containsAnyKeyword(answerNorm, kwList){
  const a = stemish(answerNorm);
  for(const kw of kwList){
    const k = stemish(kw);
    if(!k) continue;
    const re = new RegExp("(^|\\s)" + escapeRegExp(k) + "(\\s|$)");
    if(re.test(a)) return true;
    if(k.length >= 8 && a.includes(k)) return true;
  }
  return false;
}
function scoreSetAnswer(userText, items, minNeeded){
  const all = stemish(userText);
  const found = new Set();
  for(const it of items){
    if(containsAnyKeyword(all, it.keywords)) found.add(it.id);
  }
  const got = found.size;
  const ok = got >= minNeeded;
  return { ok, got, need:minNeeded, foundIds:[...found] };
}
function inRangeLoose(text, min, max){
  const t = norm(text);
  const nums = (t.match(/(\d+([.,]\d+)?)/g) || []).map(x=>Number(x.replace(",","."))).filter(x=>Number.isFinite(x));
  if(nums.length === 0) return {ok:false, parsed:[]};
  if(nums.length === 1){
    const v = nums[0];
    return {ok:(v>=min && v<=max), parsed:[v]};
  }
  const lo = Math.min(...nums);
  const hi = Math.max(...nums);
  const ok = (lo <= max) && (hi >= min);
  return {ok, parsed:[lo,hi]};
}
function approxEqual(a, b, tol){
  if(!Number.isFinite(a) || !Number.isFinite(b)) return false;
  return Math.abs(a - b) <= tol;
}
function roundNice(x){
  if(!Number.isFinite(x)) return x;
  const a = Math.abs(x);
  if(a >= 100) return Math.round(x);
  if(a >= 10) return Math.round(x*10)/10;
  return Math.round(x*100)/100;
}

/* =========================
   Question bank
========================= */

// √âCONOMIE = incluse comme crit√®re (comme ton cours)
const CRITERES_QUALITE = [
  {id:"securite", label:"S√©curit√©", keywords:["securite","asepsie","identite patient","allergie","contre indication","risque","prevention risque"]},
  {id:"efficacite", label:"Efficacit√©", keywords:["efficacite","objectif atteint","resultat","amelioration","diminution douleur"]},
  {id:"pertinence", label:"Pertinence / adaptation", keywords:["pertinence","adaptation","adapte","individualise","etat du patient","besoin du patient","priorite"]},
  {id:"confort", label:"Confort / respect", keywords:["confort","pudeur","intimite","respect","dignite","douleur","installation antalgique"]},
  {id:"continuite", label:"Continuit√© / tra√ßabilit√©", keywords:["continuite","tracabilite","tracer","transmission","dossier","note","coordination"]},
  {id:"economie", label:"√âconomie", keywords:["economie","economique","cout","optimiser","efficience","rationnel"]},
  // bonus (accept√©s)
  {id:"hygiene", label:"Hygi√®ne", keywords:["hygiene","sha","lavage des mains","gants","propre","sale","desinfection","aseptique"]},
  {id:"organisation", label:"Organisation", keywords:["organisation","preparation","materiel","planification","orr"]},
  {id:"ergonomie", label:"Ergonomie", keywords:["ergonomie","posture","position","triangle","accessibilite"]},
];

const DIGNITE_ACTIONS = [
  {id:"presentation", label:"Se pr√©senter / langage respectueux", keywords:["se presenter","bonjour","respect","vouvoi","pas infantiliser","politesse"]},
  {id:"info_consent", label:"Informer + consentement", keywords:["expliquer","informer","consentement","accord","refus"]},
  {id:"pudeur", label:"Pr√©server la pudeur", keywords:["pudeur","couvrir","drap","ne pas exposer","zone concernee"]},
  {id:"confidentialite", label:"Confidentialit√© / secret", keywords:["confidentialite","secret","discretion","informations"]},
  {id:"valeurs", label:"Respect valeurs/croyances", keywords:["valeurs","croyances","religion","habitudes","culture"]},
  {id:"autonomie", label:"Favoriser autonomie", keywords:["autonomie","participation","solliciter","choix","independance"]},
];

const INTIMITE_ACTIONS = [
  {id:"porte_rideau", label:"Fermer porte / rideau / paravent", keywords:["fermer la porte","rideau","paravent","intimite","presence"]},
  {id:"visiteurs", label:"Faire sortir visiteurs si besoin", keywords:["visiteur","faire sortir","tiers","chambre"]},
  {id:"zone", label:"N‚Äôexposer que la zone", keywords:["n exposer que","zone","drap","couvrir"]},
];

const ORDO_PATIENT_INFO = [
  {id:"nom", label:"Nom", keywords:["nom"]},
  {id:"prenom", label:"Pr√©nom", keywords:["prenom"]},
  {id:"ddn", label:"Date de naissance / √¢ge", keywords:["date de naissance","ddn","age"]},
  {id:"sexe", label:"Sexe", keywords:["sexe"]},
  {id:"ipp", label:"Identifiant (IPP/NIP)", keywords:["ipp","nip","identifiant"]},
  {id:"adresse", label:"Adresse", keywords:["adresse"]},
  {id:"taille_poids", label:"Taille/Poids si n√©cessaire", keywords:["taille","poids","kg","cm"]},
];

const ORDO_MED_INFO = [
  {id:"nom", label:"Nom (DCI/sp√©cialit√©)", keywords:["dci","denomination commune","nom du medicament","specialite"]},
  {id:"dosage", label:"Dosage/concentration", keywords:["dosage","concentration","mg","g","ui","mg ml"]},
  {id:"forme", label:"Forme gal√©nique", keywords:["forme","galenique","comprime","gelule","sirop","injectable","solution"]},
  {id:"voie", label:"Voie d‚Äôadministration", keywords:["voie","per os","po","iv","im","sc","id","sublinguale","rectale","cutanee","transdermique"]},
  {id:"posologie", label:"Posologie (dose + fr√©quence)", keywords:["posologie","fois","par jour","x","frequence","toutes les","prise","matin","soir"]},
  {id:"duree", label:"Dur√©e/quantit√© totale", keywords:["duree","jours","semaines","nombre","boite","quantite totale","unites"]},
  {id:"mode", label:"Mode d‚Äôemploi (dilution/vitesse/heure)", keywords:["dilution","vitesse","debit","heure","moment","mode d emploi"]},
];

const TRACABILITE_OBJECTIFS = [
  {id:"continuite", label:"Continuit√©/coordination", keywords:["continuite","coordination","transmission","equipe"]},
  {id:"securite", label:"S√©curit√© (erreurs, oublis)", keywords:["securite","erreur","oubli","doublon","iatrogenie"]},
  {id:"medicolegal", label:"Preuve m√©dico-l√©gale", keywords:["preuve","medico legal","tribunal","responsabilite","litige"]},
  {id:"qualite", label:"Qualit√©/√©valuation/audit", keywords:["qualite","evaluation","audit","amelioration","indicateur"]},
  {id:"identif", label:"Identification patient/professionnels", keywords:["identification","patient","professionnel","qui a fait quoi"]},
  {id:"vigilances", label:"Vigilances (pharmaco/mat√©rio‚Ä¶)", keywords:["vigilance","pharmacovigilance","materiovigilance","biovigilance","hemovigilance"]},
];

const CI_PRELEVEMENT_BRAS = [
  {id:"fistule", label:"Fistule art√©rio-veineuse", keywords:["fistule","arterio veineuse","dialyse"]},
  {id:"curage", label:"Mastectomie/curage axillaire", keywords:["mastectomie","curage","axillaire","sein"]},
  {id:"perf", label:"Perfusion/cath√©ter sur le membre", keywords:["perfusion","catheter","kt","voie veineuse","vvp"]},
  {id:"lymph", label:"Lymph≈ìd√®me / ≈ìd√®me important", keywords:["lymphoedeme","oedeme","gonfle"]},
  {id:"lesion", label:"Plaie/br√ªlure/infection/inflammation", keywords:["plaie","brulure","infection","inflammation","rougeur","cellulite"]},
  {id:"hematome", label:"H√©matome / traumatisme / immobilisation", keywords:["hematome","trauma","platre","immobilisation","attelle"]},
  {id:"hemi", label:"H√©mipl√©gie (selon consignes de service)", keywords:["hemiplegie","paralysie"]},
];

const POULS_ARTERES = [
  {id:"radiale", label:"Radiale", keywords:["radiale"]},
  {id:"carotide", label:"Carotide", keywords:["carotide"]},
  {id:"femorale", label:"F√©morale", keywords:["femorale"]},
  {id:"humerale", label:"Hum√©rale/brachiale", keywords:["humerale","brachiale"]},
  {id:"pedieuse", label:"P√©dieuse", keywords:["pedieuse","dorsale du pied"]},
  {id:"poplitee", label:"Poplit√©e", keywords:["poplitee"]},
  {id:"tibial", label:"Tibiale post√©rieure", keywords:["tibial","tibiale"]},
  {id:"cubital", label:"Cubital/ulnaire", keywords:["cubital","ulnaire"]},
];

const POUlS_MODALITES = [
  {id:"repos", label:"Patient au repos / position confortable", keywords:["repos","10 min","position","confort"]},
  {id:"doigts", label:"Index + majeur (pas le pouce)", keywords:["index","majeur","pas le pouce","pulpe"]},
  {id:"temps", label:"30 s√ó2 si r√©gulier, 1 min si irr√©gulier", keywords:["30","seconde","x2","1 min","irregulier","une minute"]},
  {id:"qualite", label:"Noter rythme/amplitude + tracer/transmettre", keywords:["rythme","amplitude","volume","tracer","transmettre","dossier"]},
  {id:"pression", label:"Pression douce sur plan osseux", keywords:["pression","douce","comprimer","plan osseux"]},
];

const AVANT_PENDANT_APRES_ITEMS = [
  {id:"verif_pm", text:"V√©rifier la prescription m√©dicale + transmissions patient", stage:"avant"},
  {id:"rassembler", text:"Rassembler/v√©rifier mat√©riel et produits n√©cessaires", stage:"avant"},
  {id:"preparer", text:"Pr√©parer le mat√©riel", stage:"avant"},
  {id:"prevenir", text:"Pr√©venir le patient", stage:"avant"},
  {id:"informer_consent", text:"Informer + recueillir consentement", stage:"avant"},
  {id:"participation", text:"Solliciter la participation si possible", stage:"avant"},
  {id:"visiteurs", text:"Faire sortir les visiteurs si besoin", stage:"avant"},
  {id:"presence_on", text:"Mettre la pr√©sence / signaler soin en cours", stage:"avant"},
  {id:"intimite", text:"Respecter intimit√© + confort pendant le soin", stage:"pendant"},
  {id:"reexpliquer", text:"R√©expliquer si n√©cessaire", stage:"pendant"},
  {id:"tenir_compte", text:"R√©aliser le soin en tenant compte des r√©actions", stage:"pendant"},
  {id:"reinstaller_patient", text:"R√©installer le patient (besoins/habitudes)", stage:"apres"},
  {id:"reinstaller_env", text:"R√©installer l‚Äôenvironnement", stage:"apres"},
  {id:"nettoyer", text:"Nettoyer/d√©contaminer/ranger le mat√©riel", stage:"apres"},
  {id:"poubelles", text:"Fermer puis jeter les poubelles", stage:"apres"},
  {id:"informer_equipe", text:"Informer l‚Äô√©quipe soignante / transmissions", stage:"apres"},
  {id:"presence_off", text:"√âteindre pr√©sence", stage:"apres"},
];

function makePartielQuestions(){
  return [
    {
      id:"P1",
      type:"open_set",
      points:4,
      title:"Question 1 (4 pts) ‚Äî Crit√®res de qualit√© d‚Äôun soin",
      prompt:"Citez 5 crit√®res de qualit√© que doit respecter un soin et donnez un exemple concret pour chacun. (Tu peux r√©pondre en 5 lignes : crit√®re ‚Äî exemple)",
      minNeeded:5,
      items: CRITERES_QUALITE,
      extraExplain:"On corrige en rep√©rant au moins 5 crit√®res distincts (ordre libre). Les exemples ne sont pas not√©s finement ici, mais tu dois en √©crire pour t‚Äôentra√Æner.",
      placeholder:"Ex:\nS√©curit√© ‚Äî v√©rification identit√© + asepsie\nEfficacit√© ‚Äî douleur diminue apr√®s antalgique‚Ä¶\n√âconomie ‚Äî ne pas gaspiller le mat√©riel‚Ä¶\n‚Ä¶",
      check:(ans, q)=>{
        const setScore = scoreSetAnswer(ans, q.items, q.minNeeded);
        const lines = splitLinesOrCommas(ans);
        const hasExamples = lines.some(l => /‚Äî| - |:/.test(l));
        const ok = setScore.ok;
        let level = ok ? "ok" : (setScore.got >= Math.max(2, q.minNeeded-2) ? "warn" : "bad");
        let msg = [];
        msg.push(`Crit√®res trouv√©s : ${setScore.got}/${q.minNeeded}.`);
        if(!hasExamples) msg.push("Ajoute des exemples concrets (crit√®re ‚Äî exemple) pour chaque crit√®re.");
        return { ok, level, score: Math.min(setScore.got, q.minNeeded)/q.minNeeded * q.points, details: msg, expectedHint: q.items.map(x=>x.label) };
      }
    },
    {
      id:"P2",
      type:"open_set",
      points:2,
      title:"Question 2 (2 pts) ‚Äî Dignit√©",
      prompt:"Citez 4 actions pour favoriser le respect de la dignit√© chez un patient.",
      minNeeded:4,
      items: DIGNITE_ACTIONS,
      placeholder:"Ex:\n‚Ä¢ Se pr√©senter‚Ä¶\n‚Ä¢ Expliquer le soin‚Ä¶\n‚Ä¢ Pr√©server la pudeur‚Ä¶\n‚Ä¢ Confidentialit√©‚Ä¶",
      check:(ans,q)=>{
        const s = scoreSetAnswer(ans, q.items, q.minNeeded);
        const ok = s.ok;
        const level = ok ? "ok" : (s.got>=2 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`Actions rep√©r√©es : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P3",
      type:"open_set",
      points:0.5,
      title:"Question 3 (0,5 pt) ‚Äî Intimit√©",
      prompt:"Citez 2 actions pour favoriser le respect de l‚Äôintimit√© chez un patient.",
      minNeeded:2,
      items: INTIMITE_ACTIONS,
      placeholder:"Ex:\n‚Ä¢ Fermer la porte / tirer le rideau\n‚Ä¢ Faire sortir les visiteurs‚Ä¶",
      check:(ans,q)=>{
        const s = scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok = s.ok;
        const level = ok ? "ok" : (s.got>=1 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`Actions rep√©r√©es : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P4",
      type:"open_set",
      points:1,
      title:"Question 4 (1 pt) ‚Äî Ordonnance : infos patient",
      prompt:"Citez 4 informations indispensables sur une prescription, en lien avec le patient (identification).",
      minNeeded:4,
      items: ORDO_PATIENT_INFO,
      placeholder:"Ex: Nom, pr√©nom, date de naissance/√¢ge, sexe, IPP‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=2 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`√âl√©ments rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P5",
      type:"open_set",
      points:3,
      title:"Question 5 (3 pts) ‚Äî Ordonnance : infos m√©dicament",
      prompt:"Citez 6 informations indispensables sur une prescription m√©dicamenteuse, en lien avec le m√©dicament.",
      minNeeded:6,
      items: ORDO_MED_INFO,
      placeholder:"Ex: DCI/nom, dosage, forme gal√©nique, voie, posologie, dur√©e, mode d‚Äôemploi‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=4 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`√âl√©ments rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P6",
      type:"open_multi",
      points:2,
      title:"Question 6 (2 pts) ‚Äî D√©finitions : dosage / dose / posologie / forme gal√©nique",
      prompt:"D√©finis chaque terme. (Mots-cl√©s attendus, formulation libre.)",
      fields:[
        {key:"dosage", label:"Dosage", placeholder:"Ex: quantit√© de principe actif par unit√© (mg/comprim√©, mg/mL‚Ä¶)"},
        {key:"dose", label:"Dose", placeholder:"Ex: quantit√© r√©ellement administr√©e au patient"},
        {key:"posologie", label:"Posologie", placeholder:"Ex: modalit√©s d‚Äôadministration (dose + fr√©quence + dur√©e)"},
        {key:"forme", label:"Forme gal√©nique", placeholder:"Ex: pr√©sentation (comprim√©, sirop, injectable‚Ä¶)"},
      ],
      check:(vals,q)=>{
        const rules = {
          dosage:[["principe actif","pa"],["par unite","mg","ml","concentration","dosage"]],
          dose:[["administre","donne","effectivement"],["quantite","mg","ml","prise"]],
          posologie:[["frequence","fois","rythme","toutes les"],["dose","prise"],["duree","jours","semaines","24h"]],
          forme:[["forme","presentation","pharmaceutique","galenique"],["comprime","gelule","sirop","injectable","solution","suppositoire","patch","creme"]],
        };
        let okCount=0;
        let details=[];
        for(const f of q.fields){
          const a = vals[f.key] || "";
          const aN = stemish(a);
          const bundles = rules[f.key];
          let hit=0;
          for(const b of bundles){
            if(b.some(k=>aN.includes(stemish(k)))) hit++;
          }
          const ok = hit >= Math.min(2, bundles.length);
          if(ok) okCount++;
          details.push(`${f.label} : ${ok ? "OK" : "√Ä compl√©ter (mets l‚Äôid√©e cl√©)"}.`);
        }
        const score = (okCount/q.fields.length)*q.points;
        const okAll = okCount===q.fields.length;
        const level = okAll ? "ok" : (okCount>=2 ? "warn":"bad");
        return { ok: okAll, level, score, details, expectedHint:[
          "Dosage = quantit√© de PA par unit√©/volume",
          "Dose = quantit√© administr√©e",
          "Posologie = dose + fr√©quence + dur√©e",
          "Forme gal√©nique = pr√©sentation (comprim√©/sirop/injectable‚Ä¶)"
        ]};
      }
    },
    {
      id:"P7",
      type:"open",
      points:1,
      title:"Question 7 (1 pt) ‚Äî D√©finition : m√©dicament",
      prompt:"D√©finis le terme ¬´ m√©dicament ¬ª (d√©finition type Code de la Sant√© Publique, en substance).",
      placeholder:"Ex: substance/composition pr√©sent√©e comme curative/pr√©ventive, ou pour diagnostiquer, ou restaurer/corriger/modifier une fonction‚Ä¶",
      check:(ans,q)=>{
        const a=stemish(ans);
        const axes = [
          ["substance","composition","produit"],
          ["curative","preventive","soigner","prevenir"],
          ["diagnostic","diagnostiquer"],
          ["restaurer","corriger","modifier","fonction"],
        ];
        let hit=0;
        for(const b of axes){
          if(b.some(k=>a.includes(stemish(k)))) hit++;
        }
        const ok = hit>=3;
        const level = ok ? "ok" : (hit>=2 ? "warn":"bad");
        const score = (hit/4)*q.points;
        return { ok, level, score, details:[`√âl√©ments cl√©s rep√©r√©s : ${hit}/4.`], expectedHint:[
          "Substance/composition",
          "Curatif/pr√©ventif",
          "Diagnostic",
          "Restaurer/corriger/modifier fonctions"
        ]};
      }
    },
    {
      id:"P8",
      type:"open_set_plus_def",
      points:2,
      title:"Question 8 (2 pts) ‚Äî Tra√ßabilit√© : d√©finition + objectifs",
      prompt:"D√©finis la ¬´ tra√ßabilit√© dans les soins ¬ª puis cite 4 objectifs.",
      minNeeded:4,
      items: TRACABILITE_OBJECTIFS,
      placeholder:"D√©finition + objectifs (au moins 4).\nEx: inscription dat√©e/horodat√©e/sign√©e dans dossier patient‚Ä¶\nObjectifs: continuit√©, s√©curit√©, preuve, qualit√©‚Ä¶",
      check:(ans,q)=>{
        const a=stemish(ans);
        const defKeys = ["tracer","trace","inscription","ecrit","dossier","date","horodat","signature","transmission"];
        const defHit = defKeys.some(k=>a.includes(stemish(k)));
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok = defHit && s.ok;
        const level = ok ? "ok" : ((defHit && s.got>=2) || (!defHit && s.got>=4) ? "warn":"bad");
        let score = (Math.min(s.got,q.minNeeded)/q.minNeeded)*q.points;
        if(defHit) score += 0.2;
        score = Math.min(q.points, score);
        const details = [];
        details.push(defHit ? "D√©finition : OK (trace √©crite/dat√©e‚Ä¶ rep√©r√©e)." : "D√©finition : ajoute l‚Äôid√©e de trace √©crite/dat√©e/sign√©e dans le dossier.");
        details.push(`Objectifs rep√©r√©s : ${s.got}/${q.minNeeded}.`);
        return { ok, level, score, details, expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P9",
      type:"open_set",
      points:1.5,
      title:"Question 9 (1,5 pt) ‚Äî Contre-indications sur un bras (pr√©l√®vement veineux)",
      prompt:"Cite 6 contre-indications visibles/connues sur un bras qui te font passer sur l‚Äôautre bras.",
      minNeeded:6,
      items: CI_PRELEVEMENT_BRAS,
      placeholder:"Ex: fistule AV, curage axillaire/mastectomie, perfusion/KT, lymph≈ìd√®me, plaie/infection, h√©matome/pl√¢tre‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=4 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`Contre-indications rep√©r√©es : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P10",
      type:"open_two",
      points:1,
      title:"Question 10 (1 pt) ‚Äî Pouls : art√®res + norme FC adulte",
      prompt:"Cite 4 art√®res fr√©quentes pour mesurer le pouls, et donne la norme de la fr√©quence cardiaque (adulte sain au repos).",
      fields:[
        {key:"arteres", label:"Art√®res (4)", placeholder:"Ex: radiale, carotide, f√©morale, hum√©rale‚Ä¶"},
        {key:"norme", label:"Norme FC (bpm)", placeholder:"Ex: 60‚Äì80 bpm"},
      ],
      check:(vals,q)=>{
        const art = vals.arteres || "";
        const set = scoreSetAnswer(art, POULS_ARTERES, 4);
        const r = inRangeLoose(vals.norme || "", 60, 80);
        const ok = set.ok && r.ok;
        const level = ok ? "ok" : ((set.got>=3 && r.ok) || (set.ok && !r.ok) ? "warn":"bad");
        let details = [];
        details.push(`Art√®res rep√©r√©es : ${set.got}/4.`);
        details.push(r.ok ? "Norme FC : OK (intervalle coh√©rent)." : "Norme FC : donne un intervalle type 60‚Äì80 bpm (au repos).");
        const score = (Math.min(set.got,4)/4)*0.6*q.points + (r.ok?0.4*q.points:0);
        return { ok, level, score, details, expectedHint:[
          "Radiale, carotide, f√©morale, hum√©rale/brachiale (ou autres art√®res palpables)",
          "FC adulte au repos : ~60‚Äì80 bpm (selon cours)"
        ]};
      }
    },
    {
      id:"P11",
      type:"open_set",
      points:1,
      title:"Question 11 (1 pt) ‚Äî Prise du pouls : modalit√©s fiables",
      prompt:"Cite 4 modalit√©s optimales de la prise du pouls pour un r√©sultat fiable.",
      minNeeded:4,
      items: POUlS_MODALITES,
      placeholder:"Ex: patient au repos, index+majeur, 30s√ó2 si r√©gulier, 1min si irr√©gulier, noter rythme/amplitude + tracer‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=3 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`Modalit√©s rep√©r√©es : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P12",
      type:"open",
      points:1,
      title:"Question 12 (1 pt) ‚Äî D√©finition : saturom√©trie/oxym√©trie",
      prompt:"Donne la d√©finition de la saturom√©trie (oxym√©trie).",
      placeholder:"Ex: mesure non invasive de la saturation puls√©e en O‚ÇÇ (SpO‚ÇÇ) via oxym√®tre‚Ä¶",
      check:(ans,q)=>{
        const a=stemish(ans);
        const keys = [
          ["mesure","mesurer"],
          ["saturation","spo2","hemoglobine"],
          ["oxygene","o2"],
          ["non invasive","capteur","oxymetre","saturometre"],
        ];
        let hit=0;
        for(const b of keys){
          if(b.some(k=>a.includes(stemish(k)))) hit++;
        }
        const ok = hit>=3;
        const level = ok ? "ok" : (hit>=2 ? "warn":"bad");
        const score = (hit/4)*q.points;
        return { ok, level, score, details:[`√âl√©ments cl√©s rep√©r√©s : ${hit}/4.`], expectedHint:["Mesure non invasive", "Saturation puls√©e (SpO‚ÇÇ)", "Oxyg√®ne / h√©moglobine", "Oxym√®tre/saturom√®tre"]};
      }
    },
    {
      id:"P13",
      type:"tf_block",
      points:1.5,
      title:"Question 13 (1,5 pt) ‚Äî Vrai/Faux",
      prompt:"Pour chaque proposition, coche Vrai ou Faux.",
      statements:[
        {id:"s1", text:"Le pouls f√©moral est le pouls de r√©f√©rence en urgence vitale.", answer:false},
        {id:"s2", text:"On parle d‚ÄôHTA si TA ‚â• 15/9 cmHg.", answer:false},
        {id:"s3", text:"La SpO‚ÇÇ est normale si > 93%.", answer:false},
        {id:"s4", text:"Une fr√©quence cardiaque ‚Äúsaine‚Äù au repos est 60‚Äì80 bpm.", answer:true},
        {id:"s5", text:"Une fr√©quence respiratoire saine chez l‚Äôadulte est > 20/min.", answer:false},
        {id:"s6", text:"On parle de bradycardie si FC < 70 bpm.", answer:false},
      ],
      check:(vals,q)=>{
        let good=0;
        for(const st of q.statements){
          const v = vals[st.id];
          if(v === undefined) continue;
          if((v==="true") === st.answer) good++;
        }
        const total = q.statements.length;
        const ok = good===total;
        const level = ok ? "ok" : (good>=4 ? "warn":"bad");
        const score = (good/total)*q.points;
        return { ok, level, score, details:[`Bonnes r√©ponses : ${good}/${total}.`], expectedHint:[
          "R√©f√©rences usuelles : FC 60‚Äì80 (cours), FR adulte 12‚Äì20, HTA souvent ‚â• 14/9 ou selon cours, SpO‚ÇÇ normale plut√¥t ‚â•95% (93‚Äì94 limite selon contexte)."
        ]};
      }
    },
    {
      id:"P14",
      type:"stage_sort",
      points:6,
      title:"Question 14 (6 pts) ‚Äî Avant / Pendant / Apr√®s le soin",
      prompt:"Pour chaque √©l√©ment, choisis : AVANT / PENDANT / APR√àS.",
      items: AVANT_PENDANT_APRES_ITEMS,
      check:(vals,q)=>{
        let good=0;
        for(const it of q.items){
          if(vals[it.id] && vals[it.id]===it.stage) good++;
        }
        const total = q.items.length;
        const ok = good===total;
        const level = ok ? "ok" : (good>=Math.ceil(total*0.7) ? "warn":"bad");
        const score = (good/total)*q.points;
        return { ok, level, score, details:[`Bon placement : ${good}/${total}.`], expectedHint:[
          "Avant : v√©rifs + pr√©paration + info/consentement + intimit√©/visiteurs + pr√©sence",
          "Pendant : intimit√©/confort + r√©aliser en tenant compte des r√©actions",
          "Apr√®s : r√©installer + nettoyer + poubelles + transmissions + pr√©sence off"
        ]};
      }
    },
    {
      id:"P15",
      type:"open_set",
      points:1,
      title:"Question 15 (1 pt) ‚Äî R√®gle des 5B",
      prompt:"Cite les 5 √©l√©ments √† v√©rifier avant l‚Äôadministration d‚Äôun m√©dicament (r√®gle des 5B).",
      minNeeded:5,
      items: [
        {id:"patient", label:"Bon patient", keywords:["bon patient","identite"]},
        {id:"med", label:"Bon m√©dicament", keywords:["bon medicament","bon traitement","bon produit"]},
        {id:"dose", label:"Bonne dose", keywords:["bonne dose","dose"]},
        {id:"voie", label:"Bonne voie", keywords:["bonne voie","voie"]},
        {id:"moment", label:"Bon moment", keywords:["bon moment","bonne heure","horaire"]},
      ],
      placeholder:"Ex: bon patient, bon m√©dicament, bonne dose, bonne voie, bon moment.",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=4 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`B rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P16",
      type:"calc",
      points:1.5,
      title:"Question 16 (1,5 pt) ‚Äî Calcul perfusion",
      prompt:"Prescription : 1 L de G5% + 3 g NaCl + 2 g KCl sur 24 h. Ampoules : NaCl 10 mL √† 10% ; KCl 10 mL √† 20%.",
      fields:[
        {key:"nacl_amp", label:"NaCl : nombre d‚Äôampoules", kind:"number"},
        {key:"nacl_ml", label:"NaCl : volume total (mL)", kind:"number"},
        {key:"kcl_amp", label:"KCl : nombre d‚Äôampoules", kind:"number"},
        {key:"kcl_ml", label:"KCl : volume total (mL)", kind:"number"},
        {key:"vol_total", label:"Volume total perfusion (mL)", kind:"number"},
        {key:"ml_h", label:"D√©bit (mL/h)", kind:"number"},
        {key:"gtt_min", label:"D√©bit (gouttes/min) si 20 gtt/mL", kind:"number"},
      ],
      check:(vals,q)=>{
        const v = (k)=> Number(vals[k]);
        const exp = {
          nacl_amp:3,
          nacl_ml:30,
          kcl_amp:1,
          kcl_ml:10,
          vol_total:1040,
          ml_h:1040/24,
          gtt_min:(1040*20)/1440,
        };
        const tol = {
          nacl_amp:0, nacl_ml:1,
          kcl_amp:0,  kcl_ml:1,
          vol_total:2,
          ml_h:0.8,
          gtt_min:1.2
        };
        let good=0, total=0;
        let details=[];
        for(const f of q.fields){
          total++;
          const got = v(f.key);
          const target = exp[f.key];
          const ok = Number.isFinite(got) && approxEqual(got, target, tol[f.key]);
          if(ok) good++;
          details.push(`${f.label} : ${ok ? "OK" : `attendu ‚âà ${roundNice(target)} (tol√©rance)`}`);
        }
        const okAll = good===total;
        const level = okAll ? "ok" : (good>=5 ? "warn":"bad");
        const score = (good/total)*q.points;
        return { ok: okAll, level, score, details, expectedHint:[
          "NaCl 10% : 1 g / ampoule (10 mL) ‚Üí 3 g = 3 ampoules = 30 mL",
          "KCl 20% : 2 g / ampoule (10 mL) ‚Üí 2 g = 1 ampoule = 10 mL",
          "Volume total = 1040 mL ; mL/h ‚âà 43,3 ; gtt/min (20 gtt/mL) ‚âà 14‚Äì15"
        ]};
      }
    },
    {
      id:"P17",
      type:"open_multi",
      points:2,
      title:"Question 17 (2 pts) ‚Äî Tension art√©rielle : normes et variations",
      prompt:"Compl√®te : (1) valeurs ¬´ normales ¬ª chez l‚Äôadulte (systolique + diastolique) ; (2) seuils d‚ÄôHTA ; (3) seuils d‚Äôhypotension.",
      fields:[
        {key:"norme", label:"TA normale adulte (mmHg)", placeholder:"Ex: 100‚Äì145 / 50‚Äì85 mmHg"},
        {key:"hta", label:"HTA (mmHg)", placeholder:"Ex: ‚â•150 / ‚â•90 mmHg (ou 15/9 cmHg)"},
        {key:"hypo", label:"Hypotension (mmHg)", placeholder:"Ex: <90 / <50 mmHg (ou 9/5 cmHg)"},
      ],
      check:(vals,q)=>{
        function nums(s){
          const t = norm(s);
          return (t.match(/(\d+([.,]\d+)?)/g) || []).map(x=>Number(x.replace(",","."))).filter(x=>Number.isFinite(x));
        }
        function anyBetween(arr, lo, hi){
          return arr.some(v=>v>=lo && v<=hi);
        }
        function anyApprox(arr, target, tol){
          return arr.some(v=>approxEqual(v, target, tol));
        }
        // Norme : on veut retrouver l‚Äôid√©e "100‚Äì145 / 50‚Äì85"
        const nN = nums(vals.norme||"");
        const sysOk = anyBetween(nN, 100, 145);
        const diaOk = anyBetween(nN, 50, 85);
        const normeOk = sysOk && diaOk;

        // HTA : ‚â•150 et/ou ‚â•90 (ou 15/9 en cmHg)
        const hN = nums(vals.hta||"");
        const htaOk = (anyBetween(hN,150,170) && anyBetween(hN,90,105)) || (anyBetween(hN,15,17) && anyBetween(hN,9,11));

        // Hypotension : <90 et/ou <50 (ou 9/5 en cmHg)
        const pN = nums(vals.hypo||"");
        const hypoOk = (anyBetween(pN,80,90) && anyBetween(pN,45,50)) || (anyBetween(pN,8,9) && anyBetween(pN,4.5,5.5));

        const okAll = normeOk && htaOk && hypoOk;
        const good = [normeOk, htaOk, hypoOk].filter(Boolean).length;
        const level = okAll ? "ok" : (good>=2 ? "warn":"bad");
        const score = (good/3)*q.points;

        const details = [
          normeOk ? "Normes : OK (systolique + diastolique rep√©r√©es)." : "Normes : vise ~100‚Äì145 / 50‚Äì85 mmHg.",
          htaOk ? "HTA : OK (‚â•150 / ‚â•90 rep√©r√©)." : "HTA : vise ‚â•150 / ‚â•90 mmHg (ou 15/9 cmHg).",
          hypoOk ? "Hypotension : OK (<90 / <50 rep√©r√©)." : "Hypotension : vise <90 / <50 mmHg (ou 9/5 cmHg).",
        ];
        return { ok: okAll, level, score, details, expectedHint:[
          "Normotension adulte (cours) : systolique ~100‚Äì145 mmHg ; diastolique ~50‚Äì85 mmHg",
          "HTA : systolique ‚â•150 mmHg et diastolique ‚â•90 mmHg",
          "Hypotension : systolique <90 mmHg et diastolique <50 mmHg"
        ]};
      }
    },
    {
      id:"P18",
      type:"open_set",
      points:1,
      title:"Question 18 (1 pt) ‚Äî Brassard TA : contre-indications",
      prompt:"Cite 3 contre-indications √† la pose d‚Äôun brassard de tension sur un bras.",
      minNeeded:3,
      items:[
        {id:"curage", label:"Curage ganglionnaire (risque de lymph≈ìd√®me)", keywords:["curage","ganglionnaire","axillaire","mastectomie","sein","lymphoedeme"]},
        {id:"fistule", label:"Fistule art√©rio-veineuse (dialyse)", keywords:["fistule","arterio veineuse","dialyse"]},
        {id:"plaie", label:"√âtat cutan√© alt√©r√© (plaie‚Ä¶)", keywords:["plaie","etat cutane","lesion","brulure","infection","dermatose"]},
      ],
      placeholder:"Ex: curage ganglionnaire, fistule AV, plaie/√©tat cutan√© alt√©r√©‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=2 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`√âl√©ments rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P19",
      type:"open_set",
      points:2,
      title:"Question 19 (2 pts) ‚Äî Prise de TA : technique (points cl√©s)",
      prompt:"Cite 6 points cl√©s pour une prise de tension art√©rielle fiable (installation + brassard + m√©thode + lecture).",
      minNeeded:6,
      items:[
        {id:"repos10", label:"Patient inform√© + repos ‚â• 10 min", keywords:["informe","averti","repos","10 min","dix minutes"]},
        {id:"brascoeur", label:"Bras au niveau du c≈ìur, soutenu", keywords:["niveau du coeur","hauteur du coeur","bras repose","soutenu","plan"]},
        {id:"pascomp", label:"Pas de compression en amont (v√™tement‚Ä¶)", keywords:["compression","vetement","manche","pas de compression"]},
        {id:"brassardpos", label:"Brassard adapt√© + poche sur art√®re hum√©rale, bord √† 2 travers de doigt du pli", keywords:["brassard","taille","adapte","poche gonflable","artere humerale","2 travers","deux travers","pli du coude"]},
        {id:"gonfler", label:"Gonfler jusqu‚Äô√† disparition du pouls radial", keywords:["gonfler","disparition","pouls radial","silence"]},
        {id:"degonfler", label:"D√©gonfler lentement et r√©guli√®rement", keywords:["degonfler","progressivement","lentement","regulier"]},
        {id:"lecture", label:"1er bruit = systolique ; dernier bruit = diastolique", keywords:["premier bruit","1er bruit","systolique","maxima","dernier bruit","diastolique","minima"]},
        {id:"environnement", label:"Environnement calme + mat√©riel OK", keywords:["bruyant","calme","materiel","defectueux","fuite","manometre"]},
      ],
      placeholder:"Ex: repos 10 min, bras au niveau du c≈ìur, brassard adapt√© et bien plac√©, gonfler jusqu‚Äô√† disparition pouls radial, d√©gonfler lentement, 1er bruit=systolique, dernier=diastolique‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=4 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`Points cl√©s rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },
    {
      id:"P20",
      type:"open_set",
      points:1.5,
      title:"Question 20 (1,5 pt) ‚Äî Respiration : norme et m√©thode",
      prompt:"Cite 5 √©l√©ments √† conna√Ætre pour mesurer la respiration (norme adulte + m√©thode d‚Äôobservation).",
      minNeeded:5,
      items:[
        {id:"cycle", label:"1 cycle = 1 inspiration + 1 expiration", keywords:["inspiration","expiration","cycle","mouvement"]},
        {id:"norme", label:"Norme adulte : 12‚Äì20/min", keywords:["12","20","par minute","mvt","mvts","mouvements"]},
        {id:"insu", label:"Mesure de pr√©f√©rence √† l‚Äôinsu du patient", keywords:["a l insu","insu","sans le dire","discret"]},
        {id:"repos", label:"Patient au repos ‚â• 10 min", keywords:["repos","10 min","dix minutes"]},
        {id:"obs", label:"Observer le thorax (ou main sur thorax) + compter", keywords:["observer","thorax","se soulever","compter","main sur le thorax","paume"]},
        {id:"sym", label:"V√©rifier sym√©trie des h√©mithorax", keywords:["symetrique","hemithorax","mobilite"]},
        {id:"cyanose", label:"Surveiller coloration extr√©mit√©s (cyanose)", keywords:["bleu","violet","cyanose","extremites","manque d o2"]},
      ],
      placeholder:"Ex: 12‚Äì20/min adulte, 1 cycle = insp+exp, au repos 10 min, √† l‚Äôinsu, observer le thorax et compter, v√©rifier sym√©trie, rep√©rer cyanose‚Ä¶",
      check:(ans,q)=>{
        const s=scoreSetAnswer(ans,q.items,q.minNeeded);
        const ok=s.ok;
        const level = ok ? "ok" : (s.got>=3 ? "warn":"bad");
        return { ok, level, score: Math.min(s.got,q.minNeeded)/q.minNeeded*q.points, details:[`√âl√©ments rep√©r√©s : ${s.got}/${q.minNeeded}.`], expectedHint:q.items.map(x=>x.label) };
      }
    },

  ];
}

// QCM + VF question builders
function makeQcmQuestions(){
  return [
    {
      id:"QCM1",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Qualit√© du soin",
      prompt:"Quels √©l√©ments font partie des crit√®res de qualit√© d‚Äôun soin ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"S√©curit√©", correct:true},
        {id:"b", text:"Efficacit√©", correct:true},
        {id:"c", text:"Pertinence / adaptation", correct:true},
        {id:"d", text:"Confort / respect de la personne", correct:true},
        {id:"e", text:"Continuit√© / tra√ßabilit√©", correct:true},
        {id:"g", text:"√âconomie", correct:true},
        {id:"f", text:"Hasard / improvisation", correct:false},
      ],
      explain:"Crit√®res classiques : s√©curit√©, efficacit√©, pertinence, confort/respect, continuit√©/tra√ßabilit√©, √©conomie."
    },
    {
      id:"QCM2",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Conformit√© d‚Äôune prescription (5 domaines)",
      prompt:"Dans la v√©rification de conformit√© d‚Äôune prescription, quels domaines sont classiquement retenus ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Patient", correct:true},
        {id:"b", text:"Prescripteur", correct:true},
        {id:"c", text:"Support (papier/informatis√©)", correct:true},
        {id:"d", text:"R√©glementation/l√©gislation", correct:true},
        {id:"e", text:"Objet de la prescription (m√©dicament / examen / soin)", correct:true},
        {id:"f", text:"Couleur du stylo", correct:false},
      ],
      explain:"Synth√®se fr√©quente : patient / prescripteur / support / r√©glementation / objet."
    },
    {
      id:"QCM3",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî R√®gle des 5B",
      prompt:"La r√®gle des 5B comprend :",
      multi:false,
      options:[
        {id:"a", text:"Bon patient, bon m√©dicament, bonne dose, bonne voie, bon moment", correct:true},
        {id:"b", text:"Bonne humeur, bonne hygi√®ne, bon repas, bonne sieste, bon caf√©", correct:false},
        {id:"c", text:"Bon prescripteur, bon logiciel, bon code-barres, bon chariot, bon pansement", correct:false},
      ],
      explain:"Les 5B = patient / m√©dicament / dose / voie / moment."
    },
    {
      id:"QCM4",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Posologie vs dosage (pi√®ge)",
      prompt:"Quelle proposition est correcte ?",
      multi:false,
      options:[
        {id:"a", text:"Le dosage = modalit√©s d‚Äôadministration (dose + fr√©quence + dur√©e).", correct:false},
        {id:"b", text:"La posologie = quantit√© de principe actif par comprim√©.", correct:false},
        {id:"c", text:"Le dosage = quantit√© de principe actif par unit√© (ex: 500 mg/comprim√©).", correct:true},
        {id:"d", text:"La dose = ce qui est √©crit sur la bo√Æte, jamais ce qui est administr√©.", correct:false},
      ],
      explain:"Dosage = PA par unit√©/volume ; dose = quantit√© administr√©e ; posologie = dose + fr√©quence + dur√©e."
    },
    {
      id:"QCM5",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Saturom√©trie (pratique)",
      prompt:"Qu‚Äôest-ce qui peut fausser une mesure de SpO‚ÇÇ ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Vernis √† ongles", correct:true},
        {id:"b", text:"Mouvements du patient", correct:true},
        {id:"c", text:"Main froide / mauvaise circulation p√©riph√©rique", correct:true},
        {id:"d", text:"Compression en amont (ex: brassard TA du m√™me c√¥t√©)", correct:true},
        {id:"e", text:"Un capteur bien plac√©, patient immobile", correct:false},
      ],
      explain:"Tout ce qui perturbe le signal pulsatile ou la transmission (mouvements, froid, compression, vernis‚Ä¶)."
    },
    {
      id:"QCM6",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Pr√©l√®vement veineux : bras √† √©viter",
      prompt:"Sur quel(s) membre(s) faut-il √©viter de pr√©lever en priorit√© ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Bras avec fistule art√©rio-veineuse (dialyse)", correct:true},
        {id:"b", text:"Bras du c√¥t√© d‚Äôun curage ganglionnaire/mastectomie", correct:true},
        {id:"c", text:"Bras avec perfusion/KT en place", correct:true},
        {id:"d", text:"Bras avec h√©matome important / pl√¢tre", correct:true},
        {id:"e", text:"Bras non-dominant (toujours interdit)", correct:false},
      ],
      explain:"On prot√®ge le capital veineux et on √©vite les situations √† risque (fistule, curage, perf/KT, l√©sions‚Ä¶)."
    },
    {
      id:"QCM7",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Tra√ßabilit√© (objectifs)",
      prompt:"La tra√ßabilit√© sert notamment √† : (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Assurer continuit√© et coordination", correct:true},
        {id:"b", text:"R√©duire erreurs/oubli/doublons", correct:true},
        {id:"c", text:"Fournir une preuve m√©dico-l√©gale", correct:true},
        {id:"d", text:"Am√©liorer qualit√© (audit/indicateurs)", correct:true},
        {id:"e", text:"Remplacer le consentement du patient", correct:false},
      ],
      explain:"Tra√ßabilit√© = continuit√© + s√©curit√© + preuve + qualit√© (entre autres)."
    },
    {
      id:"QCM8",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Ordonnance : infos prescripteur (dur)",
      prompt:"Quels √©l√©ments sont des informations obligatoires li√©es au prescripteur (en g√©n√©ral) ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Nom + pr√©nom", correct:true},
        {id:"b", text:"Qualit√© (m√©decin, sage-femme‚Ä¶)", correct:true},
        {id:"c", text:"Signature", correct:true},
        {id:"d", text:"Date", correct:true},
        {id:"e", text:"Num√©ro d‚Äôidentification", correct:true},
        {id:"f", text:"Groupe sanguin du patient", correct:false},
      ],
      explain:"Selon supports : identit√©/qualit√©/num√©ro + signature + date (+ service/unit√© √† l‚Äôh√¥pital)."
    },
    {
      id:"QCM9",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Tension art√©rielle : normes et seuils",
      prompt:"Coche les propositions justes (plusieurs r√©ponses possibles).",
      multi:true,
      options:[
        {id:"a", text:"Chez l‚Äôadulte, une TA systolique ¬´ normale ¬ª est environ entre 100 et 145 mmHg.", correct:true},
        {id:"b", text:"Chez l‚Äôadulte, une TA diastolique ¬´ normale ¬ª est environ entre 50 et 85 mmHg.", correct:true},
        {id:"c", text:"On parle d‚ÄôHTA quand la systolique est ‚â•150 mmHg ET la diastolique ‚â•90 mmHg.", correct:true},
        {id:"d", text:"Hypotension : systolique <90 mmHg et/ou diastolique <50 mmHg.", correct:true},
        {id:"e", text:"La TA se note classiquement sous la forme : diastolique / systolique.", correct:false},
      ],
      explain:"Cours : normotension ‚âà 100‚Äì145 / 50‚Äì85 mmHg ; HTA si ‚â•150/90 ; hypotension si <90/<50."
    },
    {
      id:"QCM10",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Brassard TA : contre-indications",
      prompt:"Quelles situations contre-indiquent la pose d‚Äôun brassard sur ce bras ?",
      multi:true,
      options:[
        {id:"a", text:"Curage ganglionnaire", correct:true},
        {id:"b", text:"Fistule art√©rio-veineuse (dialyse)", correct:true},
        {id:"c", text:"Plaie / √©tat cutan√© alt√©r√©", correct:true},
        {id:"d", text:"Bras au repos depuis 10 min", correct:false},
      ],
      explain:"Dans le cours : curage ganglionnaire, fistule AV, √©tat cutan√© alt√©r√© (plaie‚Ä¶)."
    },
    {
      id:"QCM11",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Prise de TA : causes d‚Äôerreur fr√©quentes",
      prompt:"Quelles causes peuvent fausser la mesure ? (plusieurs r√©ponses possibles)",
      multi:true,
      options:[
        {id:"a", text:"Mat√©riel d√©fectueux (fuite‚Ä¶), taille de brassard inadapt√©e", correct:true},
        {id:"b", text:"D√©gonflage trop rapide ou saccad√©", correct:true},
        {id:"c", text:"Environnement bruyant", correct:true},
        {id:"d", text:"Art√®re hum√©rale calcifi√©e (mesure difficile/impossible)", correct:true},
        {id:"e", text:"Mettre le bras au niveau du c≈ìur", correct:false},
      ],
      explain:"Cours : mat√©riel/brassard, d√©gonflage, bruit, art√®re calcifi√©e, etc."
    },
    {
      id:"QCM12",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Pouls : art√®res et urgence",
      prompt:"√Ä propos de la palpation du pouls, coche le vrai.",
      multi:false,
      options:[
        {id:"a", text:"Le pouls radial est un pouls central.", correct:false},
        {id:"b", text:"Le pouls carotidien et le pouls f√©moral sont des pouls centraux utiles en urgence vitale.", correct:true},
        {id:"c", text:"La bradycardie correspond √† une FC > 100/min chez l‚Äôadulte.", correct:false},
        {id:"d", text:"La tachycardie correspond √† une FC < 60/min chez l‚Äôadulte.", correct:false},
      ],
      explain:"Cours : bradycardie <60/min ; tachycardie >100/min. En urgence, pouls centraux : carotidien (et f√©moral)."
    },
    {
      id:"QCM13",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Respiration : norme adulte",
      prompt:"Quelle est la norme de fr√©quence respiratoire chez l‚Äôadulte au repos ?",
      multi:false,
      options:[
        {id:"a", text:"5‚Äì10 mouvements/min", correct:false},
        {id:"b", text:"12‚Äì20 mouvements/min", correct:true},
        {id:"c", text:"25‚Äì35 mouvements/min", correct:false},
        {id:"d", text:"40‚Äì60 mouvements/min", correct:false},
      ],
      explain:"Cours : fr√©quence respiratoire normale adulte ‚âà 12‚Äì20/min."
    },
    {
      id:"QCM14",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Oxym√©trie : SpO‚ÇÇ vs SaO‚ÇÇ",
      prompt:"Quelle proposition d√©crit correctement SpO‚ÇÇ et SaO‚ÇÇ ?",
      multi:false,
      options:[
        {id:"a", text:"SpO‚ÇÇ est mesur√©e par gaz du sang art√©riel ; SaO‚ÇÇ par oxym√®tre de pouls.", correct:false},
        {id:"b", text:"SpO‚ÇÇ est une estimation non invasive par oxym√®tre ; SaO‚ÇÇ est mesur√©e de fa√ßon fiable par gaz du sang.", correct:true},
        {id:"c", text:"SpO‚ÇÇ correspond √† la temp√©rature corporelle.", correct:false},
        {id:"d", text:"SaO‚ÇÇ se mesure au niveau d‚Äôune veine p√©riph√©rique.", correct:false},
      ],
      explain:"Cours : SpO‚ÇÇ = saturation puls√©e estim√©e par oxym√®tre ; SaO‚ÇÇ = mesure fiable par gaz du sang (pr√©l√®vement art√©riel)."
    },
    {
      id:"QCM15",
      type:"mcq",
      points:1,
      title:"QCM ‚Äî Temp√©rature : normal et fi√®vre",
      prompt:"Coche les propositions justes (plusieurs r√©ponses possibles).",
      multi:true,
      options:[
        {id:"a", text:"Temp√©rature physiologique matin : ~36,5 √† 37¬∞C ; soir : ~37 √† 37,5¬∞C.", correct:true},
        {id:"b", text:"Hyperthermie/fi√®vre : temp√©rature > 38¬∞C.", correct:true},
        {id:"c", text:"Hypothermie : temp√©rature toujours > 38¬∞C.", correct:false},
        {id:"d", text:"La mesure tympanique est rapide et refl√®te assez bien la temp√©rature centrale si bien r√©alis√©e.", correct:true},
      ],
      explain:"Cours : valeurs physiologiques matin/soir ; fi√®vre >38¬∞C ; tympanique rapide et plut√¥t fiable si correctement plac√©e."
    },

  ];
}

function makeVfQuestions(){
  return [
    {
      id:"VF1",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Hygi√®ne/soins de confort",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"En toilette, on va toujours du plus propre vers le plus sale.", answer:true},
        {id:"b", text:"ORR signifie Organisation ‚Äì R√©alisation ‚Äì Relation.", answer:true},
        {id:"c", text:"Pr√©venir l‚Äôescarre = uniquement mettre un pansement.", answer:false},
        {id:"d", text:"Le changement de position aide √† pr√©venir les escarres.", answer:true},
        {id:"e", text:"La confidentialit√© fait partie du respect de la dignit√©.", answer:true},
      ]
    },
    {
      id:"VF2",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Constantes vitales (pi√®ges)",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"FR adulte normale ‚âà 12‚Äì20/min.", answer:true},
        {id:"b", text:"Bradycardie adulte = FC < 60/min.", answer:true},
        {id:"c", text:"SpO‚ÇÇ normale est g√©n√©ralement entre 95 et 99%.", answer:true},
        {id:"d", text:"Un pouls inexistant peut √©voquer un arr√™t cardiaque.", answer:true},
        {id:"e", text:"On mesure la respiration de pr√©f√©rence √† l‚Äôinsu du patient.", answer:true},
      ]
    },
    {
      id:"VF3",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Administration m√©dicamenteuse",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"En cas de doute sur une prescription, on administre quand m√™me pour ne pas retarder le soin.", answer:false},
        {id:"b", text:"¬´ Celui qui pr√©pare administre ¬ª (principe de s√©curisation).", answer:true},
        {id:"c", text:"La tra√ßabilit√© apr√®s administration fait partie de la s√©curit√© des soins.", answer:true},
        {id:"d", text:"Une interaction m√©dicamenteuse est toujours b√©n√©fique.", answer:false},
      ]
    },
    {
      id:"VF4",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî KT/perfusion (service)",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"On attend le s√©chage complet de l‚Äôantiseptique avant ponction.", answer:true},
        {id:"b", text:"Le mandrin peut √™tre repos√© sur le chariot si on le recapuchonne.", answer:false},
        {id:"c", text:"Le pansement doit rester propre/occlusif/√©tanche et dat√©.", answer:true},
        {id:"d", text:"Une extravasation fait partie des risques √† surveiller.", answer:true},
      ]
    },
    {
      id:"VF5",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Signes vitaux (pouls / TA)",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"Bradycardie chez l‚Äôadulte : fr√©quence cardiaque < 60/min.", answer:true},
        {id:"b", text:"Tachycardie chez l‚Äôadulte : fr√©quence cardiaque > 100/min.", answer:true},
        {id:"c", text:"Le pouls augmente en moyenne de 15 √† 20 pulsations par degr√© Celsius lors d‚Äôune fi√®vre.", answer:true},
        {id:"d", text:"Pouls radial palpable ‚áí tension systolique > 8 (en cmHg, selon le cours).", answer:true},
        {id:"e", text:"Pour prendre un pouls, on utilise de pr√©f√©rence le pouce.", answer:false},
      ]
    },
    {
      id:"VF6",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Temp√©rature",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"En g√©n√©ral, la temp√©rature est plus √©lev√©e le soir que le matin.", answer:true},
        {id:"b", text:"La mesure tympanique est rapide (‚âà 2 secondes) et plut√¥t fiable si l‚Äôembout est bien orient√© dans le CAE.", answer:true},
        {id:"c", text:"La mesure cutan√©e frontale est totalement adapt√©e en milieu hospitalier.", answer:false},
        {id:"d", text:"L‚Äôhyperthermie correspond √† une temp√©rature > 38¬∞C.", answer:true},
        {id:"e", text:"L‚Äôhypothermie peut se situer entre ~32¬∞C et 36¬∞C.", answer:true},
      ]
    },
    {
      id:"VF7",
      type:"tf_block",
      points:1,
      title:"Vrai/Faux ‚Äî Respiration / oxym√©trie",
      prompt:"Coche Vrai ou Faux.",
      statements:[
        {id:"a", text:"1 cycle respiratoire = 1 inspiration + 1 expiration.", answer:true},
        {id:"b", text:"La fr√©quence respiratoire normale chez l‚Äôadulte est d‚Äôenviron 12 √† 20 mouvements/min.", answer:true},
        {id:"c", text:"La respiration se mesure de pr√©f√©rence √† l‚Äôinsu de la personne soign√©e.", answer:true},
        {id:"d", text:"SpO‚ÇÇ est la saturation puls√©e estim√©e par oxym√®tre ; SaO‚ÇÇ est mesur√©e de fa√ßon fiable par gaz du sang.", answer:true},
        {id:"e", text:"Une coloration bleue/violette des extr√©mit√©s peut √©voquer un manque d‚Äôoxyg√®ne.", answer:true},
      ]
    },

  ];
}

function makeMixQuestions(){
  const partiel = makePartielQuestions();
  const qcm = makeQcmQuestions();
  const vf = makeVfQuestions();
  return [
    partiel.find(x=>x.id==="P5"),
    partiel.find(x=>x.id==="P8"),
    partiel.find(x=>x.id==="P9"),
    partiel.find(x=>x.id==="P14"),
    qcm.find(x=>x.id==="QCM2"),
    qcm.find(x=>x.id==="QCM5"),
    qcm.find(x=>x.id==="QCM8"),
    vf.find(x=>x.id==="VF2"),
    vf.find(x=>x.id==="VF3"),
  ].filter(Boolean);
}


function makeCasVitauxQuestions(){
  // Objectif : rep√©rer les constantes "pas bonnes" (hors normes / pr√©occupantes) dans un contexte donn√©.
  // Rappel cours : en cas de fi√®vre, la FC augmente d‚Äôenviron +15 √† +20 bpm par ¬∞C.
  const baseOptions = (vals)=>[
    {id:"temp", text:`Temp√©rature : ${vals.t} ¬∞C`, correct: vals.bad.includes("temp")},
    {id:"fc",   text:`FC : ${vals.fc} bpm`, correct: vals.bad.includes("fc")},
    {id:"fr",   text:`FR : ${vals.fr} /min`, correct: vals.bad.includes("fr")},
    {id:"ta",   text:`TA : ${vals.ta}`, correct: vals.bad.includes("ta")},
    {id:"spo2", text:`SpO‚ÇÇ : ${vals.spo2}%`, correct: vals.bad.includes("spo2")},
  ];

  return [
    {
      id:"VIT1",
      type:"mcq",
      points:1,
      title:"Cas vitaux 1",
      prompt:"Patiente 34 ans, frissons, T¬∞ 39,0¬∞C. Rep√®re les constantes pr√©occupantes.",
      multi:true,
      options: baseOptions({t:"39,0", fc:108, fr:18, ta:"120/75", spo2:97, bad:["temp","fc"]}),
      explain:"Fi√®vre (>38¬∞C). FC √©lev√©e : la fi√®vre augmente la FC d‚Äôenviron +15 √† +20 bpm par ¬∞C ; √† 39¬∞C, une FC ~100‚Äì110 peut s‚Äôobserver, mais reste √† surveiller."
    },
    {
      id:"VIT2",
      type:"mcq",
      points:1,
      title:"Cas vitaux 2",
      prompt:"Homme 72 ans au repos, pas de douleur. Rep√®re les constantes anormales.",
      multi:true,
      options: baseOptions({t:"36,7", fc:52, fr:16, ta:"132/78", spo2:97, bad:["fc"]}),
      explain:"Bradycardie : FC <60 bpm chez l‚Äôadulte. √Ä mettre en lien avec le contexte (sportif, b√™tabloquants, malaise‚Ä¶)."
    },
    {
      id:"VIT3",
      type:"mcq",
      points:1,
      title:"Cas vitaux 3",
      prompt:"Femme 26 ans, anxieuse, respiration rapide. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"37,0", fc:96, fr:26, ta:"118/70", spo2:95, bad:["fr","fc"]}),
      explain:"Tachypn√©e : FR >20/min chez l'adulte (√©l√©ment cl√© ici). FC √† 96 bpm : pas de tachycardie (<100), mais valeur au-dessus de la normale (60-80) donc √† surveiller dans le contexte d'anxi√©t√©."
    },
    {
      id:"VIT4",
      type:"mcq",
      points:1,
      title:"Cas vitaux 4",
      prompt:"Homme 58 ans, dyspn√©e. Rep√®re les constantes pr√©occupantes.",
      multi:true,
      options: baseOptions({t:"37,4", fc:102, fr:24, ta:"145/85", spo2:91, bad:["fc","fr","spo2"]}),
      explain:"SpO‚ÇÇ basse (hypox√©mie). FR √©lev√©e (tachypn√©e). FC >100 = tachycardie. Priorit√© : alerter/transmettre + conduite selon protocole/service."
    },
    {
      id:"VIT5",
      type:"mcq",
      points:1,
      title:"Cas vitaux 5",
      prompt:"Homme 45 ans, sensation de malaise. Rep√®re les constantes anormales.",
      multi:true,
      options: baseOptions({t:"36,6", fc:118, fr:22, ta:"88/48", spo2:97, bad:["fc","fr","ta"]}),
      explain:"Hypotension (<90/<50 mmHg) + tachycardie + FR augment√©e : tableau potentiellement grave (d√©shydratation, h√©morragie, choc‚Ä¶)."
    },
    {
      id:"VIT6",
      type:"mcq",
      points:1,
      title:"Cas vitaux 6",
      prompt:"Patiente 80 ans, somnolente, peau froide. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"35,2", fc:58, fr:10, ta:"100/60", spo2:94, bad:["temp","fc","fr","spo2"]}),
      explain:"Hypothermie (<36¬∞C). Bradycardie possible (FC <60). Bradypn√©e (FR <12). SpO‚ÇÇ limite (93‚Äì94% = √† surveiller selon contexte)."
    },
    {
      id:"VIT7",
      type:"mcq",
      points:1,
      title:"Cas vitaux 7",
      prompt:"Homme 63 ans, c√©phal√©es, visage rouge. Rep√®re les constantes anormales.",
      multi:true,
      options: baseOptions({t:"36,9", fc:84, fr:18, ta:"172/98", spo2:96, bad:["ta"]}),
      explain:"HTA : TA ‚â•150/90 mmHg (selon cours). √Ä transmettre, surveiller, rechercher signes associ√©s."
    },
    {
      id:"VIT8",
      type:"mcq",
      points:1,
      title:"Cas vitaux 8",
      prompt:"Patiente 29 ans post-op, douleur 7/10. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"37,6", fc:112, fr:20, ta:"138/82", spo2:96, bad:["fc"]}),
      explain:"Tachycardie (FC >100). Douleur, anxi√©t√©, fi√®vre, hypovol√©mie sont des causes possibles : corr√©ler aux signes cliniques."
    },
    {
      id:"VIT9",
      type:"mcq",
      points:1,
      title:"Cas vitaux 9",
      prompt:"Homme 40 ans, fi√®vre mod√©r√©e T¬∞ 38,5¬∞C. Rep√®re ce qui est pr√©occupant.",
      multi:true,
      options: baseOptions({t:"38,5", fc:110, fr:19, ta:"125/78", spo2:98, bad:["temp","fc"]}),
      explain:"Fi√®vre (>38¬∞C). Tachycardie : la fi√®vre augmente la FC d‚Äôenviron +15 √† +20 bpm/¬∞C ; √† 38,5¬∞C, FC √©lev√©e attendue mais √† surveiller (hydratation, douleur, sepsis‚Ä¶)."
    },
    {
      id:"VIT10",
      type:"mcq",
      points:1,
      title:"Cas vitaux 10",
      prompt:"Patiente 67 ans, BPCO connue, au repos. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"37,1", fc:92, fr:22, ta:"130/75", spo2:90, bad:["fr","spo2"]}),
      explain:"SpO‚ÇÇ basse. FR √©lev√©e. Chez certains patients BPCO, une SpO‚ÇÇ cible peut √™tre diff√©rente, mais 90% doit alerter et se discuter selon protocole."
    },
    {
      id:"VIT11",
      type:"mcq",
      points:1,
      title:"Cas vitaux 11",
      prompt:"Homme 52 ans, vertiges au lever. Rep√®re les constantes anormales.",
      multi:true,
      options: baseOptions({t:"36,8", fc:64, fr:16, ta:"92/54", spo2:97, bad:["ta"]}),
      explain:"TA basse (proche hypotension). Contexte de vertiges : v√©rifier position, hydratation, orthostatisme, transmettre."
    },
    {
      id:"VIT12",
      type:"mcq",
      points:1,
      title:"Cas vitaux 12",
      prompt:"Patiente 21 ans, crise d‚Äôangoisse. Rep√®re les constantes pr√©occupantes.",
      multi:true,
      options: baseOptions({t:"36,9", fc:104, fr:30, ta:"128/76", spo2:99, bad:["fc","fr"]}),
      explain:"Tachycardie et tachypn√©e possibles en anxi√©t√©. Toujours √©liminer une cause organique si doute."
    },
    {
      id:"VIT13",
      type:"mcq",
      points:1,
      title:"Cas vitaux 13",
      prompt:"Homme 75 ans, fi√®vre, confusion. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"40,0", fc:124, fr:28, ta:"96/58", spo2:93, bad:["temp","fc","fr","ta","spo2"]}),
      explain:"Hyperthermie majeure + tachycardie + tachypn√©e + TA basse + SpO‚ÇÇ limite : suspicion d‚Äôinfection grave/sepsis ‚Üí alerte."
    },
    {
      id:"VIT14",
      type:"mcq",
      points:1,
      title:"Cas vitaux 14",
      prompt:"Femme 48 ans, douleur thoracique. Rep√®re les constantes pr√©occupantes.",
      multi:true,
      options: baseOptions({t:"36,6", fc:110, fr:24, ta:"158/92", spo2:92, bad:["fc","fr","ta","spo2"]}),
      explain:"Tachycardie + tachypn√©e + HTA + SpO‚ÇÇ basse : situation √† risque, transmettre/alerter imm√©diatement."
    },
    {
      id:"VIT15",
      type:"mcq",
      points:1,
      title:"Cas vitaux 15",
      prompt:"Homme 33 ans, sportif, au repos. Rep√®re les constantes anormales.",
      multi:true,
      options: baseOptions({t:"36,5", fc:48, fr:12, ta:"118/68", spo2:98, bad:["fc"]}),
      explain:"Bradycardie <60. Chez un sportif, cela peut √™tre physiologique : √† corr√©ler √† l‚Äô√©tat clinique."
    },
    {
      id:"VIT16",
      type:"mcq",
      points:1,
      title:"Cas vitaux 16",
      prompt:"Femme 60 ans, naus√©es, sueurs. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"36,4", fc:58, fr:22, ta:"84/46", spo2:96, bad:["fc","fr","ta"]}),
      explain:"Hypotension marqu√©e + FR √©lev√©e + brady relative : possible malaise vagal, choc‚Ä¶ surveillance + alerte selon √©tat."
    },
    {
      id:"VIT17",
      type:"mcq",
      points:1,
      title:"Cas vitaux 17",
      prompt:"Homme 50 ans, douleur, agitation. Rep√®re les constantes pr√©occupantes.",
      multi:true,
      options: baseOptions({t:"37,8", fc:128, fr:26, ta:"146/88", spo2:95, bad:["fc","fr"]}),
      explain:"FC tr√®s √©lev√©e + FR √©lev√©e : peut √™tre li√© √† douleur/anxi√©t√©, mais √† surveiller et √† transmettre."
    },
    {
      id:"VIT18",
      type:"mcq",
      points:1,
      title:"Cas vitaux 18",
      prompt:"Patiente 70 ans, somnolence apr√®s s√©dation. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"36,7", fc:72, fr:8, ta:"112/70", spo2:89, bad:["fr","spo2"]}),
      explain:"Bradypn√©e + SpO‚ÇÇ basse : risque de d√©pression respiratoire (m√©dicamenteuse) ‚Üí alerte."
    },
    {
      id:"VIT19",
      type:"mcq",
      points:1,
      title:"Cas vitaux 19",
      prompt:"Homme 64 ans, sans plainte, mais constantes au scope. Rep√®re l‚Äôanomalie.",
      multi:true,
      options: baseOptions({t:"36,9", fc:102, fr:14, ta:"110/60", spo2:97, bad:["fc"]}),
      explain:"Tachycardie (FC >100). Rechercher cause : fi√®vre, douleur, d√©shydratation, anxi√©t√©, arythmie, etc."
    },
    {
      id:"VIT20",
      type:"mcq",
      points:1,
      title:"Cas vitaux 20",
      prompt:"Femme 55 ans, fi√®vre 38,9¬∞C, frissons. Rep√®re les constantes pas bonnes.",
      multi:true,
      options: baseOptions({t:"38,9", fc:105, fr:21, ta:"102/64", spo2:94, bad:["temp","fc","fr","spo2"]}),
      explain:"Fi√®vre + FC √©lev√©e (‚âà +15‚Äì20 bpm/¬∞C) + FR >20 + SpO‚ÇÇ limite : tableau √† surveiller de pr√®s et √† transmettre."
    },
  ];
}

function makeCasPMQuestions(){
  // Objectif : valider la conformit√© d'une prescription selon 5 domaines :
  // patient / prescripteur / support / r√©glementation / m√©dicament (ou autre examen).
  const yn = (ok)=>[
    {id:"ok", text:"‚úÖ Conforme", correct: ok===true},
    {id:"no", text:"‚ùå Non conforme", correct: ok===false},
  ];

  const conduireSiDoute = "Si doute/incompr√©hension : ne pas administrer et faire clarifier la prescription avant d‚Äôex√©cuter (r√®gle des 5B).";

  return [
    {
      id:"PM1",
      type:"mcq",
      points:1,
      title:"Prescription 1",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ORDONNANCE HOSPITALI√àRE
CHU Saint-Antoine ‚Äî M√©decine Interne
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patient : DUPONT L√©a
Date de naissance : 05/03/1985

Paris, le 15/01/2026

Prescription :
Parac√©tamol 1 g (comprim√©)
1 comprim√© si douleur (max 3 g/24h)
Voie orale
Dur√©e : 3 jours

Dr MARTIN Sophie ‚Äî M√©decine Interne
15/01/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme : prescription exploitable.",
        "Support identifiable (√©tablissement + service).",
        "Patient identifi√© (nom + date de naissance/√¢ge).",
        "M√©dicament complet : nom, dosage, forme, posologie, voie, dur√©e.",
        "Prescripteur + date + signature pr√©sents."
      ]
    },
    {
      id:"PM2",
      type:"mcq",
      points:1,
      title:"Prescription 2",
      prompt:`Dr LEFEBVRE Thomas ‚Äî M√©decine g√©n√©rale
18 avenue Victor Hugo ‚Äî 69003 Lyon

Patient : ROUSSEAU Marc
N√© le : 18/11/1972

Lyon, le 20/01/2026

Ordonnance :
Doliprane (Parac√©tamol) 1 g ‚Äî comprim√©
1 comprim√© matin et soir
Voie orale

Dr LEFEBVRE Thomas
20/01/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : dur√©e de traitement absente (information obligatoire).",
        "Cons√©quence : impossible de savoir quand arr√™ter / quantit√© totale ‚Üí risque d‚Äôerreur d‚Äôadministration.",
        conduireSiDoute
      ]
    },
    {
      id:"PM3",
      type:"mcq",
      points:1,
      title:"Prescription 3",
      prompt:`CHU de Lyon ‚Äî Urgences

Patient : BERNARD Sophie
N√©e le : 22/07/1990
N¬∞ dossier : 45782

Lyon, le 12/01/2026

Prescription :
Amoxicilline 1 g (comprim√©)
1 comprim√© x3/jour
Dur√©e : 7 jours

Dr LEFEBVRE Thomas ‚Äî Urgentiste
12/01/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : voie d‚Äôadministration absente.",
        "Cons√©quence : la r√®gle des 5B ne peut pas √™tre valid√©e (bonne voie / bon moment).",
        conduireSiDoute
      ]
    },
    {
      id:"PM4",
      type:"mcq",
      points:1,
      title:"Prescription 4",
      prompt:`H√¥pital Bichat ‚Äî R√©animation

Patient : MOREAU Thomas
Date de naissance :

Paris, le 15/01/2026

Prescription :
S√©rum physiologique NaCl 0,9%
500 mL en perfusion IV
Sur 6 heures

Dr DUPUIS Claire ‚Äî R√©animation
15/01/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine patient : identit√© incompl√®te (√¢ge/date de naissance obligatoire).",
        "Cons√©quence : risque d‚Äôerreur de patient ‚Üí ‚Äúbon patient‚Äù (5B) non s√©curis√©.",
        conduireSiDoute
      ]
    },
    {
      id:"PM5",
      type:"mcq",
      points:1,
      title:"Prescription 5",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PRESCRIPTION INFORMATIS√âE
H√¥pital Europ√©en Georges-Pompidou
Cardiologie ‚Äî Unit√© 2A
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patient : LAMBERT Claire
N√©e le : 30/09/1965
IPP : 7845123

Date : 18/01/2026
Prescripteur : Dr SIMON Marc ‚Äî Cardiologie

Prescription :
Furos√©mide 20 mg (comprim√©)
1 comprim√© le matin
Voie orale
Dur√©e : 5 jours

18/01/2026 ‚Äî Validation √©lectronique`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme : prescription informatis√©e compl√®te.",
        "Support identifiable + tra√ßabilit√© (IPP, date, validation).",
        "M√©dicament complet : nom, dosage, forme, posologie, voie, dur√©e.",
        "Prescripteur identifi√© + date/validation."
      ]
    },
    {
      id:"PM6",
      type:"mcq",
      points:1,
      title:"Prescription 6",
      prompt:`Cabinet M√©dical Dr GARNIER
12 rue de la Sant√© ‚Äî 75014 Paris
T√©l : 01 45 67 89 10

Patient : PETIT Marie
N√©e le : 14/02/1988

Paris, le 20/01/2026

Ordonnance :
Ibuprof√®ne 400 mg (comprim√©)
1 comprim√© 3 fois par jour
Voie orale
Dur√©e : 5 jours

Dr GARNIER Paul ‚Äî M√©decin g√©n√©raliste
20/01/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "Prescripteur : identit√© + date + signature.",
        "Patient identifi√©.",
        "M√©dicament complet (nom, dosage, forme, posologie, voie, dur√©e)."
      ]
    },
    {
      id:"PM7",
      type:"mcq",
      points:1,
      title:"Prescription 7",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
ORDONNANCE S√âCURIS√âE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Dr OLIVIER Alice ‚Äî Anesth√©sie
H√¥pital Saint-Louis ‚Äî Paris

Patient : MARTIN Paul
N√© le : 12/03/1958

Paris, le 02/02/2026

Prescription :
Morphine (sulfate) 10 mg ‚Äî g√©lule
1 g√©lule toutes les 4 heures si douleur
Voie orale
Dur√©e : 7 jours

Dr OLIVIER Alice
02/02/2026 [signature]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "M√©dicament complet + voie + dur√©e + conditions d‚Äôadministration.",
        "Support adapt√© pour un stup√©fiant (ordonnance s√©curis√©e).",
        "Patient + prescripteur + date + signature pr√©sents."
      ]
    },
    {
      id:"PM8",
      type:"mcq",
      points:1,
      title:"Prescription 8",
      prompt:`Clinique du Parc ‚Äî Endocrinologie

Patient : GIRARD Isabelle
N√©e le : 25/06/1975

Toulouse, le 22/01/2026

Prescription :
Metformine 850 mg (comprim√©)
1 comprim√© matin et soir
Voie orale
Dur√©e : 1 mois

Dr VINCENT Alexandre ‚Äî Endocrinologue`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine prescripteur : absence de signature.",
        "Cons√©quence : prescription non valid√©e juridiquement / tra√ßabilit√© insuffisante.",
        conduireSiDoute
      ]
    },
    {
      id:"PM9",
      type:"mcq",
      points:1,
      title:"Prescription 9",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
CHU de Bordeaux ‚Äî Pneumologie
Service Pr. MERCIER ‚Äî B√¢timent B2
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patient : ROUX Jean
N√© le : 08/04/1942

Bordeaux, le 22/01/2026

Prescription :
Oxyg√©noth√©rapie
2 L/min par lunettes nasales
Si SpO‚ÇÇ < 92%
√Ä r√©√©valuer quotidiennement

Dr MERCIER Henri ‚Äî Pneumologue
22/01/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme : prescription non m√©dicamenteuse exploitable.",
        "Support/service identifi√© + prescripteur dat√© et sign√©.",
        "Objet de prescription pr√©cis : d√©bit, dispositif, condition d‚Äôutilisation, r√©√©valuation."
      ]
    },
    {
      id:"PM10",
      type:"mcq",
      points:1,
      title:"Prescription 10",
      prompt:`Dr BLANC Nicolas ‚Äî M√©decine g√©n√©rale
18 avenue Victor Hugo ‚Äî 69003 Lyon

Patient : FAURE Anne
N√©e le : 17/09/1981

Lyon, le 24/01/2026

Ordonnance :
Augmentin 1 g (comprim√©)
1 comprim√©
Voie orale
Dur√©e : 7 jours

Dr BLANC Nicolas
24/01/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : posologie incompl√®te (fr√©quence/horaire manquant).",
        "Cons√©quence : ‚Äúbonne dose‚Äù et ‚Äúbon moment‚Äù (5B) non s√©curisables.",
        conduireSiDoute
      ]
    },
    {
      id:"PM11",
      type:"mcq",
      points:1,
      title:"Prescription 11",
      prompt:`H√¥pital Tenon ‚Äî ORL

Patient : CHEVALIER Luc
N√© le : 03/12/1968

Paris, le 25/01/2026

Prescription :
Amoxicilline 500 mg ‚Äî g√©lule
1 g√©lule 3 fois par jour
Voie orale
Dur√©e : 7 jours

Dr MOREAU ‚Äî ORL
25/01/2026`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine prescripteur : signature absente.",
        "Cons√©quence : prescription non valid√©e / tra√ßabilit√© insuffisante.",
        conduireSiDoute
      ]
    },
    {
      id:"PM12",
      type:"mcq",
      points:1,
      title:"Prescription 12",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
PRESCRIPTION PERMANENTE
H√¥pital Piti√©-Salp√™tri√®re
Diab√©tologie ‚Äî Unit√© 3B
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patient : ANDRE Monique
N√©e le : 11/05/1955
Dossier : 88452

Paris, le 26/01/2026

Traitement chronique :
Insuline rapide (Novorapid) ‚Äî stylo
6 unit√©s en sous-cutan√© avant chaque repas
Selon protocole diab√®te √©tabli
Dur√©e : renouvelable

Dr LEROY Camille ‚Äî Diab√©tologie
26/01/2026 [signature + validation]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme (prescription permanente).",
        "Patient + support/service identifi√©s.",
        "M√©dicament/protocole : produit, dose, voie, moment (avant repas) + cadre protocolaire.",
        "Date + signature/validation pr√©sentes."
      ]
    },
    {
      id:"PM13",
      type:"mcq",
      points:1,
      title:"Prescription 13",
      prompt:`CHU de Nantes ‚Äî Chirurgie digestive

Patient : BAILLY Karim
N√© le : 19/10/1979

Nantes, le 28/01/2026

Prescription :
KCl 10% 20 mL (ampoule)
√Ä diluer dans 500 mL NaCl 0,9%
Voie IV

Dr PICARD Julie ‚Äî Chirurgie
28/01/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : modalit√©s d‚Äôadministration incompl√®tes (dur√©e/vitesse de perfusion manquante).",
        "Cons√©quence : risque iatrog√®ne (d√©bit inadapt√©).",
        conduireSiDoute
      ]
    },
    {
      id:"PM14",
      type:"mcq",
      points:1,
      title:"Prescription 14",
      prompt:`Maison de sant√© ‚Äî Dr BENALI Sarah
4 place du March√© ‚Äî 13006 Marseille

Patient : LOPEZ Diego
N√© le : 07/01/1999

Marseille, le 30/01/2026

Ordonnance :
Cr√®me hydrocortisone 1% (tube)
Appliquer une fine couche matin et soir
Voie cutan√©e
Dur√©e : 5 jours

Dr BENALI Sarah
30/01/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "M√©dicament : produit + concentration, posologie, voie, dur√©e.",
        "Patient + prescripteur + date + signature pr√©sents."
      ]
    },
    {
      id:"PM15",
      type:"mcq",
      points:1,
      title:"Prescription 15",
      prompt:`H√¥pital Saint-Louis ‚Äî Rhumatologie

Patient : DENIS Christophe
N√© le : 10/07/1983

Paris, le 06/02/2026

Traitement cortico√Øde :
Prednisone 20 mg (comprim√©)
2 comprim√©s le matin √† 8h
Dur√©e : 5 jours

Dr LAMBERT Isabelle ‚Äî Rhumatologie
06/02/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : voie d‚Äôadministration absente (m√™me si ‚Äúsouvent‚Äù orale, elle doit √™tre √©crite).",
        "Cons√©quence : r√®gle des 5B non validable.",
        conduireSiDoute
      ]
    },
    {
      id:"PM16",
      type:"mcq",
      points:1,
      title:"Prescription 16",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
H√¥pital Nord ‚Äî M√©decine
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patient : DURAND √âmilie
N√©e le : 14/04/1962
IPP : 5521901

Lille, le 01/02/2026

Prescription :
Enoxaparine 4000 UI (seringue)
1 injection en sous-cutan√© √† 20h
Dur√©e : 10 jours

Dr ROLLAND Nicolas ‚Äî M√©decine
01/02/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "Patient identifi√© (nom + date de naissance + IPP).",
        "M√©dicament complet (dose, voie SC, moment, dur√©e).",
        "Support/service + prescripteur + date + signature."
      ]
    },
    {
      id:"PM17",
      type:"mcq",
      points:1,
      title:"Prescription 17",
      prompt:`CHU de Rennes ‚Äî Infectiologie

Patient :  LEMAIRE
N√© le : 09/09/1988

Rennes, le 03/02/2026

Prescription :
Ceftriaxone 1 g (poudre)
1 injection par jour
Voie IV
Dur√©e : 3 jours

Dr HENAULT Marc ‚Äî Infectiologie
03/02/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine patient : identit√© incompl√®te (pr√©nom absent).",
        "Cons√©quence : risque d‚Äôerreur de patient / tra√ßabilit√© insuffisante.",
        conduireSiDoute
      ]
    },
    {
      id:"PM18",
      type:"mcq",
      points:1,
      title:"Prescription 18",
      prompt:`H√¥pital Cochin ‚Äî Oncologie

Patient : BOUVIER Claire
N√©e le : 02/12/1970

Paris, le 04/02/2026

Prescription :
Parac√©tamol 1 g IV
√Ä diluer dans 100 mL NaCl 0,9%
Perfusion sur 15 minutes
√Ä renouveler si besoin (max 3 g/24h)

Dr DUBOIS Alain ‚Äî Oncologie
04/02/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "M√©dicament + voie + dilution + dur√©e/vitesse : administration s√©curis√©e.",
        "Patient + prescripteur + date + signature pr√©sents."
      ]
    },
    {
      id:"PM19",
      type:"mcq",
      points:1,
      title:"Prescription 19",
      prompt:`‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Cabinet M√©dical Dr MULLER ‚Äî Cardiologie
8 rue des Lilas ‚Äî 67000 Strasbourg
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Patiente : BERTRAND Nathalie
N√©e le : 26/02/1969

Strasbourg, le 05/02/2026

Ordonnance :
Metoprolol 25 mg (comprim√©)
1 comprim√© le matin
Voie orale
Dur√©e : 1 mois

Dr MULLER Andreas ‚Äî Cardiologue
05/02/2026 [signature + tampon]`,
      options: yn(true),
      explain:[
        "‚úÖ Conforme.",
        "Prescripteur identifi√© (qualit√©) + date + signature.",
        "Patient identifi√©.",
        "M√©dicament complet (nom, dosage, forme, posologie, voie, dur√©e)."
      ]
    },
    {
      id:"PM20",
      type:"mcq",
      points:1,
      title:"Prescription 20",
      prompt:`CHU de Lille ‚Äî Neurologie

Patient : PERRIN Lucas
N√© le : 05/08/1995

Lille, le 05/02/2026

Prescription :
Diaz√©pam 10 mg (ampoule)
1 ampoule IV lente
Dur√©e : 1 dose

Dr HUGO Claire ‚Äî Neurologie
05/02/2026 [signature + tampon]`,
      options: yn(false),
      explain:[
        "‚ùå Non conforme.",
        "Domaine m√©dicament : modalit√©s d‚Äôadministration incompl√®tes (d√©bit/vitesse de l‚ÄôIV lente non pr√©cis√©s).",
        "Cons√©quence : risque d‚Äôeffets ind√©sirables par administration trop rapide.",
        conduireSiDoute
      ]
    },
  ];
}



const BANK = {
  partiel: makePartielQuestions(),
  qcm: makeQcmQuestions(),
  vf: makeVfQuestions(),
  mix: makeMixQuestions(),
  cas_vitaux: makeCasVitauxQuestions(),
  cas_pm: makeCasPMQuestions()
};

let currentTab = "partiel";
let state = {
  pmIndex: 0,
  answers: {},
  feedback: {},
  shuffled: { partiel:false, qcm:false, vf:false, mix:false, cas_vitaux:false, cas_pm:false },
  order: { partiel:[], qcm:[], vf:[], mix:[], cas_vitaux:[], cas_pm:[] }
};

function getQuestions(tab){
  const base = BANK[tab].slice();
  let doShuffle = document.getElementById("shuffle").checked;
  if(tab === "cas_pm") doShuffle = true; // ordonnances : une par une, ordre al√©atoire
  if(!state.order[tab].length || state.shuffled[tab] !== doShuffle){
    const ids = base.map(q=>q.id);
    let order = ids.slice();
    if(doShuffle) order.sort(()=>Math.random()-0.5);
    state.order[tab] = order;
    state.shuffled[tab] = doShuffle;
  }
  const map = new Map(base.map(q=>[q.id,q]));
  return state.order[tab].map(id=>map.get(id)).filter(Boolean);
}

function labelType(t){
  const map = {
    open:"R√©ponse r√©dig√©e",
    open_set:"Liste (ordre libre)",
    open_set_plus_def:"D√©finition + liste",
    open_two:"2 champs",
    open_multi:"D√©finitions (multi)",
    mcq:"QCM",
    tf_block:"Vrai/Faux",
    stage_sort:"Classement AVANT/PENDANT/APR√àS",
    calc:"Calculs"
  };
  return map[t] || t;
}

function safePlaceholder(ph, kind){
  if(!ph) return "";
  const s = String(ph).trim();
  // Retire les exemples ("Ex:") qui donnent souvent la r√©ponse
  if(/\bex\s*[:\n]/i.test(s) || /\bexemple\b/i.test(s) || s.toLowerCase().includes("ex:") || s.toLowerCase().startsWith("ex")){
    return (kind==="textarea") ? "√âcris ta r√©ponse ici‚Ä¶" : "R√©ponse‚Ä¶";
  }
  return ph;
}


/* =========================
   Ordonnances ‚Äî rendu ‚Äúpapier‚Äù + navigation (cas_pm)
========================= */
function hash32(str){
  // FNV-1a 32-bit
  let h = 2166136261;
  for(let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(seed){
  return function(){
    let t = (seed += 0x6D2B79F5) >>> 0;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function isBorderLine(l){
  const s = String(l||"").trim();
  if(!s) return true;
  if(/^[\u2550\u2500\u2501\u2502\u2551\u2014\u2013\-_=]{10,}$/.test(s)) return true;
  if(/^‚ïê{3,}$/.test(s) || /^‚Äî{3,}$/.test(s)) return true;
  return false;
}
function parseOrdonnanceText(txt){
  let s = String(txt||"").replace(/\r/g,"");
  let lines = s.split("\n").map(x=>x.replace(/\s+$/,"")).filter(x=>x.trim().length>0);
  lines = lines.filter(l=>!isBorderLine(l));
  const idxPatient = lines.findIndex(l=>/^patient\s*:/i.test(l.trim()));
  const idxPresc = lines.findIndex(l=>/^(prescription|ordonnance)\s*:/i.test(l.trim()));
  const idxDate = lines.findIndex(l=>/\ble\s*\d{2}\/\d{2}\/\d{4}\b/i.test(l));
  let idxDoc = -1;
  if(idxPresc >= 0){
    idxDoc = lines.findIndex((l,i)=> i>idxPresc && /^\s*(dr|docteur|pr)\b/i.test(l.trim()));
  }
  if(idxDoc < 0){
    idxDoc = lines.findIndex((l)=> /^\s*(dr|docteur|pr)\b/i.test(l.trim()));
  }

  const headerLines = (idxPatient>0 ? lines.slice(0, idxPatient) : lines.slice(0, 4)).slice(0, 5);

  const patientEnd = (idxDate>=0 ? idxDate : (idxPresc>=0 ? idxPresc : (idxPatient>=0 ? idxPatient+2 : 0)));
  const patientLines = (idxPatient>=0 ? lines.slice(idxPatient, patientEnd) : []);

  const locDate = (idxDate>=0 ? lines[idxDate] : "");

  const bodyStart = (idxPresc>=0 ? idxPresc+1 : (idxDate>=0 ? idxDate+1 : 0));
  const bodyEnd = (idxDoc>=0 ? idxDoc : lines.length);
  const bodyLines = lines.slice(bodyStart, bodyEnd);

  const footerLinesRaw = (idxDoc>=0 ? lines.slice(idxDoc) : []);
  const signature = /\bsignature\b/i.test(s);

  // Nettoyage du footer : retire les marqueurs [signature ...]
  const footerLines = footerLinesRaw
    .map(l => l.replace(/\[[^\]]*signature[^\]]*\]/ig, "").trim())
    .filter(Boolean);

  return { headerLines, patientLines, locDate, bodyLines, footerLines, signature };
}
function makeSignatureSvg(seedKey){
  const seed = hash32(String(seedKey||"sig"));
  const rnd = mulberry32(seed);
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, "svg");
  svg.setAttribute("viewBox", "0 0 210 64");

  const path = document.createElementNS(svgNS, "path");
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "rgba(0,0,0,0.78)");
  path.setAttribute("stroke-width", "2.3");
  path.setAttribute("stroke-linecap", "round");
  path.setAttribute("stroke-linejoin", "round");

  // G√©n√®re une ‚Äúsignature‚Äù en 2‚Äì3 traits
  const strokes = 2 + Math.floor(rnd()*2);
  let d = "";
  for(let s=0;s<strokes;s++){
    const x0 = 14 + rnd()*30;
    const y0 = 18 + rnd()*20;
    d += `M ${x0.toFixed(1)} ${y0.toFixed(1)} `;
    const segs = 10 + Math.floor(rnd()*10);
    let x = x0, y = y0;
    for(let i=0;i<segs;i++){
      x += 10 + rnd()*14;
      y += (rnd()-0.5)*14;
      x = Math.min(200, Math.max(8, x));
      y = Math.min(56, Math.max(8, y));
      const cx = x - (6 + rnd()*10);
      const cy = y + (rnd()-0.5)*10;
      d += `Q ${cx.toFixed(1)} ${cy.toFixed(1)} ${x.toFixed(1)} ${y.toFixed(1)} `;
    }
  }
  path.setAttribute("d", d.trim());
  svg.appendChild(path);
  return svg;
}
function renderOrdonnanceElement(txt, seedKey){
  const data = parseOrdonnanceText(txt);

  const paper = document.createElement("div");
  paper.className = "ordo-paper";

  const head = document.createElement("div");
  head.className = "ordo-head";

  const left = document.createElement("div");
  left.className = "left";

  // Premi√®re ligne tr√®s visible, le reste en ‚Äúsous-titre‚Äù
  if(data.headerLines.length){
    const first = document.createElement("div");
    first.textContent = data.headerLines[0];
    left.appendChild(first);
    for(let i=1;i<data.headerLines.length;i++){
      const sub = document.createElement("div");
      sub.className = "sub";
      sub.textContent = data.headerLines[i];
      left.appendChild(sub);
    }
  }

  const right = document.createElement("div");
  right.className = "right";
  right.textContent = data.locDate || "";

  head.appendChild(left);
  head.appendChild(right);
  paper.appendChild(head);

  const rule = document.createElement("div");
  rule.className = "ordo-rule";
  paper.appendChild(rule);

  // Patient
  if(data.patientLines && data.patientLines.length){
    const sec = document.createElement("div");
    sec.className = "ordo-section";
    const t = document.createElement("div");
    t.className = "ordo-title";
    t.textContent = "Patient";
    sec.appendChild(t);

    const lines = document.createElement("div");
    lines.className = "ordo-lines";
    for(const l of data.patientLines){
      const d = document.createElement("div");
      d.textContent = l;
      lines.appendChild(d);
    }
    sec.appendChild(lines);
    paper.appendChild(sec);
  }

  // Prescription
  const sec2 = document.createElement("div");
  sec2.className = "ordo-section";
  const t2 = document.createElement("div");
  t2.className = "ordo-title";
  t2.textContent = "Prescription";
  sec2.appendChild(t2);

  const lines2 = document.createElement("div");
  lines2.className = "ordo-lines";
  for(const l of (data.bodyLines||[])){
    const d = document.createElement("div");
    d.textContent = l;
    lines2.appendChild(d);
  }
  sec2.appendChild(lines2);
  paper.appendChild(sec2);

  // Footer (prescripteur + signature)
  if((data.footerLines && data.footerLines.length) || data.signature){
    const foot = document.createElement("div");
    foot.className = "ordo-footer";

    const doc = document.createElement("div");
    doc.className = "doc";

    let placedUnderName = false;
    const fl = (data.footerLines||[]);
    for(let i=0;i<fl.length;i++){
      const l = fl[i];
      const d = document.createElement("div");
      d.textContent = l;
      doc.appendChild(d);

      // Si signature : gribouillis sous le nom du praticien (1√®re ligne du footer)
      if(i===0 && data.signature){
        const ds = document.createElement("div");
        ds.className = "doc-sig";
        ds.appendChild(makeSignatureSvg((seedKey || "sig") + "_under"));
        doc.appendChild(ds);
        placedUnderName = true;
      }
    }

    // Si on a une signature mais pas de ligne prescripteur, on la laisse dans le bloc de droite
    foot.appendChild(doc);

    const sig = document.createElement("div");
    sig.className = "ordo-sig";
    if(data.signature && !placedUnderName){
      sig.appendChild(makeSignatureSvg(seedKey || "sig"));
      foot.appendChild(sig);
    }else if(!data.signature){
      // laisse un espace ‚Äúvide‚Äù sans √©crire "signature"
      const spacer = document.createElement("div");
      spacer.style.width = "210px";
      spacer.style.height = "64px";
      sig.appendChild(spacer);
      foot.appendChild(sig);
    }

    paper.appendChild(foot);
  }

  return paper;
}
function renderPromptElement(q){
  if(currentTab === "cas_pm"){
    return renderOrdonnanceElement(q.prompt, q.id);
  }
  const div = document.createElement("div");
  div.textContent = q.prompt;
  return div;
}
function casPmTotal(){
  return getQuestions("cas_pm").length;
}
function casPmCurrent(){
  const qs = getQuestions("cas_pm");
  if(!qs.length) return null;
  if(state.pmIndex < 0) state.pmIndex = 0;
  if(state.pmIndex >= qs.length) return null;
  return qs[state.pmIndex];
}
function goNextOrdonnance(){
  const total = casPmTotal();
  if(!total) return;
  state.pmIndex = Math.min(state.pmIndex + 1, total);
  window.scrollTo({top: 0, behavior: "smooth"});
  render();
}
function restartOrdonnances(){
  // reset deck + re-m√©lange
  state.order["cas_pm"] = [];
  state.pmIndex = 0;
  const qs = BANK["cas_pm"] || [];
  for(const q of qs){
    delete state.answers[q.id];
    delete state.feedback[q.id];
  }
  render();
}

function deriveMissingChecklist(q){
  // D√©duit une ‚Äúchecklist‚Äù de ce qui manque, √† partir des explications (cas non conformes)
  const exp = q.explain;
  const txt = Array.isArray(exp) ? exp.join(" ") : (exp || "");
  const t = stemish(txt);

  const items = [];
  const add = (id, label, keywords)=>{
    if(items.some(x=>x.id===id)) return;
    items.push({id, label, keywords});
  };

  // Patient / identit√©
  if(/prenom\s*(manqu|absent)|absence\s*de\s*prenom/.test(t)) add("prenom","Pr√©nom",["prenom","pr√©nom"]);
  if(/nom\s*(manqu|absent)|absence\s*de\s*nom/.test(t)) add("nom","Nom",["nom"]);
  if(/date\s*de\s*naissance|ddn|age\s*(manqu|absent)|absence\s*de\s*(ddn|date\s*de\s*naissance)|absence\s*d\s*age/.test(t)) add("ddn","√Çge / date de naissance",["age","√¢ge","date de naissance","ddn","naissance"]);
  if(/identif|ipp|nip/.test(t) && /manqu|absent/.test(t)) add("ipp","Identifiant (IPP/NIP)",["ipp","nip","identifiant"]);

  // Prescripteur
  if(/signature\s*(manqu|absent)|absence\s*de\s*signature/.test(t)) add("signature","Signature",["signature","signe","signer"]);
  if(/absence\s*de\s*date|date\s*(manqu|absent)/.test(t)) add("date","Date",["date"]);

  // M√©dicament / modalit√©s
  if(/voie\s*(manqu|absent)|absence\s*de\s*voie|voie\s*d\s*administration/.test(t)) add("voie","Voie d‚Äôadministration",["voie","administration"]);
  if(/posologie\s*(incomplet|manqu|absent)|frequence\s*(manqu|absent)|horaire\s*(manqu|absent)|moment\s*(manqu|absent)/.test(t)) add("posologie","Posologie / fr√©quence / horaire",["posologie","frequence","fr√©quence","horaire","fois","moment","matin","soir"]);
  if(/duree\s*(manqu|absent)|absence\s*de\s*duree|quantite\s*totale/.test(t)) add("duree","Dur√©e / quantit√© totale",["duree","dur√©e","jours","semaines","mois","quantite","quantit√©","boite","bo√Æte"]);
  if(/dosage\s*(manqu|absent)|dose\s*(manqu|absent)|concentration\s*(manqu|absent)/.test(t)) add("dosage","Dosage / dose / quantit√©",["dosage","dose","quantite","quantit√©","mg","g","ml","ui","%","concentration"]);
  if(/debit|vitesse|iv\s*lente|administration\s*incomplet/.test(t)) add("debit","D√©bit / vitesse",["debit","d√©bit","vitesse","ml/h","goutte","gtt","iv","lente"]);

  // Support / r√©glementation (large)
  if(/support\s*(non\s*identif|absent)|ordonnance\s*securisee|stup/.test(t)) add("support","Support / r√©glementation",["support","securisee","s√©curis√©e","ordonnance","stup","stup√©fiant"]);

  if(!items.length){
    add("manquant","√âl√©ments manquants",["manque","manquant","absent","incomplet"]);
  }
  return items;
}


function renderQuestionUI(q){
  const wrap = document.createElement("div");
  if(q.type === "open" || q.type === "open_set" || q.type === "open_set_plus_def"){
    const ta = document.createElement("textarea");
    ta.placeholder = safePlaceholder(q.placeholder, "textarea");
    ta.value = state.answers[q.id] || "";
    ta.oninput = ()=> { state.answers[q.id] = ta.value; };
    wrap.appendChild(ta);
  }
  else if(q.type === "open_two"){
    const box = document.createElement("div");
    box.className = "twoCol";
    const saved = state.answers[q.id] || {};
    for(const f of q.fields){
      const d = document.createElement("div");
      const lab = document.createElement("div");
      lab.className = "muted";
      lab.style.marginBottom = "6px";
      lab.textContent = f.label;
      const inp = document.createElement("input");
      inp.type = "text";
      inp.placeholder = safePlaceholder(f.placeholder, "input");
      inp.value = saved[f.key] || "";
      inp.oninput = ()=>{
        const cur = state.answers[q.id] || {};
        cur[f.key] = inp.value;
        state.answers[q.id] = cur;
      };
      d.appendChild(lab);
      d.appendChild(inp);
      box.appendChild(d);
    }
    wrap.appendChild(box);
  }
  else if(q.type === "open_multi"){
    const box = document.createElement("div");
    box.className = "twoCol";
    const saved = state.answers[q.id] || {};
    for(const f of q.fields){
      const d = document.createElement("div");
      const lab = document.createElement("div");
      lab.className = "muted";
      lab.style.marginBottom = "6px";
      lab.textContent = f.label;
      const ta = document.createElement("textarea");
      ta.style.minHeight = "84px";
      ta.placeholder = safePlaceholder(f.placeholder, "textarea");
      ta.value = saved[f.key] || "";
      ta.oninput = ()=>{
        const cur = state.answers[q.id] || {};
        cur[f.key] = ta.value;
        state.answers[q.id] = cur;
      };
      d.appendChild(lab);
      d.appendChild(ta);
      box.appendChild(d);
    }
    wrap.appendChild(box);
  }
  else if(q.type === "mcq"){
    const savedRaw = state.answers[q.id] || (q.multi ? [] : "");
    let saved = savedRaw;
    let missingText = "";

    // Ordonnances (cas_pm) : sauvegarde enrichie {choice, missingText}
    if(currentTab === "cas_pm" && !q.multi){
      if(savedRaw && typeof savedRaw === "object"){
        saved = savedRaw.choice || "";
        missingText = savedRaw.missingText || "";
      }else{
        saved = savedRaw || "";
      }
    }

    const choices = document.createElement("div");
    choices.className = "choices";

    for(const opt of q.options){
      const lab = document.createElement("label");
      lab.className = "choice";
      const input = document.createElement("input");
      input.type = q.multi ? "checkbox" : "radio";
      input.name = q.id;

      if(q.multi){
        input.checked = saved.includes(opt.id);
        input.onchange = ()=>{
          let cur = state.answers[q.id] || [];
          if(input.checked) cur = unique(cur.concat([opt.id]));
          else cur = cur.filter(x=>x!==opt.id);
          state.answers[q.id] = cur;
        };
      }else{
        input.checked = (saved === opt.id);
        input.onchange = ()=>{
          if(currentTab === "cas_pm"){
            const cur = state.answers[q.id];
            const keep = (cur && typeof cur === "object") ? (cur.missingText || "") : "";
            state.answers[q.id] = {choice: opt.id, missingText: keep};
          }else{
            state.answers[q.id] = opt.id;
          }
          render(); // pour afficher/masquer l'encart dynamiquement
        };
      }

      const span = document.createElement("div");
      span.innerHTML = `<div>${opt.text}</div>`;
      lab.appendChild(input);
      lab.appendChild(span);
      choices.appendChild(lab);
    }

    wrap.appendChild(choices);

    // Encart "ce qu'il manque" (uniquement ordonnances + si Non conforme choisi)
    if(currentTab === "cas_pm" && !q.multi){
      const choice = (savedRaw && typeof savedRaw === "object") ? (savedRaw.choice || "") : (saved || "");
      const mt = (savedRaw && typeof savedRaw === "object") ? (savedRaw.missingText || "") : "";

      if(choice === "no"){
        const box = document.createElement("div");
        box.className = "feedback warn";
        box.style.marginTop = "12px";
        box.innerHTML = `<div class="title">Ce qu'il manque (mots-cl√©s suffisants)</div>
          <div class="help" style="margin:6px 0 10px 0; font-style: normal;">
            Tu peux tout √©crire √† la suite (ex : nom, etc.). Accents/ponctuation/ordre : on s'en fiche.
          </div>`;
        const ta = document.createElement("textarea");
        ta.placeholder = "Ex : nom, etc.";
        ta.value = mt;
        ta.oninput = ()=>{
          const cur = state.answers[q.id];
          const base = (cur && typeof cur === "object") ? cur : {choice:"no", missingText:""};
          base.missingText = ta.value;
          state.answers[q.id] = base;
        };
        box.appendChild(ta);
        wrap.appendChild(box);
      }
    }
  }
  else if(q.type === "tf_block"){
    const saved = state.answers[q.id] || {};
    const tbl = document.createElement("div");
    tbl.className = "tableLike";
    for(const st of q.statements){
      const row = document.createElement("div");
      row.className = "trow";
      const left = document.createElement("div");
      left.className = "tcell";
      left.textContent = st.text;
      const right = document.createElement("div");
      right.className = "tcell right";
      const sel = document.createElement("select");
      sel.className = "select";
      sel.innerHTML = `
        <option value="">‚Äî</option>
        <option value="true">Vrai</option>
        <option value="false">Faux</option>
      `;
      sel.value = saved[st.id] ?? "";
      sel.onchange = ()=>{
        const cur = state.answers[q.id] || {};
        cur[st.id] = sel.value;
        state.answers[q.id] = cur;
      };
      right.appendChild(sel);
      row.appendChild(left);
      row.appendChild(right);
      tbl.appendChild(row);
    }
    wrap.appendChild(tbl);
  }
  else if(q.type === "stage_sort"){
    const saved = state.answers[q.id] || {};
    const tbl = document.createElement("div");
    tbl.className = "tableLike";
    for(const it of q.items){
      const row = document.createElement("div");
      row.className = "trow";
      const left = document.createElement("div");
      left.className = "tcell";
      left.textContent = it.text;
      const right = document.createElement("div");
      right.className = "tcell right";
      const sel = document.createElement("select");
      sel.className = "select";
      sel.innerHTML = `
        <option value="">‚Äî</option>
        <option value="avant">AVANT</option>
        <option value="pendant">PENDANT</option>
        <option value="apres">APR√àS</option>
      `;
      sel.value = saved[it.id] ?? "";
      sel.onchange = ()=>{
        const cur = state.answers[q.id] || {};
        cur[it.id] = sel.value;
        state.answers[q.id] = cur;
      };
      right.appendChild(sel);
      row.appendChild(left);
      row.appendChild(right);
      tbl.appendChild(row);
    }
    wrap.appendChild(tbl);
  }
  else if(q.type === "calc"){
    const saved = state.answers[q.id] || {};
    const box = document.createElement("div");
    box.className = "twoCol";
    for(const f of q.fields){
      const d = document.createElement("div");
      const lab = document.createElement("div");
      lab.className = "muted";
      lab.style.marginBottom = "6px";
      lab.textContent = f.label;
      const inp = document.createElement("input");
      inp.type = "number";
      inp.step = "any";
      inp.value = (saved[f.key] ?? "");
      inp.oninput = ()=>{
        const cur = state.answers[q.id] || {};
        cur[f.key] = inp.value;
        state.answers[q.id] = cur;
      };
      d.appendChild(lab);
      d.appendChild(inp);
      box.appendChild(d);
    }
    wrap.appendChild(box);
    const note = document.createElement("div");
    note.className = "help";
    note.textContent = "Tol√©rances actives (arrondis accept√©s).";
    wrap.appendChild(note);
  }
  return wrap;
}

function renderFeedbackBlock(res, q, hideHelp){
  const box = document.createElement("div");
  box.className = "feedback " + (res.level==="ok"?"ok":(res.level==="warn"?"warn":"bad"));
  const title = document.createElement("div");
  title.className = "title";
  const s = Math.round(res.score*100)/100;
  title.textContent = `${res.level==="ok"?"‚úÖ OK":(res.level==="warn"?"‚ö†Ô∏è Partiel":"‚ùå √Ä revoir")} ‚Äî Score: ${s}/${q.points}`;
  box.appendChild(title);

  const ul = document.createElement("ul");
  for(const d of (res.details || [])){
    const li = document.createElement("li");
    li.textContent = d;
    ul.appendChild(li);
  }
  box.appendChild(ul);

  if(!hideHelp && res.expectedHint && res.expectedHint.length){
    const hr = document.createElement("div");
    hr.className = "hr";
    box.appendChild(hr);
    const hint = document.createElement("div");
    hint.className = "muted";
    hint.innerHTML = `<b>Rappels attendus (indicatifs)</b>`;
    box.appendChild(hint);

    const ul2 = document.createElement("ul");
    for(const h of res.expectedHint){
      if(!h) continue;
      const li = document.createElement("li");
      li.textContent = h;
      ul2.appendChild(li);
    }
    box.appendChild(ul2);
  }
  return box;
}

function updateBadge(qid, res){
  const b = document.getElementById(`badge_${qid}`);
  if(!b) return;
  b.className = "badge " + (res.level==="ok"?"ok":(res.level==="warn"?"warn":"bad"));
  b.textContent = res.level==="ok" ? "‚úÖ OK" : (res.level==="warn" ? "‚ö†Ô∏è Partiel" : "‚ùå √Ä revoir");
}

function grade(q, ans){
  if(q.type === "open" || q.type === "open_set" || q.type === "open_set_plus_def"){
    return q.check(ans || "", q);
  }
  if(q.type === "open_two" || q.type === "open_multi" || q.type === "tf_block" || q.type==="stage_sort" || q.type==="calc"){
    return q.check(ans || {}, q);
  }
  if(q.type === "mcq"){
    // Ordonnances (cas_pm) : ans peut √™tre {choice, missingText}
    let selected = ans || (q.multi ? [] : "");
    let missingText = "";
    if(currentTab === "cas_pm" && !q.multi){
      if(ans && typeof ans === "object"){
        selected = ans.choice || "";
        missingText = ans.missingText || "";
      }else{
        selected = ans || "";
      }
    }

    const correctIds = q.options.filter(o=>o.correct).map(o=>o.id);
    let ok=false, level="bad", score=0, details=[];

    if(q.multi){
      const selSet = new Set(selected);
      const pickedCorrect = correctIds.filter(id=>selSet.has(id)).length;
      const pickedIncorrect = q.options.filter(o=>!o.correct && selSet.has(o.id)).length;
      const missed = correctIds.filter(id=>!selSet.has(id)).length;
      ok = (pickedCorrect===correctIds.length && pickedIncorrect===0 && missed===0);
      let raw = pickedCorrect - pickedIncorrect;
      raw = Math.max(0, raw);
      score = (raw / correctIds.length) * q.points;
      level = ok ? "ok" : (score >= q.points*0.7 ? "warn" : "bad");
      details.push(`Corrects s√©lectionn√©s : ${pickedCorrect}/${correctIds.length}.`);
      if(pickedIncorrect>0) details.push(`Choix incorrects : ${pickedIncorrect} (retire-les).`);
      if(missed>0) details.push(`Manquants : ${missed} (ajoute-les).`);
    }else{
      const sel = selected;
      const choiceOk = correctIds.includes(sel);

      // Bonus "ce qu'il manque" uniquement si la bonne r√©ponse est Non conforme (cas_pm)
      const expectedNonConforme = (correctIds.length===1 && correctIds[0]==="no");
      if(currentTab === "cas_pm" && expectedNonConforme){
        const items = deriveMissingChecklist(q);
        const s = scoreSetAnswer(missingText || "", items, items.length);
        const missingOk = s.ok;

        const half = q.points/2;
        score = (choiceOk ? half : 0) + (missingOk ? half : 0);
        ok = choiceOk && missingOk;
        level = ok ? "ok" : (score>0 ? "warn" : "bad");

        if(!sel){
          details.push("Choisis d‚Äôabord Conforme ou Non conforme.");
        }else{
          details.push(choiceOk ? "Bonne r√©ponse (non conforme)." : "Mauvaise r√©ponse.");
        }

        if(!missingText || !missingText.trim()){
          details.push("Ajoute ce qu‚Äôil manque (mots-cl√©s).");
        }else if(missingOk){
          details.push("√âl√©ments manquants : OK.");
        }else{
          const missing = items.filter(it => !s.foundIds.includes(it.id)).map(it=>it.label);
          details.push("Il manque encore : " + (missing.length ? missing.join(", ") : "des mots-cl√©s attendus") + ".");
        }
      }else{
        ok = choiceOk;
        score = ok ? q.points : 0;
        level = ok ? "ok" : "bad";
        details.push(ok ? "Bonne r√©ponse." : "Mauvaise r√©ponse.");
      }
    }

    const exp = q.explain;
    const expectedHint = Array.isArray(exp) ? exp : (exp ? [exp] : []);
    return { ok, level, score, details, expectedHint };
  }
  return { ok:false, level:"bad", score:0, details:["Type inconnu."], expectedHint:[] };
}

function renderKpis(){
  const host = document.getElementById("kpis");
  const qs = getQuestions(currentTab);
  let totalPts = 0;
  let gotPts = 0;
  let done = 0;
  let ok = 0;
  for(const q of qs){
    totalPts += q.points;
    const fb = state.feedback[q.id];
    if(fb){
      done++;
      gotPts += fb.score || 0;
      if(fb.level==="ok") ok++;
    }
  }
  const pct = totalPts ? Math.round((gotPts/totalPts)*100) : 0;
  host.innerHTML = "";
  host.appendChild(kpiBox("Questions corrig√©es", `${done}/${qs.length}`, "Corrige pour voir le score."));
  host.appendChild(kpiBox("Points", `${roundNice(gotPts)}/${roundNice(totalPts)}`, `‚âà ${pct}%`));
  host.appendChild(kpiBox("OK", `${ok}/${qs.length}`, "Le ‚Äúpartiel‚Äù vise 100% OK."));
}
function kpiBox(label, big, small){
  const d = document.createElement("div");
  d.className = "box";
  d.innerHTML = `<div class="small">${label}</div><div class="big">${big}</div><div class="small">${small}</div>`;
  return d;
}

function render(){
  // Ajuste la barre d‚Äôactions selon l‚Äôonglet
  const btnAll = document.getElementById("checkAll");
  const btnReset = document.getElementById("resetTab");
  if(currentTab === "cas_pm"){
    btnAll.textContent = "Corriger l‚Äôordonnance";
    btnReset.textContent = "Recommencer les ordonnances";
  }else{
    btnAll.textContent = "Corriger l‚Äôonglet";
    btnReset.textContent = "R√©essayer l‚Äôonglet";
  }

  renderKpis();
  const hideHelp = document.getElementById("hideHelp").checked;
  const content = document.getElementById("content");
  content.innerHTML = "";

  const qs = getQuestions(currentTab);

  // Cas particulier : ordonnances une par une
  if(currentTab === "cas_pm"){
    const total = qs.length;

    // Fin du paquet
    if(state.pmIndex >= total){
      const card = document.createElement("div");
      card.className = "card";

      const head = document.createElement("h2");
      head.innerHTML = `Ordonnances ‚Äî termin√© <span class="badge">${total} / ${total}</span>`;
      card.appendChild(head);

      const qtext = document.createElement("div");
      qtext.className = "qtext";
      qtext.innerHTML = "";
      const p = document.createElement("div");
      p.className = "help";
      p.style.marginTop = "6px";
      p.textContent = "Tu as vu toutes les ordonnances de cette s√©rie.";
      qtext.appendChild(p);
      card.appendChild(qtext);

      const actions = document.createElement("div");
      actions.className = "inline";
      actions.style.marginTop = "10px";

      const btnRestart = document.createElement("button");
      btnRestart.textContent = "Recommencer (ordre al√©atoire)";
      btnRestart.onclick = restartOrdonnances;

      actions.appendChild(btnRestart);
      card.appendChild(actions);

      content.appendChild(card);
      return;
    }

    const q = qs[state.pmIndex];

    const card = document.createElement("div");
    card.className = "card";
    card.dataset.qid = q.id;

    const head = document.createElement("h2");
    const progress = `${state.pmIndex+1}/${total}`;
    head.innerHTML = `${q.title} <span class="badge">${q.points} pt${q.points>1?"s":""}</span> <span class="badge mono">${progress}</span> <span id="badge_${q.id}" class="badge muted">Non corrig√©</span>`;
    card.appendChild(head);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span class="badge">${labelType(q.type)}</span><span class="badge mono">${q.id}</span>`;
    card.appendChild(meta);

    const qtext = document.createElement("div");
    qtext.className = "qtext";
    qtext.innerHTML = "";
    qtext.appendChild(renderPromptElement(q));
    card.appendChild(qtext);

    card.appendChild(renderQuestionUI(q));

    const actions = document.createElement("div");
    actions.className = "inline";
    actions.style.marginTop = "10px";

    const btnCheck = document.createElement("button");
    btnCheck.textContent = "Corriger";
    btnCheck.onclick = ()=> checkOne(q.id);

    const btnResetOne = document.createElement("button");
    btnResetOne.textContent = "R√©essayer";
    btnResetOne.onclick = ()=> resetOne(q.id);

    actions.appendChild(btnCheck);
    actions.appendChild(btnResetOne);

    // Bouton ‚ÄúOrdonnance suivante‚Äù seulement apr√®s correction
    if(state.feedback[q.id]){
      const btnNext = document.createElement("button");
      btnNext.textContent = (state.pmIndex+1>=total) ? "Terminer la s√©rie" : "Ordonnance suivante";
      btnNext.onclick = goNextOrdonnance;
      actions.appendChild(btnNext);
    }

    const hint = document.createElement("div");
    hint.className = "help";
    hint.id = `help_${q.id}`;
    hint.textContent = hideHelp ? "" : (q.extraExplain || "");
    actions.appendChild(hint);

    card.appendChild(actions);

    const fb = document.createElement("div");
    fb.id = `fb_${q.id}`;
    const savedFb = state.feedback[q.id];
    if(savedFb){
      fb.appendChild(renderFeedbackBlock(savedFb, q, hideHelp));
      updateBadge(q.id, savedFb);
    }
    card.appendChild(fb);

    content.appendChild(card);
    return;
  }

  // Rendu normal : toutes les questions
  for(const q of qs){
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.qid = q.id;

    const head = document.createElement("h2");
    head.innerHTML = `${q.title} <span class="badge">${q.points} pt${q.points>1?"s":""}</span> <span id="badge_${q.id}" class="badge muted">Non corrig√©</span>`;
    card.appendChild(head);

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.innerHTML = `<span class="badge">${labelType(q.type)}</span><span class="badge mono">${q.id}</span>`;
    card.appendChild(meta);

    const qtext = document.createElement("div");
    qtext.className = "qtext";
    qtext.innerHTML = "";
    qtext.appendChild(renderPromptElement(q));
    card.appendChild(qtext);

    card.appendChild(renderQuestionUI(q));

    const actions = document.createElement("div");
    actions.className = "inline";
    actions.style.marginTop = "10px";
    const btnCheck = document.createElement("button");
    btnCheck.textContent = "Corriger";
    btnCheck.onclick = ()=> checkOne(q.id);
    const btnReset = document.createElement("button");
    btnReset.textContent = "R√©essayer";
    btnReset.onclick = ()=> resetOne(q.id);
    actions.appendChild(btnCheck);
    actions.appendChild(btnReset);

    const hint = document.createElement("div");
    hint.className = "help";
    hint.id = `help_${q.id}`;
    hint.textContent = hideHelp ? "" : (q.extraExplain || "");
    actions.appendChild(hint);

    card.appendChild(actions);

    const fb = document.createElement("div");
    fb.id = `fb_${q.id}`;
    const savedFb = state.feedback[q.id];
    if(savedFb){
      fb.appendChild(renderFeedbackBlock(savedFb, q, hideHelp));
      updateBadge(q.id, savedFb);
    }
    card.appendChild(fb);

    content.appendChild(card);
  }
}

function checkOne(qid){
  const q = BANK[currentTab].find(x=>x.id===qid);
  if(!q) return;
  const ans = state.answers[qid];
  const res = grade(q, ans);
  state.feedback[qid] = res;

  // Sur l‚Äôonglet ordonnances, on rerend tout pour afficher le bouton ‚ÄúOrdonnance suivante‚Äù
  if(currentTab === "cas_pm"){
    render();
    return;
  }

  updateBadge(qid, res);
  const fbHost = document.getElementById(`fb_${qid}`);
  fbHost.innerHTML = "";
  fbHost.appendChild(renderFeedbackBlock(res, q, document.getElementById("hideHelp").checked));
  renderKpis();
}
function checkAll(){
  const qs = getQuestions(currentTab);
  if(currentTab === "cas_pm"){
    const cur = casPmCurrent();
    if(cur) checkOne(cur.id);
    return;
  }
  for(const q of qs) checkOne(q.id);
}
function resetOne(qid){
  delete state.answers[qid];
  delete state.feedback[qid];
  render();
}
function resetTab(){
  if(currentTab === "cas_pm"){
    restartOrdonnances();
    return;
  }
  const qs = getQuestions(currentTab);
  for(const q of qs){
    delete state.answers[q.id];
    delete state.feedback[q.id];
  }
  render();
}

/* Tabs & events */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentTab = btn.dataset.tab;
    if(currentTab === "cas_pm" && !state.order["cas_pm"].length){
      state.pmIndex = 0;
    }
    render();
  });
});
document.getElementById("checkAll").addEventListener("click", checkAll);
document.getElementById("resetTab").addEventListener("click", resetTab);
document.getElementById("shuffle").addEventListener("change", ()=> render());
document.getElementById("hideHelp").addEventListener("change", ()=> render());

render();
</script>
</body>
</html>
